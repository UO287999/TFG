---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r include=FALSE, warning=FALSE}
library(readr)
library(readxl)
library(janitor)
library(mice)
library(visdat)
library(outliers)
library(plotly)
library(tidyverse)
library(webshot2)
library(lmtest)      # Para bptest() y dwtest()
library(tseries)     # Para jarque.bera.test()
library(ggfortify)   # Para autoplot() del modelo
library(patchwork)
```


# Análisis exploratorio de la base de datos

```{r message=FALSE, warning=FALSE, include=FALSE}
library(ggplot2)
knitr::opts_chunk$set(
  fig.width = 6, 
  fig.height = 4, 
  dev = "png",
  fig.align = "center"
)
theme_set(theme_minimal(base_size = 12))
```

Como se ha señalado en la introducción, el trabajo se centra en el desarrollo práctico de un ejemplo de análisis de datos longitudinales, con el fin de aplicar las técnicas estadísticas descritas en los capítulos anteriores. En este capítulo, en concreto, se presenta la base de datos principal utilizada, junto con las fuentes complementarias, y se lleva a cabo un análisis exploratorio en profundidad. Este análisis inicial resulta clave para comprender la estructura de los datos, identificar posibles patrones, detectar valores atípicos o faltantes, y orientar las decisiones de modelización que se abordarán en los capítulos siguientes.

## Análisis exploratorio inicial

El conjunto de datos World Happiness (2015-2024) recopila información sobre la felicidad percibida en diferentes países a lo largo de los años. Esta base de datos proviene de los informes anuales de felicidad publicados por la Red de Soluciones para el Desarrollo Sostenible de la ONU, los cuales se basan en encuestas realizadas a los ciudadanos nivel mundial. La base tiene una buena cobertura temporal, ya que abarca datos de 2015 a 2024 y permite analizar tendencias a lo largo del tiempo, pero también tiene una buena cobertura geográfica porque incluye información de diferentes países y regiones del mundo. Es ampliamente utilizada en estudios de bienestar y calidad de vida, y contiene métricas económicas y sociales que permiten un análisis estadístico y comparativo. Cada fila representa un país en un año determinado y contiene variables socioeconómicas y de bienestar que pueden influir en la percepción de felicidad de su población. Estas variables son:

-   `Country`: nombre del país.

-   `Region`: continente o agrupación geográfica del país.

-   `Happiness Score`: puntuación de felicidad promedio en el país.

-   `GDP per capita`: Producto Interno Bruto (PIB) per cápita. Mide la riqueza económica del país.

-   `Social Support`: medida de apoyo social basada en la percepción de las personas sobre la ayuda que pueden recibir de familiares y amigos.

-   `Healthy Life Expectancy`: esperanza de vida saludable en años.

-   `Freedom to Make Life Choices`: libertad para tomar decisiones personales.

-   `Generosity`: nivel de generosidad en la sociedad, basado en donaciones y ayuda a otros.

-   `Perceptions of Corruption`: nivel de percepción de corrupción en el gobierno y los negocios. 

```{r warning=FALSE, include=FALSE}
# Carga de paquetes 
library(readr)
library(readxl)
library(janitor)
library(mice)
library(visdat)
library(outliers)
library(plotly)
library(tidyverse)
library(webshot2)

# Cargamos los datos 
df_original <- read_delim("world_happiness_combined.csv", delim = ";", show_col_types = FALSE)
# Limpiar nombres de columnas
df_original <- clean_names(df_original)
summary(df_original)
str(df_original)
# Hay algunas variables numérias que están puestas como categóricas
df_original <- df_original %>%
  mutate(
    gdp_per_capita = as.numeric(gsub(",", ".", gdp_per_capita)),
    social_support = as.numeric(gsub(",", ".", social_support)),
    freedom_to_make_life_choices = as.numeric(gsub(",", ".", freedom_to_make_life_choices)),
    generosity = as.numeric(gsub(",", ".", generosity)),
    perceptions_of_corruption = as.numeric(gsub(",", ".", perceptions_of_corruption))
  )
# Verificar que ahora sean numéricas
str(df_original)
# Hay un problema con las comas en el happiness score
df_original$happiness_score <- df_original$happiness_score / 100000
# Datos faltantes
is.na(df_original)
# En la base de datos no hay ningún dato faltante

# Detección de Outliers
boxplot(df_original$happiness_score)
boxplot(df_original$gdp_per_capita)
boxplot(df_original$social_support)  
boxplot(df_original$healthy_life_expectancy)
boxplot(df_original$freedom_to_make_life_choices)
boxplot(df_original$generosity)
boxplot(df_original$perceptions_of_corruption)
# Como podemos apreciar gráficamente, hay algunas variables numéricas en las que puede haber valores atípicos
outliers::grubbs.test(df_original$happiness_score)
outliers::grubbs.test(df_original$gdp_per_capita)
outliers::grubbs.test(df_original$social_support)
outliers::grubbs.test(df_original$healthy_life_expectancy)
outliers::grubbs.test(df_original$freedom_to_make_life_choices)
outliers::grubbs.test(df_original$generosity)
outliers::grubbs.test(df_original$perceptions_of_corruption)
# Como el p-valor es > alpha en todos los test, no tenemos outliers
df_original <- df_original %>%
  rename(
    gdp = gdp_per_capita,
    support = social_support,
    life_exp = healthy_life_expectancy,
    freedom = freedom_to_make_life_choices,
    generosity = generosity,
    corruption = perceptions_of_corruption
  )
```

```{r}
#| label: fig-variables-happiness
#| echo: false
#| warning: false
#| fig-cap: "Distribución de las variables con rango entre 0 y 1 de la base de datos World Happiness."
#| fig-width: 5
#| fig-height: 2.6
library(ggplot2)
library(dplyr)
library(tidyr)
library(patchwork)

# Reestructurar para ggplot
df_box <- df_original %>%
  select(happiness_score, gdp, support, life_exp, freedom, generosity, corruption)

df_box_long <- df_box %>%
  pivot_longer(cols = everything(), names_to = "variable", values_to = "valor")

# Subconjuntos
df_box_gdp_happy <- df_box_long %>% filter(variable %in% c("gdp", "happiness_score"))
df_box_lifeexp <- df_box_long %>% filter(variable == "life_exp")
df_box_01 <- df_box_long %>% filter(variable %in% c("support", "freedom", "generosity", "corruption"))

# Gráfico 1
ggplot(df_box_01, aes(x = variable, y = valor, fill = variable)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Variables con valores entre 0 y 1",
       x = "Variable", y = "Valor") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

```

```{r}
#| label: fig-variables-happiness2
#| echo: false
#| warning: false
#| fig-cap: "Distribución de las variables de la base de datos World Happiness."
#| fig-width: 5
#| fig-height: 2.6
library(ggplot2)
library(dplyr)
library(tidyr)
library(patchwork)

# Gráfico 2: life_exp
g2 <- ggplot(df_box_lifeexp, aes(x = variable, y = valor, fill = variable)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Esperanza de vida",
       x = "Variable", y = "Valor") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

# Gráfico 3: gdp y happiness_score
g3 <- ggplot(df_box_gdp_happy, aes(x = variable, y = valor, fill = variable)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "GDP y Happiness Score",
       x = "Variable", y = "Valor") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

# Mostrar gráfico 2 y 3 en la misma fila
(g2 + g3) + 
  plot_layout(ncol = 2) + 
  plot_annotation(title = NULL)

```

Tanto la @fig-variables-happiness como @fig-variables-happiness2 nos muestran la distribución de las diferentes variables, en las que se aprecia que no hay valores atípicos. Explorando opciones para enriquecer la base de datos y, de esta manera, construir un modelo más informativo, se han estudiado diversas alternativas y se ha decidido integrar información de dos fuentes externas que aportan indicadores políticos y de libertades civiles en los países. Estas bases de datos nos permitirán explorar hasta qué punto la calidad de vida, la democracia, los derechos políticos y las libertades influyen en la percepción de felicidad de los ciudadanos.

La primera base de datos que hemos considerado es "Freedom in the World" [@freedomhouse], un informe anual de la organización Freedom House, que evalúa el estado de los derechos políticos y libertades civiles a nivel global. Se clasifica cada país en función de indicadores de democracia, participación política y derechos individuales. El motivo por el que hemos elegido esta base de datos es porque los estudios en ciencias sociales han mostrado que la percepción de felicidad no solo está ligada a factores económicos, sino también a la capacidad de los ciudadanos para expresarse libremente, participar en política y vivir sin restricciones autoritarias. Por ejemplo, [@Inglehart2008] señalan que la libre elección está positivamente correlacionada con mayores niveles de felicidad. De manera similar, [@Helliwell2023] destacan que el apoyo institucional y la libertad individual son factores clave del Happiness Score en el World Happiness Report. Incorporar estos datos nos permitirá ver si existe dicha correlación entre los niveles de libertad y la felicidad percibida en cada país. Como esta base de datos cuenta con una gran cantidad de variables, hemos elegido las siguientes variables de interés:

-   `Country/Territory`: identificación del país o territorio.
-   `Region`: indica la zona geográfica del país.
-   `c/T`: diferencia entre países y territorios, aunque este concepto puede ser delicado según el análisis.
-   `Edition`: año del reporte, fundamental para el análisis longitudinal.
-   `Status`: clasificación del país en cuanto a su libertad: Libre (F), Parcialmente Libre (PF) o No Libre (NF).
-   `PR rating (Political Rights)`: puntuación de 1 a 7 sobre derechos políticos.
-   `CL rating (Civil Liberties)`: puntuación de 1 a 7 sobre libertades civiles.

La otra base de datos que hemos elegido para nuestro análisis es "Democracy Data", una base de datos que proviene del proyecto TidyTuesday [@tidytuesday2024] y está basado en estudios académicos sobre democracia y regímenes políticos. Esta base de datos clasifica a los países según su sistema de gobierno y proporciona información detallada sobre su historia política. Una de las características que tiene esta base de datos es que incluye información hasta 2020, por lo que tenemos que considerar que, si vamos a trabajar con ella, tendremos las características completas de las observaciones; pero en un período reducido de tiempo. Dado que la felicidad no solo depende de factores económicos, sino también de la estabilidad política y la forma de gobierno de un país, estas variables pueden ayudarnos a explicar por qué algunos países presentan niveles bajos de felicidad a pesar de tener una economía sólida. Al igual que en el caso anterior, como esta base de datos contiene más de 40 variables, hemos decidido quedarnos con aquellas que consideramos que mejor se adaptan a nuestro análisis. Estas variables son:

-   `country_name`: nombre del país.
-   `year`: año de observación.
-   `regime_category`: clasificación del sistema de gobierno (democracia parlamentaria, autocracia civil, dictadura militar, monarquía, etc.).
-   `is_monarchy`: indica si el país es una monarquía.
-   `is_democracy`: indica si el país es una democracia.
-   `is_presidential`: indica si el sistema es presidencialista.
-   `is_colony`: identifica si el país sigue siendo una colonia.
-   `is_communist`: indica si el país sigue un régimen comunista.
-   `spatial_democracy`: evalúa el nivel de democracia en los países vecinos.
-   `has_full_suffrage`: indica si hay sufragio universal.
-   `electoral_category`: tipo de elecciones (no democráticas, de partido único, multipartidistas no democráticas o democráticas).
-   `spatial_electoral`: evalúa la calidad electoral de los países vecinos.
-   `has_free_and_fair_election`: indica si las elecciones en el país son libres y justas.
-   `has_alternation`: indica si existe alternancia en el poder.

Agregando estas bases de datos consideramos que podemos abarcar de forma bastante completa los diferentes factores que afectan a la percepción de la felicidad, lo que nos permitirá realizar un análisis más profundo y sacar conclusiones sobre la relación entre política, democracia y bienestar en distintos países. Para combinar adecuadamente estas fuentes, las variables clave utilizadas para relacionarlas fueron el país o región y el año, asegurando la coherencia temporal y geográfica en el análisis.

```{r include=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(stringr)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(htmlwidgets)
## FREEDOM IN THE WORLD
freedom_todos <- read_excel("All_data_FIW_2013-2024 (1).xlsx", sheet = "FIW13-25", skip = 1)
### Las variables que nos pueden llegar a interesar son:
#### Country/Territory (necesitamos el país/territorio)
#### Region (aunque sea muy parecida a la de regional_indicator, nos puede ser de utilidad)
#### c/T (indica si es país o territorio, aunque no se si deberíamos de meternos con el concepto de soberanía)
#### Edition (necesitamos el año)
#### Status (clasifica la libertad del país)
#### PR (derechos políticos) rating y CL (libertades civiles) rating (la otra opción sería elegir PR, CL y Total porque el rating va de 1 a 7)
freedom_final <- freedom_todos %>%
  select(
    `Country/Territory`, # Nombre del país o territorio
    `Region`,            # Región geográfica
    `C/T`,               # Indica si es país (c) o territorio (t)
    `Edition`,           # Año de edición de los datos
    `Status`,            # Clasificación de libertad (Libre, Parcialmente Libre, No Libre)
    `PR rating`,         # Puntuación de derechos políticos (1-7)
    `CL rating`          # Puntuación de libertades civiles (1-7)
  ) %>%
  rename(
    country = `Country/Territory`,
    region = `Region`,
    country_or_territory = `C/T`,
    year = `Edition`,
    status = `Status`,
    political_rights = `PR rating`,
    civil_liberties = `CL rating`
  )
freedom_final <- freedom_final %>%
  filter(year >= 2015 & year <= 2024)
## DEMOCRACY DATA ==> DEMOCRACY AND DICTATORSHIP
library(democracyData)
democracy_data <-
  democracyData::pacl_update |> 
  janitor::clean_names() |> 
  dplyr::select(
    "country_name" = "pacl_update_country",
    "country_code" = "pacl_update_country_isocode",
    "year",
    "regime_category_index" = "dd_regime",
    "regime_category" = "dd_category",
    "is_monarchy" = "monarchy",
    "is_commonwealth" = "commonwealth",
    "monarch_name",
    "monarch_accession_year" = "monarch_accession",
    "monarch_birthyear",
    "is_female_monarch" = "female_monarch",
    "is_democracy" = "democracy",
    "is_presidential" = "presidential",
    "president_name",
    "president_accesion_year" = "president_accesion",
    "president_birthyear",
    "is_interim_phase" = "interim_phase",
    "is_female_president" = "female_president",
    "is_colony" = "colony",
    "colony_of",
    "colony_administrated_by",
    "is_communist" = "communist",
    "has_regime_change_lag" = "regime_change_lag",
    "spatial_democracy",
    "parliament_chambers" = "no_of_chambers_in_parliament",
    "has_proportional_voting" = "proportional_voting",
    "election_system",
    "lower_house_members" = "no_of_members_in_lower_house",
    "upper_house_members" = "no_of_members_in_upper_house",
    "third_house_members" = "no_of_members_in_third_house",
    "has_new_constitution" = "new_constitution",
    "has_full_suffrage" = "fullsuffrage",
    "suffrage_restriction",
    "electoral_category_index" = "electoral",
    "spatial_electoral",
    "has_alternation" = "alternation",
    "is_multiparty" = "multiparty",
    "has_free_and_fair_election" = "free_and_fair_election",
    "parliamentary_election_year",
    "election_month" = "election_month_year",
    "has_postponed_election" = "postponed_election"
  ) |>
  dplyr::mutate(
    election_month = dplyr::na_if(.data$election_month, "?")
  ) |> 
  tidyr::separate_wider_regex(
    "election_month",
    patterns = c(
      election_month = "\\D+",
      election_year = "\\d{4}$"
    ),
    too_few = "align_start"
  ) |> 
  dplyr::mutate(
    electoral_category = dplyr::case_match(
      .data$electoral_category_index,
      0 ~ "no elections",
      1 ~ "single-party elections",
      2 ~ "non-democratic multi-party elections",
      3 ~ "democratic elections"
    ),
    .after = "electoral_category_index"
  ) |> 
  dplyr::mutate(
    election_month = stringr::str_squish(.data$election_month),
    dplyr::across(
      c(
        tidyselect::ends_with("_index"),
        tidyselect::contains("year"),
        tidyselect::ends_with("_members"),
        "parliament_chambers"
      ),
      as.integer
    ),
    dplyr::across(
      c(
        tidyselect::starts_with("is_"),
        tidyselect::starts_with("has_")
      ),
      as.logical
    )
  )
### Las variables que nos pueden llegar a interesar son:
#### country_name (necesitamos el país/territorio)
#### year (año)
#### regime_category (Parliamentary democracies, Mixed democracies (with weak presidents), Presidential democracies, Civilian autocracies, Military dictatorships, Royal dictatorships)
#### is_monarchy (es monarquía o no)
#### is_democracia (es democracia o no)
#### is_presidential (es presidencial o no)
#### is_colony (es colonia o no)
#### is_communist (es comunista o no)
#### spatial_democracy (como de democráticos son sus países vecinos) 
#### has_full_suffrage (tiene sufragio universal o no)
#### electoral_category (No elections, Single-party elections, non-democratic multi-party elections, democratic elections)
#### spatial_electoral (cómo son las elecciones en sus países vecinos)
#### has_free_and_fair_election (tienen elecciones justas o no)
#### has_alternation (cambian de gobierno o no)
democracy_final <- democracy_data %>%
  select(
    country_name, 
    year, 
    regime_category, 
    is_monarchy, 
    is_democracy, 
    is_presidential, 
    is_colony, 
    is_communist, 
    spatial_democracy, 
    has_full_suffrage, 
    electoral_category, 
    spatial_electoral, 
    has_free_and_fair_election, 
    has_alternation
  ) %>%
  rename(
    monarchy = is_monarchy,
    democracy = is_democracy,
    presidential = is_presidential,
    colony = is_colony,
    communist = is_communist,
    sp_democracy = spatial_democracy,
    suffrage = has_full_suffrage,
    sp_electoral = spatial_electoral,
    fair_election = has_free_and_fair_election,
    alternation = has_alternation
  )
democracy_final <- democracy_final %>%
  filter(year >= 2015 & year <= 2024)
## UNIÓN DE LOS DATASETS
colnames(df_original)
colnames(democracy_final)
colnames(freedom_final)
# Renombrar la columna 'country_name' en democracy_final para que coincida con df_original
democracy_final <- democracy_final %>%
  rename(country = country_name)
# Ver los países en cada dataset para ver si hay alguna diferencia en la nomenclatura
unique(df_original$country)
unique(democracy_final$country)
unique(freedom_final$country)

setdiff(df_original$country, democracy_final$country)
setdiff(democracy_final$country, df_original$country)
setdiff(df_original$country, freedom_final$country)
setdiff(freedom_final$country, df_original$country)
# Corrección de nombres 
df_original <- df_original %>%
  mutate(country = case_when(
    country == "Trinidad & Tobago" ~ "Trinidad and Tobago",
    country == "Somaliland region" ~ "Somaliland",
    country == "Macedonia" ~ "North Macedonia",
    country == "Palestinian Territories" ~ "State of Palestine",
    country == "Congo" ~ "Congo (Kinshasa)",
    country == "Taiwan Province of China" ~ "Taiwan",
    country == "Hong Kong S.A.R. of China" ~ "Hong Kong",
    country == "Czechia" ~ "Czech Republic",
    country == "Turkiye" ~ "Turkey",
    country == "Argelia" ~ "Algeria",
    country == "Eswatini" ~ "Swaziland",
    TRUE ~ country
  ))
democracy_final <- democracy_final %>%
  mutate(country = case_when(
    country == "Slovak Republic" ~ "Slovakia",
    country == "Korea, Republic of" ~ "South Korea",
    country == "Trinidad &Tobago" ~ "Trinidad and Tobago",
    country == "Congo, Dem. Rep." ~ "Congo (Kinshasa)",
    country == "Congo, Republic of" ~ "Congo (Brazzaville)",
    country == "Gambia, The" ~ "Gambia",
    country == "Côte d`Ivoire" ~ "Ivory Coast",
    TRUE ~ country
  ))
freedom_final <- freedom_final %>%
  mutate(country = case_when(
    country == "Northern Cyprus" ~ "North Cyprus",
    country == "The Gambia" ~ "Gambia",
    country == "Cote d'Ivoire" ~ "Ivory Coast",
    country == "Eswatini" ~ "Swaziland",
    TRUE ~ country
  ))

# PRIMER DATAFRAME: df_completo (2015-2020, con todas las variables)
df_completo <- df_original %>%
  left_join(democracy_final, by = c("country", "year")) %>%
  left_join(freedom_final, by = c("country", "year")) %>%
  filter(year >= 2015 & year <= 2020)  # Filtrar solo hasta 2020

# SEGUNDO DATAFRAME: df_sin_democracia (2015-2024, sin democracy_final)
df_sin_democracia <- df_original %>%
  left_join(freedom_final, by = c("country", "year")) %>%
  filter(year >= 2015 & year <= 2024)  # Mantener toda la información de felicidad y libertad

summary(df_completo)
summary(df_sin_democracia)

na_presence_completo <- df_completo %>%
  summarise(across(everything(), ~ any(is.na(.)), .names = "NA_{.col}"))

na_presence_sin_democracia <- df_sin_democracia %>%
  summarise(across(everything(), ~ any(is.na(.)), .names = "NA_{.col}"))

# OPCIÓN 1: ELIMINAR LOS NA
df_completo_sin_na <- df_completo %>% drop_na()
df_sin_democracia_sin_na <- df_sin_democracia %>% drop_na()

# OPCIÓN 2: SUSTITUIR LOS NA
# VARIABLES NUMÉRICAS
df_completo_numeric <- df_completo %>%
  select_if(is.numeric)
df_sin_democracia_numeric <- df_sin_democracia %>%
  select_if(is.numeric)
imputacion_completo <- mice(df_completo_numeric, method = "pmm", m = 5, maxit = 50, seed = 123)
df_completo_pmm <- complete(imputacion_completo)
imputacion_sin_democracia <- mice(df_sin_democracia_numeric, method = "pmm", m = 5, maxit = 50, seed = 123)
df_sin_democracia_pmm <- complete(imputacion_sin_democracia)
df_completo_pmm <- bind_cols(df_completo %>% select(-colnames(df_completo_numeric)), df_completo_pmm)
df_sin_democracia_pmm <- bind_cols(df_sin_democracia %>% select(-colnames(df_sin_democracia_numeric)), df_sin_democracia_pmm)
# VARIABLES CATEGÓRICAS
md.pattern(df_completo_pmm)
vis_miss(df_completo_pmm, sort_miss=TRUE)
na_presence_completo_pmm <- df_completo_pmm %>%
  summarise(across(everything(), ~ any(is.na(.)), .names = "NA_{.col}"))
df_completo_pmm <- df_completo_pmm %>%
  mutate(
    regional_indicator = case_when(
      country == "Greece" ~ "Western Europe",
      country == "Cyprus" ~ "Western Europe",
      country == "Gambia" ~ "Sub-Saharan Africa",
      TRUE ~ regional_indicator
    ),
    colony = ifelse(country == "Libya", FALSE, colony)
  ) %>%
  filter(!country %in% c("North Cyprus", "Kosovo", "Somaliland", "State of Palestine"))


md.pattern(df_sin_democracia_pmm)
vis_miss(df_sin_democracia_pmm, sort_miss=TRUE)
na_presence_sin_democracia_pmm <- df_sin_democracia_pmm %>%
  summarise(across(everything(), ~ any(is.na(.)), .names = "NA_{.col}"))
df_sin_democracia_pmm <- df_sin_democracia_pmm %>%
  mutate(
    regional_indicator = case_when(
      country == "Greece" ~ "Western Europe",
      country == "Cyprus" ~ "Western Europe",
      country == "Gambia" ~ "Sub-Saharan Africa",
      TRUE ~ regional_indicator
    ),
  ) %>%
  filter(!country %in% c("State of Palestine"))
# Eliminar territorios
df_sin_democracia_sin_na <- df_sin_democracia_sin_na %>%
  filter(tolower(country_or_territory) == "c") %>%  # Solo países

  # Eliminar la variable 'country_or_territory'
  select(-country_or_territory)
```

```{r include=FALSE, message=FALSE, warning=FALSE}
# Variables políticas que queremos analizar
variables_politicas <- c("regime_category", "monarchy", "democracy", 
                         "presidential", "colony", "communist", 
                         "suffrage", "electoral_category", 
                         "fair_election", "alternation")

# Verificar cambios a lo largo del tiempo
cambios_variables <- df_completo %>%
  select(country, year, all_of(variables_politicas)) %>%
  group_by(country) %>%
  summarise(across(all_of(variables_politicas), ~ n_distinct(.x, na.rm = TRUE))) %>%
  pivot_longer(-country, names_to = "variable", values_to = "distinct_values") %>%
  filter(distinct_values > 1)

# Mostrar los países y variables que cambian a lo largo del tiempo
print(cambios_variables)
```

## Análisis de las bases de datos complementarias

Al trabajar con datos longitudinales a nivel estatal, surge una cuestión clave: ¿en qué medida las características políticas de cada país se mantienen estables o experimentan cambios relevantes a lo largo del tiempo? Para responder a esta pregunta, incorporaremos la información de las bases de datos Freedom in the World y Democracy Data que permite capturar distintos aspectos del contexto político de los países, como el tipo de régimen, la alternancia en el poder o la existencia de elecciones libres.

Sin embargo, nos encontramos con dos limitaciones importantes. En primer lugar, muchas de estas variables presentan una cobertura temporal limitada, con registros ausentes en varios años dentro del periodo 2015–2024. En segundo lugar, se trata de variables que tienden a ser bastante estables, ya que en la mayoría de los países analizados no se observan cambios relevantes a lo largo del tiempo. Estas circunstancias suponen un obstáculo al querer tratarlas como variables longitudinales.

Por ello, incorporaremos estas variables como una "foto fija" del contexto político, extrayendo su valor más representativo dentro del periodo estudiado. De esta forma, las utilizamos como covariables fijas en los modelos de felicidad, de manera que enriquecemos el análisis sin introducir sesgos derivados de valores faltantes o variaciones mínimas que podrían aportar ruido en lugar de información de valor.

No obstante, existen excepciones que tenemos que tener en cuenta, ya que algunos países sí que han experimentado cambios significativos en su sistema político, forma de gobierno o nivel de democracia. A continuación se representa gráficamente la evolución de dichas variables para estos casos específicos, con el objetivo de ilustrar de forma visual estos cambios.

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.width=12, fig.height=8}
#| label: fig-variables-binarias
#| echo: false
#| warning: false
#| fig-cap: "Evolución temporal de las variables políticas binarias de la base de datos Democracy Data."
# Definir las variables binarias si no están previamente definidas
variables_binarias <- c("alternation", "fair_election", "democracy")

# Definir los países de interés
paises_con_cambios <- c("Comoros", "Congo (Kinshasa)", "Madagascar", "Nicaragua", "Turkey", "Venezuela",
                        "Angola", "Bolivia", "Liberia", "Honduras", "Hungary", "Kenya")

# Opcional: destacar un subconjunto de países para visualizar
paises_destacados <- paises_con_cambios

# Preparar los datos
df_binarias_segmentos <- df_completo %>%
  filter(country %in% paises_con_cambios) %>%
  mutate(across(all_of(variables_binarias), as.character)) %>%
  select(country, year, all_of(variables_binarias)) %>%
  pivot_longer(cols = -c(country, year), names_to = "variable", values_to = "valor") %>%
  group_by(country, variable) %>%
  arrange(year, .by_group = TRUE) %>%
  mutate(
    valor_num = ifelse(valor %in% c("TRUE", "yes"), 1, 0),
    year_next = lead(year),
    valor_next = lead(valor),
    valor_next_num = ifelse(valor_next %in% c("TRUE", "yes"), 1, 0),
    tipo_cambio = case_when(
      is.na(valor_next) ~ NA_character_,
      valor_num == valor_next_num ~ "sin cambio",
      valor_num == 0 & valor_next_num == 1 ~ "avance",
      valor_num == 1 & valor_next_num == 0 ~ "retroceso"
    )
  ) %>%
  filter(!is.na(tipo_cambio)) %>%
  ungroup()

# Filtrado para países destacados
df_binarias_filtrado <- df_binarias_segmentos %>%
  filter(country %in% paises_destacados)

# Gráfico final
ggplot(df_binarias_filtrado, aes(x = year, xend = year_next,
                                 y = valor_num, yend = valor_next_num,
                                 color = tipo_cambio)) +
  geom_segment(linewidth = 1) +
  facet_grid(country ~ variable) +
  scale_color_manual(values = c("avance" = "forestgreen",
                                "retroceso" = "firebrick",
                                "sin cambio" = "gray70")) +
  scale_y_continuous(breaks = c(0, 1), labels = c("FALSE", "TRUE")) +
  theme_minimal() +
  labs(title = "Evolución de variables políticas binarias por país",
       x = "Año", y = "Valor", color = "Tipo de cambio") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text.y = element_text(angle = 0))


```

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.width=12, fig.height=8}
#| label: fig-regime-electoral
#| echo: false
#| warning: false
#| fig-cap: "Evolución del cambio de régimen democrático en países desde 2015 a 2020."
library(dplyr)
library(ggplot2)
library(tidyr)

# Lista base de países con posibles cambios
paises_cambio <- c("Bolivia", "Burkina Faso", "Burundi", "Comoros",
                   "Egypt", "Honduras", "Hungary", "Iraq", "Kenya",
                   "Laos", "Liberia", "Myanmar", "Nicaragua", "Turkey",
                   "Venezuela", "Yemen", "Zimbabwe")

# Preparamos los datos
df_categoricas <- df_completo %>%
  filter(country %in% paises_cambio) %>%
  select(country, year, regime_category, electoral_category) %>%
  mutate(across(c(regime_category, electoral_category), as.character)) %>%
  pivot_longer(cols = c(regime_category, electoral_category),
               names_to = "variable", values_to = "valor")

# 1. Gráfico para regime_category (quitamos Egipto)
df_regime <- df_categoricas %>%
  filter(variable == "regime_category", country != "Egypt")

ggplot(df_regime, aes(x = year, y = valor, group = country, color = valor)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  facet_wrap(~ country, scales = "free_y") +
  theme_minimal() +
  labs(title = "Evolución de regime_category por país",
       x = "Año", y = "Categoría de régimen", color = "Valor") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 9),
    legend.position = "bottom"
  )

```

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.width=12, fig.height=8}
#| label: fig-electoral
#| echo: false
#| warning: false
#| fig-cap: "Evolución del cambio de categoría electoral en países desde 2015 a 2020."
library(dplyr)
library(ggplot2)
library(tidyr)

# 2. Gráfico para electoral_category (quitamos los países indicados)
excluir_electoral <- c("Burkina Faso", "Burundi", "Hungary", "Iraq", "Laos", "Myanmar", "Yemen", "Zimbabwe")

df_electoral <- df_categoricas %>%
  filter(variable == "electoral_category", !country %in% excluir_electoral)

ggplot(df_electoral, aes(x = year, y = valor, group = country, color = valor)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  facet_wrap(~ country, scales = "free_y") +
  theme_minimal() +
  labs(title = "Evolución de electoral_category por país",
       x = "Año", y = "Categoría electoral", color = "Valor") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 9),
    legend.position = "bottom"
  )

```

```{r}
#| label: fig-cambio-variables
#| echo: false
#| warning: false
#| message: false
#| fig-cap: "Análisis de los distintos cambios políticos en países de 2015 a 2020."
#| fig-width: 5
#| fig-height: 3.5
library(dplyr)
library(tidyr)
library(ggplot2)

# Subconjunto con países que han tenido al menos un cambio
paises_cambio <- c("Angola", "Bolivia", "Burkina Faso", "Burundi", "Comoros",
                   "Congo (Kinshasa)", "Egypt", "Honduras", "Hungary", "Iraq", "Kenya",
                   "Laos", "Liberia", "Madagascar", "Myanmar", "Nicaragua", "Turkey",
                   "Venezuela", "Yemen", "Zimbabwe")

# Variables categóricas de interés
vars_politicas <- c("regime_category", "democracy", "electoral_category",
                    "fair_election", "alternation")

# Crear df con 1 si hay más de un valor distinto en el tiempo
cambios_pais <- df_completo %>%
  filter(country %in% paises_cambio) %>%
  select(country, year, all_of(vars_politicas)) %>%
  mutate(across(all_of(vars_politicas), as.character)) %>%
  pivot_longer(cols = -c(country, year), names_to = "variable", values_to = "valor") %>%
  distinct() %>%
  group_by(country, variable) %>%
  summarise(cambios = n_distinct(valor), .groups = "drop") %>%
  mutate(cambio = ifelse(cambios > 1, 1, 0)) %>%
  select(-cambios)

# Gráfico tipo heatmap
ggplot(cambios_pais, aes(x = variable, y = country, fill = factor(cambio))) +
  geom_tile(color = "white") +
  scale_fill_manual(values = c("0" = "white", "1" = "#440154"), labels = c("Sin cambio", "Con cambio")) +
  theme_minimal() +
  labs(title = "Cambios en variables políticas (2015-2020)",
       x = "Variable política",
       y = "País",
       fill = "Cambio") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

Estas figuras sobre la evolución de diferentes variables políticas muestran de forma clara y visual la evolución temporal de varios países que han experimentado cambios entre 2015 y 2020.

En cuanto a los cambios en la alternancia en el poder, los cuales podemos apreciar en la @fig-variables-binarias, vemos cómo en Nicaragua y Venezuela esta variable refleja la falta de alternancia, mostrando la acumulación del poder por parte de gobiernos autoritarios. Observando la variable democrática, vemos que países como Nicaragua y Hungría dejaron de considerarse estados democráticos una vez llegaron al poder figuras autoritarias como Daniel Ortega y Viktor Orbán. Por último, si nos fijamos en la variable sobre elecciones libres y justas, vemos que Bolivia presenta un cambio negativo en 2019 correspondiente a las acusaciones de fraude electoral; provocando una crisis política y la renuncia del aquel entonces presidente Evo Morales. Sin embargo, no todo son cambios negativos, ya que en la @fig-variables-binarias también podemos observar avances en países como Liberia que han mejorado sus instituciones democráticas gracias a la llegada al poder del exfutbolista George Weah en las elecciones de 2017; las cuales fueron históricas ya que supusieron la primera transición presidencial pacífica en el país desde 1944.

Si observamos los cambios en el tipo de régimen en la @fig-regime-electoral, vemos como Hungría pasó de ser considerada una democracia parlamentaria a una dictadura civil, resaltando el gobierno autoritario de Viktor Orbán y el deterioro del sistema de gobierno. Otro caso que podemos destacar es el de Venezuela, la cual sufre un retroceso democrático a partir de 2016; pasando de ser considerada una democracia presidencial a una dictadura civil. Sin embargo, hay casos como Liberia que sucede todo lo contrario, destacando el avance en el proceso democrático mencionado en la figura anterior y dejando de ser considerada una dictadura civil para ser considerada como una democracia presidencial. 

Si observamos los cambios en el tipo de elecciones en la @fig-electoral, podemos ver que Venezuela llegó a presentar hasta 3 categorías distintas: pasó de elecciones democráticas a elecciones no democráticas multi-partido y luego a tener elecciones de un sólo partido, reflejando la catástrofe sucesiva del sistema electoral bajo el régimen de Maduro. Otro ejemplo que podemos destacar es Turquía, que pasa de tener elecciones democráticas a no democráticas multi-partido, en línea con el creciente autoritarismo del presidente Erdoğan.

Por último, la @fig-cambio-variables nos muestra si algún país ha sufrido cambios en diferentes variables políticas. Además de los países ya mencionados anteriormente como Venezuela, Turquía o Nicaragua, los cuales han sufrido cambios en todas las variables políticas, cabe destacar el caso de Comoras, que también presenta múltiples cambios en estas variables. Estos cambios se deben a un período de inestabilidad política, en las que se aplicaron cambios en el sistema como la reforma constitucional de 2018 y las elecciones de 2019, que concentraron el poder y limitaron la oposición.

Estas figuras refuerzan la idea de que varios países han experimentado retrocesos democráticos significativos, especialmente en torno a elecciones libres, alternancia en el poder y la clasificación del sistema de gobierno. Además, demuestran que estos cambios no son simultáneos: mientras algunos países cambian en 2016, otros lo hacen en 2018 o 2029, lo cual permite contextualizar algunos cambios políticos con eventos históricos concretos en cada nación. Este tipo de análisis temporal no solo nos permite identificar tendencias políticas, sino que también podemos asociar estos cambios a la percepción de felicidad de la población y evaluar si existe alguna relación.

Dado que uno de los objetivos principales de este análisis es estudiar la evolución de la felicidad y sus factores influyentes a lo largo del tiempo, necesitamos trabajar con una base de datos que tenga cobertura completa para el periodo 2015–2024. En este sentido, hemos optado por utilizar como base principal la combinación de las bases de datos World Happiness y Freedom in the World, ya que ofrecen la continuidad temporal necesaria para poder aplicar técnicas de medidas repetidas y estudiar cómo varían las observaciones de un mismo país a lo largo de los años. Además, la base de datos Freedom in the World contiene ciertas variables políticas con algunas diferencias notables en algunos casos, por lo que combinarla con la base de datos World Happiness nos puede servir de gran ayuda a la hora de ambientar ciertos cambios en la felicidad.

Por su parte, la base de datos Democracy Data presenta una limitación temporal importante, al contener información solo hasta el año 2020; además de que muchas de sus variables muestran poca o nula variación a lo largo del tiempo. Por ello, en lugar de excluir completamente esta base, la integramos como complemento, utilizándola para construir una fotografía del contexto institucional y político de cada país. Esta fotografía nos resulta especialmente útil a la hora de interpretar fenómenos detectados en el análisis longitudinal, como caídas o aumentos abruptos en el nivel de felicidad. En esos casos, el tipo de régimen, la alternancia en el poder o la existencia de elecciones libres pueden aportar información relevante para entender estas variaciones.

Una vez hemos preparado la base de datos final, podemos estudiar la evolución de la variable objetivo `happiness_score` entre 2015 y 2024. Para ello, recurriremos a herramientas visuales como mapas o gráficos para poder detectar tanto patrones y tendencias generales como variaciones específicas en determinados territorios. Estas visualizaciones nos pueden dar ciertos indicios sobre algunas variables explicativas que podemos tener en cuenta de cara al análisis longitudinal.

## Evolución de la felicidad a lo largo del tiempo

Con el propósito de determinar ciertas tendencias geográficas en los niveles de felicidad, utilizaremos mapas coropléticos que nos permiten visualizar espacialmente la distribución del `happiness_score`. Este método ayuda a detectar agrupaciones regionales, contrastes entre países vecinos y posibles comportamientos atípicos. Representando la información directamente sobre el territorio, los mapas complementan el análisis longitudinal a través de la contextualización geográfica de la puntuación de la felicidad.

```{r}
#| label: fig-mapa-mundi
#| echo: false
#| warning: false
#| fig-cap: "Representación de la puntuación global de felicidad en 2024."
library(plotly)
library(dplyr)
library(readr)

df_base <- read.csv('https://raw.githubusercontent.com/plotly/datasets/master/2014_world_gdp_with_codes.csv')
df_felicidad <- df_sin_democracia_sin_na

df_mapa1 <- df_base %>%
  left_join(filter(df_felicidad, year == 2024), by = c("COUNTRY" = "country")) %>%
  filter(!is.na(happiness_score))

l <- list(color = toRGB("grey"), width = 0.5)
g <- list(showframe = FALSE, showcoastlines = FALSE, projection = list(type = 'Mercator'))

fig1 <- plot_geo(df_mapa1) %>%
  add_trace(
    z = ~happiness_score, color = ~happiness_score, colorscale = "Viridis",
    text = ~COUNTRY, locations = ~CODE, marker = list(line = l)
  ) %>%
  colorbar(title = "Happiness Score") %>%
  layout(title = 'Países con datos de felicidad (2024)', geo = g)

if (knitr::is_latex_output()) {
  html_file <- "mapa_interactivo.html"
  png_file <- "mapa_interactivo.png"
  saveWidget(fig1, file = html_file, selfcontained = TRUE)
  webshot2::webshot(html_file, file = png_file, vwidth = 2000, vheight = 1200)
  knitr::include_graphics("mapa_interactivo.png")
} else {
  fig1
}

```

El mapa de felicidad por país en 2024 de la @fig-mapa-mundi muestra una clara diversidad geográfica en la percepción de la felicidad. Se observa que, por lo general, las regiones del hemisferio norte como Europa Occidental, América del Norte y Oceanía, tienen niveles más altos de felicidad (colores amarillos y verde claro), mientras que las regiones del hemisferio sur, especialmente África Subsahariana y algunas partes de Asia como Afganistán o India, presentan valores notablemente más bajos (colores azul oscuro o morado).

Países como Finlandia, Dinamarca e Islandia destacan con las puntuaciones más altas, demostrando estabilidad y altos niveles de desarrollo económico y social. En contraste, países como Zimbabwe, Líbano o Afganistán presentan los niveles más bajos, lo cual es coherente ya que son países donde rodeados por el conflicto, la pobreza y la inestabilidad política.

A través de este mapa no sólo diferenciamos diferencias entre regiones, sino que también podemos señalar patrones estructurales: Sudamérica, por ejemplo, muestra un nivel medio de felicidad, con cierta variabilidad entre países. Este mapa es útil cuando queremos detectar casos anómalos, como países con puntuaciones bajas en regiones generalmente altas o viceversa; como puede llegar a ser el caso de Afganistán, con una puntuación muy por debajo de sus países vecinos. En general, la figura muestra el impacto que pueden tener factores estructurales como el desarrollo económico o la estabilidad política en la percepción del bienestar de los ciudadanos a nivel global.

Además del análisis por país, resulta interesante analizar cómo cambia la felicidad entre regiones, y cómo se distribuye la felicidad en cada una de ellas. Para ello, utilizaremos diagramas de violín, que nos permiten observar la dispersión y concentración de los valores de `happiness_score`, además de su mediana y densidad; pudiendo analizar la distribución de la felicidad en cada región. Esta representación permite comparar el nivel de felicidad de las diferentes regiones y detectar posibles casos de desigualdades que podríamos no localizar en otro tipo de gráficos.

```{r}
#| label: fig-felicidad-region
#| echo: false
#| warning: false
#| fig-cap: "Distribución de la felicidad agrupada por región en los años 2015, 2020 y 2024."
orden_regiones <- c(
  "Western Europe", "Central and Eastern Europe", "Commonwealth of Independent States",
  "Middle East and North Africa", "Sub-Saharan Africa", "South Asia",
  "Southeast Asia", "East Asia", "Latin America and Caribbean", "North America and ANZ"
)

df_violin <- df_sin_democracia_sin_na %>%
  filter(year %in% c(2015, 2020, 2024)) %>%
  mutate(regional_indicator = factor(regional_indicator, levels = orden_regiones))

p <- ggplot(df_violin, aes(x = regional_indicator, y = happiness_score, fill = regional_indicator)) +
  geom_violin(alpha = 0.6, trim = FALSE) +
  stat_summary(fun = median, geom = "point", color = "black", shape = 18, size = 2) +
  theme_minimal() +
  facet_wrap(~ year, ncol = 1) +
  labs(
    title = "Distribución de Felicidad por Región (2015, 2020, 2024)",
    x = "Región", y = "Happiness Score"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")

if (knitr::is_latex_output()) {
  ggsave("violines_felicidad_por_anio.png", p, width = 10, height = 12)
  knitr::include_graphics("violines_felicidad_por_anio.png")
} else {
  ggplotly(p)
}

```

Observando la distribución de la felicidad por región de la @fig-felicidad-region, si nos fijamos en la mediana (el rombo negro en cada violín), podemos contemplar cierta estabilidad en prácticamente todas las regiones; aunque hay regiones como Europa Occidental o Norteamérica y Australia que mantienen medianas altas a lo largo del tiempo, mientras que el Sur de Asia y África Sub-Sahariana tienen medianas más bajas.

En estos gráficos también se puede observar cierta bimodalidad, ya que algunas regiones, como Oriente Medio y África del Norte muestran dos modas (zonas más anchas del violín), lo que implicar cierta variabilidad interna: algunos países con altos niveles de felicidad conviven con otros con puntuaciones mucho más bajas. Por ejemplo, Asia del Sur presenta una distribución muy desigual en 2024, con un ensanchamiento en la parte inferior del gráfico que corresponde con una felicidad baja en ciertos países (como Afganistán).

En general, la forma de las distribuciones se mantiene similar entre 2015 y 2024 en muchas regiones, pero hay algunas en las que apreciamos mayor dispersión como es el caso Oriente Medio y Asia del Sur, los cuales sufren una caída considerable en la felicidad. Al contrario de estos últimos, hay otras regiones como Europa Occidental y Norteamérica y Australia que presentan distribuciones densas con una felicidad más alta y estable, lo que refleja mayor consistencia en el bienestar de sus ciudadanos.

A continuación analizamos la percepción de la corrupción, una variable que diversos estudios han señalado como influyente en la representación de la felicidad. En la @fig-percepcion-corrupcion se representa la distribución de esta variable mediante diagramas de violines, lo que nos permite observar también las diferencias entre regiones. Podemos analizar que hay algunas regiones que presentan niveles percibidos de corrupción notablemente más bajos, lo que podría estar asociado a mayores niveles de bienestar.

```{r}
#| label: fig-percepcion-corrupcion
#| echo: false
#| warning: false
#| fig-cap: "Distribución de la percepción de corrupción agrupada por región en los años 2015, 2020 y 2024."
orden_regiones <- c(
  "Western Europe", "Central and Eastern Europe", "Commonwealth of Independent States",
  "Middle East and North Africa", "Sub-Saharan Africa", "South Asia",
  "Southeast Asia", "East Asia", "Latin America and Caribbean", "North America and ANZ"
)

df_corrupcion <- df_sin_democracia_sin_na %>%
  filter(year %in% c(2015, 2020, 2024)) %>%
  mutate(regional_indicator = factor(regional_indicator, levels = orden_regiones))

p <- ggplot(df_corrupcion, aes(x = regional_indicator, y = corruption, fill = regional_indicator)) +
  geom_violin(alpha = 0.6, trim = FALSE) +
  stat_summary(fun = median, geom = "point", color = "black", shape = 18, size = 2) +
  theme_minimal() +
  facet_wrap(~ year, ncol = 1) +
  labs(
    title = "Distribución de la Percepción de Corrupción por Región (2015, 2020, 2024)",
    x = "Región", y = "Percepción de Corrupción"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")

if (knitr::is_latex_output()) {
  ggsave("violines_corrupcion_por_anio.png", p, width = 10, height = 12)
  knitr::include_graphics("violines_corrupcion_por_anio.png")
} else {
  ggplotly(p)
}

```

El diagrama de violines de la @fig-percepcion-corrupcion permite observar la evolución de la percepción de corrupción en las distintas regiones a lo largo del tiempo, destacando una clara bimodalidad en algunas regiones a partir de 2020 y especialmente en 2024, lo que sugiere una variabilidad creciente entre países dentro de la misma región.

Europa Occidental mantiene una distribución relativamente estable a lo largo del tiempo, destacando que siempre tiene países con una percepción de corrupción baja y otros con una percepción de la corrupción alta; con un valor de la mediana que sugiere una distribución simétrica. Sin embargo, en Europa Central y Oriental se observa un patrón inverso. En 2015 y 2020, la percepción es bastante alta, pero en 2024 se evidencia una bajada considerable en la percepción de la corrupción, lo que indica una mejoría de la percepción ciudadana sobre la corrupción en algunos países.

La Comunidad de Estados Independientes muestra una bimodalidad clara en 2024, mientras que en 2015 y 2020 tenía una distribución más concentrada. Esto se debe a que ahora hay países como Ucrania (0.04) que tienen niveles de percepción de corrupción muy bajos, mientras que el resto de países tienen una percepción de corrupción más alta. Sudamérica también muestra un cambio claro: de una percepción moderadamente alta en 2015 y 2020 a una percepción mucho más baja en 2024, aunque también podemos apreciar cierta bimodalidad debido a la baja corrupción percibida en países como Jamaica (0.05), mientras todo lo contrario ocurre en países como El Salvador (0.44).

Este análisis permite estudiar no solo la evolución de la percepción de la corrupción a lo largo del tiempo sino también la creciente variabilidad dentro de algunas regiones, lo que puede ser de utilidad para determinar si ciertos eventos políticos que desemboquen en una concentración del poder pueden estar afectando a una mayor percepción de la corrupción entre los ciudadanos. 

Con el objetivo de comprender la evolución de la situación global en torno a diferentes variables políticas, analizamos a continuación la evolución promedio anual de las principales variables del informe de felicidad haciendo una comparación con 3 países que hemos destacado anteriormente por sus cambios políticos en los últimos años como son Hungría, Turquía y Venezuela. Esta visualización nos permitirá detectar posibles tendencias e impactos globales, como crisis políticas, sanitarias o económicas.

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=12, fig.height=8}
#| label: fig-variables-comparacion
#| echo: false
#| warning: false
#| fig-cap: "Análisis temporal de las principales variables del informe de felicidad en comparación con Hungría, Turquía y Venezuela."
#| fig-height: 6
library(dplyr)
library(tidyr)
library(ggplot2)

# Variables numéricas de interés
vars_interes <- c("gdp", "support", 
                  "life_exp", "freedom", 
                  "generosity", "corruption", "happiness_score")

# Media global
media_global <- df_sin_democracia_sin_na %>%
  group_by(year) %>%
  summarise(across(all_of(vars_interes), mean, na.rm = TRUE)) %>%
  mutate(country = "Media Global") %>%
  pivot_longer(cols = -c(year, country), names_to = "variable", values_to = "media")

# Datos de los países a comparar
paises <- c("Venezuela", "Turkey", "Hungary")
paises_data <- df_sin_democracia_sin_na %>%
  filter(country %in% paises) %>%
  select(year, country, all_of(vars_interes)) %>%
  pivot_longer(cols = -c(year, country), names_to = "variable", values_to = "media")

# Combinar todo
data_comparada <- bind_rows(media_global, paises_data)

# Gráfico
ggplot(data_comparada, aes(x = year, y = media, color = country)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  facet_wrap(~variable, scales = "free_y") +
  scale_color_manual(
    values = c(
      "Media Global" = "gray70",
      "Venezuela" = "firebrick",
      "Turkey" = "royalblue",
      "Hungary" = "darkgreen"
    )
  ) +
  scale_x_continuous(breaks = sort(unique(data_comparada$year))) +
  theme_minimal() +
  labs(
    title = "Comparación: Media Global vs Venezuela, Turquía y Hungría (2015–2024)",
    x = "Año", y = "Valor medio", color = "País"
  ) +
  theme(strip.text = element_text(face = "bold"))

```

La evolución anual del promedio de las variables de interés de la @fig-variables-comparacion refleja tendencias globales relevantes, y comparando su evolución con la de ciertos países concretos podemos determinar ciertas dinámicas y comprender cómo ciertos contextos políticos específicos pueden afectar a la felicidad de la población.

En primer lugar, Venezuela se desmarca de forma clara en varias variables. Mientras que a partir de 2017 el PIB per cápita se mantiene considerablemente constante, el de Venezuela empeiza a bajar, destacando una caída drástica en 2021, producto de la poca producción petrolera y la hiperinflación, reflejando la tremenda crisis económica que atraviesa el país. Cabe destacar el descenso pronunciado que se produce en la libertad para tomar decisiones y en la felicidad percibida desde 2015, lo que podía sugerir un deterioro generalizado del bienestar, pero a partir de 2019 ambas variables empiezan a subir; efecto que puede haberse dado después de que las personas más descontentas formasen parte de la migración masiva que sufrió el país en años anteriores. Dicho aumento coincide con el mismo que sufre la generosidad a partir de 2019, superando incluso a la media global, lo cual podría estar relacionado a la solidaridad comunitaria surgida ante la crisis.

Por otro lado, aunque la libertad para tomar decisiones vaya creciendo cada año, Turquía muestra una tendencia claramente decreciente, especialmente desde 2018, coincidiendo con el fortalecimiento del poder ejecutivo de Recep Tayyip Erdoğan después de las elecciones. A pesar de mantener un PIB per cápita relativamente estable y una esperanza de vida en línea con la media global, la generosidad se mantiene bastante baja con respecto a la media, lo que, unido a la bajada de la felicidad a partir de 2019, puede reflejar un descontento ciudadano con la situación actual.

En el caso de Hungría, se observa una situación más confusa. Por un lado, variables como la esperanza de vida, el apoyo social y la felicidad percibida se mantienen por encima de la media global, lo que sugiere una cierta estabilidad a nivel civil. No obstante, la percepción de corrupción es elevada y la generosidad es bastante baja, lo cual coincide con el retroceso democrático que está sufriendo el país estos últimos años. Este contraste demuestra cómo un país puede mantener ciertos niveles de bienestar mientras sus organismos democráticos se deterioran.

Este análisis nos permite comprender el estudio previo de la evolución global. Hemos observado que algunas variables como la libertad para tomar decisiones, la generosidad o la propia felicidad han ido creciendo a lo largo del tiempo de forma estable, mientras que otras como la esperanza de vida han sufrido grandes fluctuaciones, algunas posiblemente como efectos secundarios post-pandemia. También destaca un pico atípico en el PIB per cápita en 2016, probablemente debido a valores extremos ocasionados por mala imputación en la recolecta de datos ya que hay muchos países en 2016 que presentan un PIB de 10, como es el caso de Ecuador: pasa de tener un PIB de 5.11 en 2015 a tener un PIB de 10 en 2016, para luego tener un PIB de 5.35 en 2017. También se observa una tendencia general de aumento en la felicidad percibida hasta 2022, seguida de un leve descenso. Por último, vemos que la percepción de corrupción también tiene ciertas oscilaciones entre años, lo que refleja fuertes diferencias entre países a lo largo del tiempo.

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
#| label: fig-felicidad-pais
#| echo: false
#| warning: false
#| fig-cap: "Análisis temporal de la evolución temporal de la felicidad por país."
#| fig-width: 5
#| fig-height: 3.5
library(dplyr)
library(ggplot2)
library(viridis)

# 1. Calcular la media global por país (en todo el periodo)
orden_paises <- df_sin_democracia_sin_na %>%
  group_by(country) %>%
  summarise(media_pais = mean(happiness_score, na.rm = TRUE)) %>%
  arrange(desc(media_pais)) %>%
  pull(country)

# 2. Calcular media global por año
media_anual <- df_sin_democracia_sin_na %>%
  group_by(year) %>%
  summarise(media_happiness = mean(happiness_score, na.rm = TRUE))

# 3. Preparar dataset con orden fijo
df_plot <- df_sin_democracia_sin_na %>%
  filter(!is.na(happiness_score)) %>%
  left_join(media_anual, by = "year") %>%
  mutate(country = factor(country, levels = orden_paises))

# 4. Gráfico con orden constante y media global por año
ggplot(df_plot, aes(x = country, y = happiness_score, fill = happiness_score)) +
  geom_col(show.legend = FALSE) +
  geom_hline(aes(yintercept = media_happiness), color = "red", linetype = "dashed", linewidth = 0.8) +
  facet_wrap(~ year, scales = "free_x") +
  scale_fill_viridis_c() +
  labs(
    title = "Happiness Score por País (ordenado por media global)",
    subtitle = "Línea roja discontinua = media global del año",
    x = "País", y = "Happiness Score"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    strip.text = element_text(face = "bold")
  )


```

La @fig-felicidad-pais muestra la evolución del Happiness Score por país entre los años 2015 y 2024, en el que la línea roja discontinua indica la media global de felicidad de ese año. Además, para hacer un análisis coherente, en el que cada barra del gráfico representa el valor de felicidad para un país en un año determinado, haremos que las barras estén ordenadas de izquierda a derecha según la media de felicidad del país durante el periodo completo (2015–2024); es decir, los países más felices en promedio están situados a la izquierda en todos los años.

Podemos observar que la media global de felicidad se mantiene estable a lo largo de los años en un intervalo relativamente estrecho (entre 5.3 y 5.5 puntos), sugiriendo que la felicidad mundial no ha sufrido ningún cambio contundente a lo largo de estos años. Sin embargo, esta estabilidad global en la puntuación no representa una estabilidad en todos los países.

A medida que progresan los años, especialmente a partir de 2020, observamos un aumento gradual en el número de países situados por debajo de la media global. Esta tendencia puede estar vinculada al impacto de la pandemia de COVID-19 y sus consecuencias, que afectaron, aunque no de la misma forma, a distintas regiones. En relación a lo visto anteriormente, esta tendencia también podría deberse a ciertos sucesos que han llevado al deterioro democrático y a la inestabilidad política en determinadas regiones. 

La figura también demuestra las fuertes desigualdades en la distribución de la felicidad: mientras que un pequeño grupo de países (naciones del norte de Europa como Finlandia, Dinamarca o Islandia) se mantiene en la parte superior del ranking con puntuaciones muy por encima de la media, la mayoría de países se concentran en la parte media/baja. Esta distribución irregular indica que, aunque algunos países tienen niveles altos de felicidad y bienestar, muchos otros enfrentan obstáculos que les impiden mejorar su puntuación de felicidad; como Siria, Burundi o Afganistán.

Otro aspecto a tener en cuenta en la figura es el descenso en los valores máximos del Happiness Score en los últimos años: en 2023 y 2024, los países con los niveles más altos de felicidad han sufrido una pequeña bajada. Esta caída podría darse debido a acontecimientos globales que les han impactado más tarde, o simplemente como una normalización tras haber tenido niveles bastante altos los años anteriores.

En general, la @fig-felicidad-pais no solo confirma que la media global se mantiene estable a lo largo de los años, sino que también muestra una dilatación de la brecha entre países que nos muestra la necesidad de buscar qué factores determinan esta diferencia de la felicidad entre países.

Tras analizar la evolución global de la felicidad, resulta interesante poner el foco en regiones más delimitadas que, por su cercanía, puedan mostrar dinámicas particulares a la hora de analizar la evolución de la felicidad en España. Con este fin, hemos seleccionado un grupo de países europeos próximos a España para realizar un análisis comparativo más detallado de la evolución del bienestar entre 2015 y 2024. Estos países son Portugal, Francia, Italia, Andorra, Suiza, Alemania y Reino Unido.

## Evolución del Happiness Score en España

En este apartado queremos observar dos cosas: por un lado, estudiar la evolución de la felicidad en España a lo largo del tiempo; y por otro, comparar dicha evolución con la de sus países vecinos. Además, se analizarán variables como el PIB per cápita, el apoyo social y la libertad en la toma de decisiones para identificar posibles factores que describan esta evolución.

A través de esta perspectiva, no solo evaluamos si España sigue la misma evolución que sus países vecinos, sino que también permite detectar tendencias de bienestar y fortalezas en Europa Occidental.

```{r echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-felicidad-espana
#| echo: false
#| warning: false
#| fig-cap: "Evolución temporal de la felicidad en España."
#| fig-width: 6
#| fig-height: 2.5
# Lista de países europeos cercanos a España
paises_cercanos <- c("Spain", "Portugal", "France", "Italy", "Andorra", "Switzerland", "Germany", "United Kingdom")

# Datos de estos países
df_cercanos <- df_sin_democracia_sin_na %>% 
  filter(country %in% paises_cercanos)

# Evolución del Happiness Score en España
df_espana <- df_cercanos %>% filter(country == "Spain")

ggplot(df_espana, aes(x = year, y = happiness_score)) +
  geom_line(color = "blue") +
  geom_point(color = "blue") +
  labs(title = "Evolución del Happiness Score en España", x = "Año", y = "Happiness Score") +
  scale_x_continuous(breaks = unique(df_espana$year)) +
  theme_minimal()
```

La @fig-felicidad-espana, muestra una evolución relativamente estable de la puntuación de felicidad en España, con valores alrededor del 6.4. No obstante, destaca una bajada en 2018, seguida de una recuperación progresiva hasta 2021, el primer año después de la pandemia. Esta bajada puede deberse a los múltiples casos de corrupción que sacudieron el país y que terminaron con una moción de censura contra el presidente que supuso en un cambio de gobierno. Por el contrario, este máximo en 2021 podría deberse a la resiliencia que tuvo la ciudadanía ante la crisis sanitaria; o, viendo que en los años siguientes se produce un leve descenso de la felicidad, podría deberse a un efecto atrasado de las consecuencias de la pandemia.

```{r echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-felicidad-espana-paises
#| echo: false
#| warning: false
#| fig-cap: "Evolución temporal de la felicidad en España y en países cercanos."
#| fig-width: 6
#| fig-height: 2.5
# Evolución del Happiness Score en países cercanos
ggplot(df_cercanos, aes(x = year, y = happiness_score, color = country, group = country)) +
  geom_line(linewidth = 1) +
  labs(title = "Evolución en Países Cercanos a España", 
       x = "Año", y = "Happiness Score") +
  scale_x_continuous(breaks = unique(df_espana$year)) +
  theme_minimal()
```

La @fig-felicidad-espana-paises muestra la evolución de la felicidad en España en comparación con sus países vecinos. Lo primero que podemos observar es que España se sitúa en el rango medio-bajo del grupo, por encima únicamente de Portugal y, ocasionalmente, de Italia. Países como Suiza, Alemania y Reino Unido poseen holgadamente puntuaciones más altas (sobre todo Suiza), lo cual podría estar vinculado a mayores niveles de riqueza y estabilidad institucional.

Si analizamos la evolución de la felicidad, vemos que a partir de 2021 se produce un descenso claro en los países con niveles más altos de felicidad como Suiza o Alemania, mientras que Portugal sufre una gran subida y el resto de países se mantiene constante. Esto puede deberse a que ha habido una serie de factores, como ciertas tensiones geopolíticas, que han hecho afectado de manera directa a la felicidad de la población de muchos países.

```{r echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-variables-espana
#| echo: false
#| warning: false
#| fig-cap: "Evolución del PIB en España y sus países cercanos."
#| fig-width: 6
#| fig-height: 2
# Evolución del PIB (GDP per capita)
ggplot(df_cercanos, aes(x = year, y = gdp, color = country, group = country)) +
  geom_line(linewidth = 1) +
  labs(title = "Evolución en Países Cercanos a España", 
       x = "Año", y = "PIB per cápita") +
  scale_x_continuous(breaks = unique(df_espana$year)) +
  theme_minimal() +
  theme(
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 8)
  )


```

```{r echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-variables-espana2
#| echo: false
#| warning: false
#| fig-cap: "Evolución del apoyo social en España y sus países cercanos."
#| fig-width: 6
#| fig-height: 2


# Evolución del apoyo social
ggplot(df_cercanos, aes(x = year, y = support, color = country, group = country)) +
  geom_line(linewidth = 1) +
  labs(title = "Evolución en Países Cercanos a España", 
       x = "Año", y = "Apoyo Social") +
  scale_x_continuous(breaks = unique(df_espana$year)) +
  theme_minimal() +
  theme(
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 8)
  )



```

```{r echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-variables-espana3
#| echo: false
#| warning: false
#| fig-cap: "Evolución de la libertad en la toma de decisiones en España y sus países cercanos."
#| fig-width: 6
#| fig-height: 2

# Evolución de la libertad en la toma de decisiones
ggplot(df_cercanos, aes(x = year, y = freedom, color = country, group = country)) +
  geom_line(linewidth = 1) +
  labs(title = "Evolución en Países Cercanos a España", 
       x = "Año", y = "Libertad") +
  scale_x_continuous(breaks = unique(df_espana$year)) +
  theme_minimal() +
  theme(
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 8)
  )

```

Los gráficos presentados en las @fig-variables-espana, @fig-variables-espana2 y @fig-variables-espana3 permiten analizar la evolución de distintos factores que pueden haber afectado al bienestar y la calidad de vida de estos países.

En la @fig-variables-espana, que muestra la evolución del PIB per cápita, se observa una fuerte caída en 2017, seguida por una recuperación progresiva desde 2018; la cual, como indiqué antes, puede deberse a una recodificación o mala recopilación de datos. En cualquier caso, destaca que Suiza mantiene sistemáticamente el mayor PIB per cápita, situándose de manera notoria por encima del resto del grupo. Le sigue Alemania, con valores elevados y estables, y un poco por debajo se encuentran Reino Unido y Francia. España se encuentra en la parte baja del grupo, sólo por encima de Portugal, aunque todos muestran una tendencia ascendente que refleja prosperidad económica.

En la @fig-variables-espana2, relativo al apoyo social, se aprecia un comportamiento mucho menos constante. En 2018 hay una caída muy pronunciada en todos los países, especialmente en España, Italia y Portugal, lo cual puede deberse a una percepción negativa del entorno social como ocurrió en España debido a los casos de corrupción; o, al igual que con el PIB, a una recodificación de los datos. En 2019 se produce un repunte, y en los años siguientes se producen ciertas oscilaciones en la gran mayoría de países; destacando a España y Alemania como los países más constantes. No obstante, los cambios que se producen en el apoyo social no son comparables a los que se producen en la @fig-variables-espana ya que no tienen la misma magnitud, y por lo general siempre tienen puntuaciones bastante altas.

La @fig-variables-espana3 muestra la evolución de la libertad para tomar decisiones, la cual muestra valores mucho más dispares que la @fig-variables-espana2. Aquí destaca el caso de Suiza, que mantiene los valores de libertad más altos durante todo el período, y el de Portugal, que sufre un gran ascenso que lo coloca en la parte más alta. España parte de un nivel más bajo en 2015 y experimenta una caída hasta 2019, seguida de una recuperación constante a partir de ese momento manteniéndose en la parte baja de la tabla. Italia, pese a ser el países con puntuación más baja, muestra una evolución ascendente sostenida, sobre todo a partir de 2019. Esta variable presenta una mejora generalizada en la región, manifestando ciertos avances en la percepción de libertad individual.

A través de estas figuras podemos sacar varias conclusiones. En primer lugar, España tiende a situarse en posiciones relativamente bajas dentro del grupo de comparación, aunque muestra señales de mejora especialmente en PIB y libertad individual. Por otro lado, países como Suiza y Alemania destacan por sus buenos resultados en todos los ámbitos, lo cual explica por qué son los países con mayor puntuación de felicidad. Esta comparación demuestra que el análisis de medidas repetidas nos permite comprender mejor los factores que condicionan la evolución de la felicidad en países cercanos pero diferentes en muchos ámbitos.

En resumen, en este capítulo se ha realizado un análisis exploratorio exhaustivo de la base de datos utilizada, enfocándonos en la evolución temporal y variabilidad geográfica del índice de felicidad, así como su asociación a diferentes variables políticas, sociales y económicas. A través de herramientas visuales y comparaciones entre diferentes países, hemos reconocido ciertas tendencias relevantes en la representación de la felicidad. No obstante, todo lo hecho hasta ahora supone una fase meramente descriptiva del análisis. A partir del siguiente capítulo, daremos un paso más allá para intentar explicar el comportamiento del índice de felicidad, construyendo modelos estadísticos que nos ayuden a determinar qué variables influyen de forma significativa en su evolución y cómo interactúan entre sí.