---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r include=FALSE, warning=FALSE}
library(readr)
library(readxl)
library(janitor)
library(mice)
library(visdat)
library(outliers)
library(plotly)
library(tidyverse)
library(webshot2)
library(lmtest)      # Para bptest() y dwtest()
library(tseries)     # Para jarque.bera.test()
library(ggfortify)   # Para autoplot() del modelo
library(patchwork)
```


# Análisis de la base de datos

```{r message=FALSE, warning=FALSE, include=FALSE}
library(ggplot2)
knitr::opts_chunk$set(
  fig.width = 6, 
  fig.height = 4, 
  dev = "png",
  fig.align = "center"
)
theme_set(theme_minimal(base_size = 12))
```


El conjunto de datos World Happiness 2015-2024 recopila información sobre la felicidad percibida en diferentes países a lo largo de los años. Este dataset proviene de los informes anuales de felicidad publicados por la Red de Soluciones para el Desarrollo Sostenible de la ONU, los cuales se basan en encuestas realizadas a nivel mundial. El dataset tiene una buena cobertura temporal, ya que abarca datos de 2015 a 2024 y permite analizar tendencias a lo largo del tiempo, pero también geográfica, dado que icluye información de diferentes países y regiones del mundo. Este dataset es ampliamente utilizado en estudios de bienestar, calidad de vida y políticas públicas, y contiene métricas económicas y sociales que permiten un análisis estadístico y comparativo. Cada fila del dataset representa un país en un año determinado y contiene variables socioeconómicas y de bienestar que pueden influir en la percepción de felicidad de su población. Estas variables son:

-   Country: Nombre del país.

-   Region: Continente o agrupación geográfica del país.

-   Happiness Score: Puntuación de felicidad promedio en el país (escala de 0 a 10).

-   GDP per capita: Producto Interno Bruto per cápita ajustado por poder adquisitivo.

-   Social Support: Medida de apoyo social basado en la percepción de las personas sobre la ayuda que pueden recibir de familiares y amigos.

-   Healthy Life Expectancy: Esperanza de vida saludable en años.

-   Freedom to Make Life Choices: Libertad para tomar decisiones personales, según encuestas de percepción.

-   Generosity: Nivel de generosidad en la sociedad, basado en donaciones y ayuda a otros.

-   Perceptions of Corruption: Nivel de percepción de corrupción en el gobierno y los negocios. 

## Análisis exploratorio inicial
```{r warning=FALSE, include=FALSE}
# Carga de paquetes 
library(readr)
library(readxl)
library(janitor)
library(mice)
library(visdat)
library(outliers)
library(plotly)
library(tidyverse)
library(webshot2)

# Cargamos los datos 
df_original <- read_delim("world_happiness_combined.csv", delim = ";", show_col_types = FALSE)
# Limpiar nombres de columnas
df_original <- clean_names(df_original)
summary(df_original)
str(df_original)
# Hay algunas variables numérias que están puestas como categóricas
df_original <- df_original %>%
  mutate(
    gdp_per_capita = as.numeric(gsub(",", ".", gdp_per_capita)),
    social_support = as.numeric(gsub(",", ".", social_support)),
    freedom_to_make_life_choices = as.numeric(gsub(",", ".", freedom_to_make_life_choices)),
    generosity = as.numeric(gsub(",", ".", generosity)),
    perceptions_of_corruption = as.numeric(gsub(",", ".", perceptions_of_corruption))
  )
# Verificar que ahora sean numéricas
str(df_original)
# Hay un problema con las comas en el happiness score
df_original$happiness_score <- df_original$happiness_score / 100000
# Datos faltantes
is.na(df_original)
# En la base de datos no hay ningún dato faltante

# Detección de Outliers
boxplot(df_original$happiness_score)
boxplot(df_original$gdp_per_capita)
boxplot(df_original$social_support)  
boxplot(df_original$healthy_life_expectancy)
boxplot(df_original$freedom_to_make_life_choices)
boxplot(df_original$generosity)
boxplot(df_original$perceptions_of_corruption)
# Como podemos apreciar gráficamente, hay algunas variables numéricas en las que puede haber valores atípicos
outliers::grubbs.test(df_original$happiness_score)
outliers::grubbs.test(df_original$gdp_per_capita)
outliers::grubbs.test(df_original$social_support)
outliers::grubbs.test(df_original$healthy_life_expectancy)
outliers::grubbs.test(df_original$freedom_to_make_life_choices)
outliers::grubbs.test(df_original$generosity)
outliers::grubbs.test(df_original$perceptions_of_corruption)
# Como el p-valor es > alpha en todos los test, no tenemos outliers
df_original <- df_original %>%
  rename(
    gdp = gdp_per_capita,
    support = social_support,
    life_exp = healthy_life_expectancy,
    freedom = freedom_to_make_life_choices,
    generosity = generosity,
    corruption = perceptions_of_corruption
  )
```

```{r}
#| label: fig-variables-happiness
#| echo: false
#| warning: false
#| fig-cap: "Distribución de las variables de la base de datos World Happiness"
library(ggplot2)
library(dplyr)
library(tidyr)
library(patchwork)

# Reestructurar para ggplot
df_box <- df_original %>%
  select(happiness_score, gdp, support, life_exp, freedom, generosity, corruption)

df_box_long <- df_box %>%
  pivot_longer(cols = everything(), names_to = "variable", values_to = "valor")

# Subconjuntos
df_box_gdp_happy <- df_box_long %>% filter(variable %in% c("gdp", "happiness_score"))
df_box_lifeexp <- df_box_long %>% filter(variable == "life_exp")
df_box_01 <- df_box_long %>% filter(variable %in% c("support", "freedom", "generosity", "corruption"))

# Gráfico 1
ggplot(df_box_01, aes(x = variable, y = valor, fill = variable)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Variables con valores entre 0 y 1",
       x = "Variable", y = "Valor") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

```

```{r}
#| label: fig-variables-happiness2
#| echo: false
#| warning: false
#| fig-cap: "Distribución de las variables de la base de datos World Happiness"
library(ggplot2)
library(dplyr)
library(tidyr)
library(patchwork)

# Gráfico 2: life_exp
g2 <- ggplot(df_box_lifeexp, aes(x = variable, y = valor, fill = variable)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Esperanza de vida",
       x = "Variable", y = "Valor") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

# Gráfico 3: gdp y happiness_score
g3 <- ggplot(df_box_gdp_happy, aes(x = variable, y = valor, fill = variable)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "GDP y Happiness Score",
       x = "Variable", y = "Valor") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

# Mostrar gráfico 2 y 3 en la misma fila
(g2 + g3) + 
  plot_layout(ncol = 2) + 
  plot_annotation(title = NULL)

```

Hemos comenzado el análisis de la base de datos, la cual no cuenta con datos faltantes. De la misma manera, estos gráficos de la @fig-variables-happiness y @fig-variables-happiness2 nos muestran la distribución de las diferentes variables, en la que se aprecian que tampoco hay valores atípicos. Explorando opciones para enriquecer la base de datos y, potencialmente, poder construir un modelo más informativo, se han estudiado diversas opciones y se ha decidido integrar información de dos fuentes externas que aportan indicadores políticos y de libertades civiles en los países. Estas bases de datos nos permitirán explorar hasta qué punto la democracia, los derechos políticos y las libertades influyen en la percepción de felicidad de las sociedades.

La primera base de datos que hemos considerado es "Freedom in the World" [@freedomhouse], un informe anual de la organización Freedom House, que evalúa el estado de las libertades políticas y civiles en el mundo. Cada país es clasificado en función de indicadores de democracia, libertades individuales y derechos políticos. El motivo por el que hemos elegido esta base de datos es porque los estudios en ciencias sociales han mostrado que la percepción de felicidad no solo está ligada a factores económicos, sino también a la capacidad de los ciudadanos para expresarse libremente, participar en la política y vivir sin restricciones autoritarias. Incorporar estos datos nos permitirá ver si existe una correlación entre los niveles de libertad y la felicidad percibida en cada país. Como esta base de datos cuenta con una gran cantidad de variables, hemos elegido las siguientes variables de interés:

-   Country/Territory: Identificación del país o territorio.
-   Region: Indica la zona geográfica del país, similar al regional_indicator del dataset original.
-   c/T: Diferencia entre países y territorios, aunque este concepto puede ser delicado según el análisis.
-   Edition: Año del reporte, fundamental para el análisis longitudinal.
-   Status: Clasificación del país en cuanto a su libertad: Libre (F), Parcialmente Libre (PF) o No Libre (NF).
-   PR rating (Political Rights): Puntuación de 1 a 7 sobre derechos políticos.
-   CL rating (Civil Liberties): Puntuación de 1 a 7 sobre libertades civiles.

La otra base de datos que hemos elegido para nuestro análisis es "Democracy Data", un dataset que proviene del proyecto TidyTuesday y está basado en estudios académicos sobre democracia y regímenes políticos. Clasifica los países según su sistema de gobierno y proporciona información detallada sobre su historia política. Una de las características que tiene esta base de datos es que tiene datos hasta 2020, por lo que tenemos que considerar que, si vamos a trabajar con ella, tendremos las características completas de las observaciones en un período reducido. Dado que la felicidad no solo depende de factores económicos, sino también de la estabilidad política y la gobernanza, estas variables pueden ayudarnos a explicar por qué algunos países presentan niveles bajos de felicidad a pesar de tener una economía sólida. Al igual que en el caso anterior, como esta base de datos contiene más de 40 variables, hemos decidido quedarnos con aquellas que pensamos que mejor se adaptan a nuestro análisis. Estas variables son:

-   country_name: Nombre del país.
-   year: Año de observación.
-   regime_category: Clasificación del sistema de gobierno (democracia parlamentaria, autocracia civil, dictadura militar, monarquía, etc.).
-   is_monarchy: Indica si el país es una monarquía.
-   is_democracy: Indica si el país es una democracia.
-   is_presidential: Indica si el sistema es presidencialista.
-   is_colony: Identifica si el país sigue siendo una colonia.
-   is_communist: Indica si el país sigue un régimen comunista.
-   spatial_democracy: Evalúa el nivel de democracia en los países vecinos.
-   has_full_suffrage: Indica si hay sufragio universal.
-   electoral_category: Tipo de elecciones (no democráticas, de partido único, multipartidistas no democráticas o democráticas).
-   spatial_electoral: Evalúa la calidad electoral de los países vecinos.
-   has_free_and_fair_election: Indica si las elecciones son libres y justas.
-   has_alternation: Indica si existe alternancia en el poder.

Agregando estos datasets consideramos que se puede abarcar de forma bastante completa los diferentes factores que afectan a la percepción de la felicidad. Esto nos permitirá realizar un análisis más profundo y responder preguntas sobre la relación entre política, democracia y bienestar subjetivo en distintos países.

```{r include=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(stringr)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(htmlwidgets)
## FREEDOM IN THE WORLD
freedom_todos <- read_excel("All_data_FIW_2013-2024 (1).xlsx", sheet = "FIW13-25", skip = 1)
### Las variables que nos pueden llegar a interesar son:
#### Country/Territory (necesitamos el país/territorio)
#### Region (aunque sea muy parecida a la de regional_indicator, nos puede ser de utilidad)
#### c/T (indica si es país o territorio, aunque no se si deberíamos de meternos con el concepto de soberanía)
#### Edition (necesitamos el año)
#### Status (clasifica la libertad del país)
#### PR (derechos políticos) rating y CL (libertades civiles) rating (la otra opción sería elegir PR, CL y Total porque el rating va de 1 a 7)
freedom_final <- freedom_todos %>%
  select(
    `Country/Territory`, # Nombre del país o territorio
    `Region`,            # Región geográfica
    `C/T`,               # Indica si es país (c) o territorio (t)
    `Edition`,           # Año de edición de los datos
    `Status`,            # Clasificación de libertad (Libre, Parcialmente Libre, No Libre)
    `PR rating`,         # Puntuación de derechos políticos (1-7)
    `CL rating`          # Puntuación de libertades civiles (1-7)
  ) %>%
  rename(
    country = `Country/Territory`,
    region = `Region`,
    country_or_territory = `C/T`,
    year = `Edition`,
    status = `Status`,
    political_rights = `PR rating`,
    civil_liberties = `CL rating`
  )
freedom_final <- freedom_final %>%
  filter(year >= 2015 & year <= 2024)
## DEMOCRACY DATA ==> DEMOCRACY AND DICTATORSHIP
library(democracyData)
democracy_data <-
  democracyData::pacl_update |> 
  janitor::clean_names() |> 
  dplyr::select(
    "country_name" = "pacl_update_country",
    "country_code" = "pacl_update_country_isocode",
    "year",
    "regime_category_index" = "dd_regime",
    "regime_category" = "dd_category",
    "is_monarchy" = "monarchy",
    "is_commonwealth" = "commonwealth",
    "monarch_name",
    "monarch_accession_year" = "monarch_accession",
    "monarch_birthyear",
    "is_female_monarch" = "female_monarch",
    "is_democracy" = "democracy",
    "is_presidential" = "presidential",
    "president_name",
    "president_accesion_year" = "president_accesion",
    "president_birthyear",
    "is_interim_phase" = "interim_phase",
    "is_female_president" = "female_president",
    "is_colony" = "colony",
    "colony_of",
    "colony_administrated_by",
    "is_communist" = "communist",
    "has_regime_change_lag" = "regime_change_lag",
    "spatial_democracy",
    "parliament_chambers" = "no_of_chambers_in_parliament",
    "has_proportional_voting" = "proportional_voting",
    "election_system",
    "lower_house_members" = "no_of_members_in_lower_house",
    "upper_house_members" = "no_of_members_in_upper_house",
    "third_house_members" = "no_of_members_in_third_house",
    "has_new_constitution" = "new_constitution",
    "has_full_suffrage" = "fullsuffrage",
    "suffrage_restriction",
    "electoral_category_index" = "electoral",
    "spatial_electoral",
    "has_alternation" = "alternation",
    "is_multiparty" = "multiparty",
    "has_free_and_fair_election" = "free_and_fair_election",
    "parliamentary_election_year",
    "election_month" = "election_month_year",
    "has_postponed_election" = "postponed_election"
  ) |>
  dplyr::mutate(
    election_month = dplyr::na_if(.data$election_month, "?")
  ) |> 
  tidyr::separate_wider_regex(
    "election_month",
    patterns = c(
      election_month = "\\D+",
      election_year = "\\d{4}$"
    ),
    too_few = "align_start"
  ) |> 
  dplyr::mutate(
    electoral_category = dplyr::case_match(
      .data$electoral_category_index,
      0 ~ "no elections",
      1 ~ "single-party elections",
      2 ~ "non-democratic multi-party elections",
      3 ~ "democratic elections"
    ),
    .after = "electoral_category_index"
  ) |> 
  dplyr::mutate(
    election_month = stringr::str_squish(.data$election_month),
    dplyr::across(
      c(
        tidyselect::ends_with("_index"),
        tidyselect::contains("year"),
        tidyselect::ends_with("_members"),
        "parliament_chambers"
      ),
      as.integer
    ),
    dplyr::across(
      c(
        tidyselect::starts_with("is_"),
        tidyselect::starts_with("has_")
      ),
      as.logical
    )
  )
### Las variables que nos pueden llegar a interesar son:
#### country_name (necesitamos el país/territorio)
#### year (año)
#### regime_category (Parliamentary democracies, Mixed democracies (with weak presidents), Presidential democracies, Civilian autocracies, Military dictatorships, Royal dictatorships)
#### is_monarchy (es monarquía o no)
#### is_democracia (es democracia o no)
#### is_presidential (es presidencial o no)
#### is_colony (es colonia o no)
#### is_communist (es comunista o no)
#### spatial_democracy (como de democráticos son sus países vecinos) 
#### has_full_suffrage (tiene sufragio universal o no)
#### electoral_category (No elections, Single-party elections, non-democratic multi-party elections, democratic elections)
#### spatial_electoral (cómo son las elecciones en sus países vecinos)
#### has_free_and_fair_election (tienen elecciones justas o no)
#### has_alternation (cambian de gobierno o no)
democracy_final <- democracy_data %>%
  select(
    country_name, 
    year, 
    regime_category, 
    is_monarchy, 
    is_democracy, 
    is_presidential, 
    is_colony, 
    is_communist, 
    spatial_democracy, 
    has_full_suffrage, 
    electoral_category, 
    spatial_electoral, 
    has_free_and_fair_election, 
    has_alternation
  ) %>%
  rename(
    monarchy = is_monarchy,
    democracy = is_democracy,
    presidential = is_presidential,
    colony = is_colony,
    communist = is_communist,
    sp_democracy = spatial_democracy,
    suffrage = has_full_suffrage,
    sp_electoral = spatial_electoral,
    fair_election = has_free_and_fair_election,
    alternation = has_alternation
  )
democracy_final <- democracy_final %>%
  filter(year >= 2015 & year <= 2024)
## UNIÓN DE LOS DATASETS
colnames(df_original)
colnames(democracy_final)
colnames(freedom_final)
# Renombrar la columna 'country_name' en democracy_final para que coincida con df_original
democracy_final <- democracy_final %>%
  rename(country = country_name)
# Ver los países en cada dataset para ver si hay alguna diferencia en la nomenclatura
unique(df_original$country)
unique(democracy_final$country)
unique(freedom_final$country)

setdiff(df_original$country, democracy_final$country)
setdiff(democracy_final$country, df_original$country)
setdiff(df_original$country, freedom_final$country)
setdiff(freedom_final$country, df_original$country)
# Corrección de nombres 
df_original <- df_original %>%
  mutate(country = case_when(
    country == "Trinidad & Tobago" ~ "Trinidad and Tobago",
    country == "Somaliland region" ~ "Somaliland",
    country == "Macedonia" ~ "North Macedonia",
    country == "Palestinian Territories" ~ "State of Palestine",
    country == "Congo" ~ "Congo (Kinshasa)",
    country == "Taiwan Province of China" ~ "Taiwan",
    country == "Hong Kong S.A.R. of China" ~ "Hong Kong",
    country == "Czechia" ~ "Czech Republic",
    country == "Turkiye" ~ "Turkey",
    country == "Argelia" ~ "Algeria",
    country == "Eswatini" ~ "Swaziland",
    TRUE ~ country
  ))
democracy_final <- democracy_final %>%
  mutate(country = case_when(
    country == "Slovak Republic" ~ "Slovakia",
    country == "Korea, Republic of" ~ "South Korea",
    country == "Trinidad &Tobago" ~ "Trinidad and Tobago",
    country == "Congo, Dem. Rep." ~ "Congo (Kinshasa)",
    country == "Congo, Republic of" ~ "Congo (Brazzaville)",
    country == "Gambia, The" ~ "Gambia",
    country == "Côte d`Ivoire" ~ "Ivory Coast",
    TRUE ~ country
  ))
freedom_final <- freedom_final %>%
  mutate(country = case_when(
    country == "Northern Cyprus" ~ "North Cyprus",
    country == "The Gambia" ~ "Gambia",
    country == "Cote d'Ivoire" ~ "Ivory Coast",
    country == "Eswatini" ~ "Swaziland",
    TRUE ~ country
  ))

# PRIMER DATAFRAME: df_completo (2015-2020, con todas las variables)
df_completo <- df_original %>%
  left_join(democracy_final, by = c("country", "year")) %>%
  left_join(freedom_final, by = c("country", "year")) %>%
  filter(year >= 2015 & year <= 2020)  # Filtrar solo hasta 2020

# SEGUNDO DATAFRAME: df_sin_democracia (2015-2024, sin democracy_final)
df_sin_democracia <- df_original %>%
  left_join(freedom_final, by = c("country", "year")) %>%
  filter(year >= 2015 & year <= 2024)  # Mantener toda la información de felicidad y libertad

summary(df_completo)
summary(df_sin_democracia)

na_presence_completo <- df_completo %>%
  summarise(across(everything(), ~ any(is.na(.)), .names = "NA_{.col}"))

na_presence_sin_democracia <- df_sin_democracia %>%
  summarise(across(everything(), ~ any(is.na(.)), .names = "NA_{.col}"))

# OPCIÓN 1: ELIMINAR LOS NA
df_completo_sin_na <- df_completo %>% drop_na()
df_sin_democracia_sin_na <- df_sin_democracia %>% drop_na()

# OPCIÓN 2: SUSTITUIR LOS NA
# VARIABLES NUMÉRICAS
df_completo_numeric <- df_completo %>%
  select_if(is.numeric)
df_sin_democracia_numeric <- df_sin_democracia %>%
  select_if(is.numeric)
imputacion_completo <- mice(df_completo_numeric, method = "pmm", m = 5, maxit = 50, seed = 123)
df_completo_pmm <- complete(imputacion_completo)
imputacion_sin_democracia <- mice(df_sin_democracia_numeric, method = "pmm", m = 5, maxit = 50, seed = 123)
df_sin_democracia_pmm <- complete(imputacion_sin_democracia)
df_completo_pmm <- bind_cols(df_completo %>% select(-colnames(df_completo_numeric)), df_completo_pmm)
df_sin_democracia_pmm <- bind_cols(df_sin_democracia %>% select(-colnames(df_sin_democracia_numeric)), df_sin_democracia_pmm)
# VARIABLES CATEGÓRICAS
md.pattern(df_completo_pmm)
vis_miss(df_completo_pmm, sort_miss=TRUE)
na_presence_completo_pmm <- df_completo_pmm %>%
  summarise(across(everything(), ~ any(is.na(.)), .names = "NA_{.col}"))
df_completo_pmm <- df_completo_pmm %>%
  mutate(
    regional_indicator = case_when(
      country == "Greece" ~ "Western Europe",
      country == "Cyprus" ~ "Western Europe",
      country == "Gambia" ~ "Sub-Saharan Africa",
      TRUE ~ regional_indicator
    ),
    colony = ifelse(country == "Libya", FALSE, colony)
  ) %>%
  filter(!country %in% c("North Cyprus", "Kosovo", "Somaliland", "State of Palestine"))


md.pattern(df_sin_democracia_pmm)
vis_miss(df_sin_democracia_pmm, sort_miss=TRUE)
na_presence_sin_democracia_pmm <- df_sin_democracia_pmm %>%
  summarise(across(everything(), ~ any(is.na(.)), .names = "NA_{.col}"))
df_sin_democracia_pmm <- df_sin_democracia_pmm %>%
  mutate(
    regional_indicator = case_when(
      country == "Greece" ~ "Western Europe",
      country == "Cyprus" ~ "Western Europe",
      country == "Gambia" ~ "Sub-Saharan Africa",
      TRUE ~ regional_indicator
    ),
  ) %>%
  filter(!country %in% c("State of Palestine"))
# Eliminar territorios
df_sin_democracia_sin_na <- df_sin_democracia_sin_na %>%
  filter(tolower(country_or_territory) == "c") %>%  # Solo países

  # Eliminar la variable 'country_or_territory'
  select(-country_or_territory)
```

```{r include=FALSE, message=FALSE, warning=FALSE}
# Variables políticas que queremos analizar
variables_politicas <- c("regime_category", "monarchy", "democracy", 
                         "presidential", "colony", "communist", 
                         "suffrage", "electoral_category", 
                         "fair_election", "alternation")

# Verificar cambios a lo largo del tiempo
cambios_variables <- df_completo %>%
  select(country, year, all_of(variables_politicas)) %>%
  group_by(country) %>%
  summarise(across(all_of(variables_politicas), ~ n_distinct(.x, na.rm = TRUE))) %>%
  pivot_longer(-country, names_to = "variable", values_to = "distinct_values") %>%
  filter(distinct_values > 1)

# Mostrar los países y variables que cambian a lo largo del tiempo
print(cambios_variables)
```

## Análisis de las bases de datos complementarias

Al trabajar con datos longitudinales a nivel país, surge una cuestión clave: ¿en qué medida las características políticas de cada país se mantienen estables o experimentan cambios relevantes a lo largo del tiempo? En este estudio, incorporamos información de las bases de datos Freedom in the World y Democracy Data, que permiten capturar distintos aspectos del contexto político de los países, como el tipo de régimen, la alternancia en el poder o la existencia de elecciones libres.

Sin embargo, nos encontramos con dos limitaciones importantes. En primer lugar, muchas de estas variables presentan una cobertura temporal limitada, con registros ausentes en varios años dentro del periodo 2015–2023. En segundo lugar, se trata de variables que tienden a ser bastante estables: en la mayoría de los países analizados no se observan cambios relevantes a lo largo del tiempo. Estas circunstancias dificultan su tratamiento como verdaderas variables longitudinales.

Por ello, optamos por incorporar estas variables como una "foto fija" del contexto político, extrayendo su valor más representativo del periodo estudiado. De esta forma, las utilizamos como covariables fijas en los modelos de felicidad, contribuyendo a enriquecer el análisis sin introducir sesgos derivados de valores faltantes o variaciones mínimas que podrían ser ruido.

No obstante, existen excepciones interesantes. Algunos países sí han experimentado cambios significativos en su sistema político, su forma de gobierno o su nivel de democracia. En la siguiente sección se representa gráficamente la evolución de dichas variables para estos casos específicos, con el objetivo de ilustrar de forma visual estos procesos de cambio.

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.width=12, fig.height=8}
#| label: fig-variables-binarias
#| echo: false
#| warning: false
#| fig-cap: "Evolución temporal de las variables políticas binarias de la base de datos Democracy Data"
# Definir las variables binarias si no están previamente definidas
variables_binarias <- c("alternation", "fair_election", "democracy")

# Definir los países de interés
paises_con_cambios <- c("Comoros", "Congo (Kinshasa)", "Madagascar", "Nicaragua", "Turkey", "Venezuela",
                        "Angola", "Bolivia", "Liberia", "Honduras", "Hungary", "Kenya")

# Opcional: destacar un subconjunto de países para visualizar
paises_destacados <- paises_con_cambios

# Preparar los datos
df_binarias_segmentos <- df_completo %>%
  filter(country %in% paises_con_cambios) %>%
  mutate(across(all_of(variables_binarias), as.character)) %>%
  select(country, year, all_of(variables_binarias)) %>%
  pivot_longer(cols = -c(country, year), names_to = "variable", values_to = "valor") %>%
  group_by(country, variable) %>%
  arrange(year, .by_group = TRUE) %>%
  mutate(
    valor_num = ifelse(valor %in% c("TRUE", "yes"), 1, 0),
    year_next = lead(year),
    valor_next = lead(valor),
    valor_next_num = ifelse(valor_next %in% c("TRUE", "yes"), 1, 0),
    tipo_cambio = case_when(
      is.na(valor_next) ~ NA_character_,
      valor_num == valor_next_num ~ "sin cambio",
      valor_num == 0 & valor_next_num == 1 ~ "avance",
      valor_num == 1 & valor_next_num == 0 ~ "retroceso"
    )
  ) %>%
  filter(!is.na(tipo_cambio)) %>%
  ungroup()

# Filtrado para países destacados
df_binarias_filtrado <- df_binarias_segmentos %>%
  filter(country %in% paises_destacados)

# Gráfico final
ggplot(df_binarias_filtrado, aes(x = year, xend = year_next,
                                 y = valor_num, yend = valor_next_num,
                                 color = tipo_cambio)) +
  geom_segment(linewidth = 1) +
  facet_grid(country ~ variable) +
  scale_color_manual(values = c("avance" = "forestgreen",
                                "retroceso" = "firebrick",
                                "sin cambio" = "gray70")) +
  scale_y_continuous(breaks = c(0, 1), labels = c("FALSE", "TRUE")) +
  theme_minimal() +
  labs(title = "Evolución de variables políticas binarias por país",
       x = "Año", y = "Valor", color = "Tipo de cambio") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text.y = element_text(angle = 0))


```

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.width=12, fig.height=8}
#| label: fig-regime-electoral
#| echo: false
#| warning: false
#| fig-cap: "Evolución del cambio de régimen democrático en países desde 2015 a 2020"
library(dplyr)
library(ggplot2)
library(tidyr)

# Lista base de países con posibles cambios
paises_cambio <- c("Bolivia", "Burkina Faso", "Burundi", "Comoros",
                   "Egypt", "Honduras", "Hungary", "Iraq", "Kenya",
                   "Laos", "Liberia", "Myanmar", "Nicaragua", "Turkey",
                   "Venezuela", "Yemen", "Zimbabwe")

# Preparamos los datos
df_categoricas <- df_completo %>%
  filter(country %in% paises_cambio) %>%
  select(country, year, regime_category, electoral_category) %>%
  mutate(across(c(regime_category, electoral_category), as.character)) %>%
  pivot_longer(cols = c(regime_category, electoral_category),
               names_to = "variable", values_to = "valor")

# 1. Gráfico para regime_category (quitamos Egipto)
df_regime <- df_categoricas %>%
  filter(variable == "regime_category", country != "Egypt")

ggplot(df_regime, aes(x = year, y = valor, group = country, color = valor)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  facet_wrap(~ country, scales = "free_y") +
  theme_minimal() +
  labs(title = "Evolución de regime_category por país",
       x = "Año", y = "Categoría de régimen", color = "Valor") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 9),
    legend.position = "bottom"
  )

```

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.width=12, fig.height=8}
#| label: fig-electoral
#| echo: false
#| warning: false
#| fig-cap: "Evolución del cambio de categoría electoral en países desde 2015 a 2020"
library(dplyr)
library(ggplot2)
library(tidyr)

# 2. Gráfico para electoral_category (quitamos los países indicados)
excluir_electoral <- c("Burkina Faso", "Burundi", "Hungary", "Iraq", "Laos", "Myanmar", "Yemen", "Zimbabwe")

df_electoral <- df_categoricas %>%
  filter(variable == "electoral_category", !country %in% excluir_electoral)

ggplot(df_electoral, aes(x = year, y = valor, group = country, color = valor)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  facet_wrap(~ country, scales = "free_y") +
  theme_minimal() +
  labs(title = "Evolución de electoral_category por país",
       x = "Año", y = "Categoría electoral", color = "Valor") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 9),
    legend.position = "bottom"
  )

```

```{r}
#| label: fig-cambio-variables
#| echo: false
#| warning: false
#| message: false
#| fig-cap: "Análisis de los distintos cambios políticos en países de 2015 a 2020"
library(dplyr)
library(tidyr)
library(ggplot2)

# Subconjunto con países que han tenido al menos un cambio
paises_cambio <- c("Angola", "Bolivia", "Burkina Faso", "Burundi", "Comoros",
                   "Congo (Kinshasa)", "Egypt", "Honduras", "Hungary", "Iraq", "Kenya",
                   "Laos", "Liberia", "Madagascar", "Myanmar", "Nicaragua", "Turkey",
                   "Venezuela", "Yemen", "Zimbabwe")

# Variables categóricas de interés
vars_politicas <- c("regime_category", "democracy", "electoral_category",
                    "fair_election", "alternation")

# Crear df con 1 si hay más de un valor distinto en el tiempo
cambios_pais <- df_completo %>%
  filter(country %in% paises_cambio) %>%
  select(country, year, all_of(vars_politicas)) %>%
  mutate(across(all_of(vars_politicas), as.character)) %>%
  pivot_longer(cols = -c(country, year), names_to = "variable", values_to = "valor") %>%
  distinct() %>%
  group_by(country, variable) %>%
  summarise(cambios = n_distinct(valor), .groups = "drop") %>%
  mutate(cambio = ifelse(cambios > 1, 1, 0)) %>%
  select(-cambios)

# Gráfico tipo heatmap
ggplot(cambios_pais, aes(x = variable, y = country, fill = factor(cambio))) +
  geom_tile(color = "white") +
  scale_fill_manual(values = c("0" = "white", "1" = "#440154"), labels = c("Sin cambio", "Con cambio")) +
  theme_minimal() +
  labs(title = "Cambios en variables políticas por país (2015-2020)",
       x = "Variable política",
       y = "País",
       fill = "Cambio") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

Estos gráficos sobre la evolución de diferentes variables políticas muestran de forma clara y visual la evolución temporal de varios países que han experimentado cambios entre 2015 y 2020.

Si observamos los cambios en el tipo de elecciones en la @fig-electoral, podemos ver que Venezuela presentó hasta 3 categorías distintas: pasó de elecciones democráticas a elecciones no democráticas multi-partido y luego a no tener elecciones directamente, reflejando el colapso progresivo del sistema electoral bajo el régimen de Maduro. Otros países como Honduras o Comoras alternan entre elecciones democráticas y elecciones no democráticas multi-partido, reflejando cuestionamientos sobre la transparencia y legitimidad de sus procesos electorales y evidenciando las dificultades para establecer un sistema electoral pluralista. En el caso de Honduras a partir de 2018, lo que coincide con la reelección altamente cuestionada de Juan Orlando Hernández, rodeada de denuncias de fraude y represión; mientras que Comoras en 2019, tras una serie de reformas constitucionales que favorecieron la consolidación del poder del presidente Azali Assoumani.

En cuanto a los cambios en la alternancia en el poder, los cuales podemos apreciar en la @fig-variables-binarias, vemos cómo en Nicaragua y Venezuela esta variable refleja la falta de alternancia, mostrando un patrón de concentración del poder ya que en años anteriores había alternancia, pero se pierde conforme los gobiernos se consolidan en el poder.

Siguiendo este mismo gráfico, podemos observar los cambios en la existencia de elecciones libres y justas, en los que vemos que Angola y Liberia reflejan mejoras en sus procesos electorales con la celebración de elecciones que fueron más competitivas y abiertas que en años anteriores; pero hay otros casos como Bolivia, que presenta un cambio negativo en 2019, año marcado por acusaciones de fraude electoral que desembocaron en la crisis política. Otro ejemplo que se puede destacar es Turquía, que deja de tener elecciones libres y justas en los últimos años, en línea con el creciente autoritarismo del presidente Erdoğan.

Para acabar con el @fig-variables-binarias, observando la condición de democracia, vemos que Nicaragua dejó de ser considerada una democracia a partir de 2017, cuando se intensificó el control autoritario de Daniel Ortega sobre las instituciones y se reprimieron masivamente las protestas. Hungría también dejó de ser considerada democracia a partir de 2019, en consonancia con el cambio de régimen antes mencionado. Otro cambio lo observamos en Bolivia, que fue considerada democracia durante gran parte del período, pero dejó de serlo temporalmente tras la crisis política y la salida de Evo Morales en 2019.

Si observamos la forma de gobierno presidencial en la @fig-cambio-variables, vemos que el único Estado que cambia es China: aunque siempre fue una dictadura de partido único, el dataset refleja un cambio en esta variable posiblemente por una reinterpretación metodológica, ya que a partir de 2019 es considerada presidencial. Es destacable que esta variable apenas presenta cambios (salvo China), lo cual sugiere que la forma de gobierno en términos institucionales es más estable que otras dimensiones como la calidad electoral o la democracia sustantiva. Esto puede ayudar a entender que muchos procesos de regresión democrática no implican reformas estructurales del sistema político, sino más bien una transformación interna de las reglas del juego bajo el mismo marco institucional.

Por último, si observamos los cambios en el tipo de régimen en la @fig-regime-electoral, vemos como Hungría pasó de ser una democracia parlamentaria a una dictadura civil, lo cual refleja el creciente autoritarismo del gobierno de Viktor Orbán y el deterioro de la separación de poderes y la libertad de prensa. Sin embargo, hay casos como Liberia que sucede todo lo contrario: en los primeros años del periodo considerado, Liberia fue clasificada como una dictadura civil, reflejo del mandato de Ellen Johnson Sirleaf, que, aunque existía cierta estructura institucional, no se garantizaban plenamente principios básicos de la democracia como elecciones libres o alternancia real de poder. Sin embargo, a partir de 2018, Liberia pasa a ser clasificada como una democracia presidencial,cambio que coincide con la llegada al poder del exfutbolista George Weah, quien fue elegido democráticamente en un proceso que representó la primera transición pacífica de poder entre dos presidentes electos en el país desde 1944. Esta transición marcó un punto de inflexión político, reflejando una mejora significativa en las instituciones democráticas del país. En Burundi, el cambio en el tipo de régimen refleja el deterioro institucional que siguió a la decisión de Pierre Nkurunziza de presentarse a un tercer mandato en 2015, desatando una grave crisis política. El país pasa a ser clasificado como dictadura civil, reflejando la suspensión de libertades y el cierre del espacio cívico. Este cambio es particularmente relevante porque anticipa un patrón que luego se repite en otros países: el uso del poder electoral como instrumento de legitimación de autoritarismo. Otro caso a destacar es Zimbabwe, ya que es interesante porque, aunque solo presenta un cambio en regime_category, este se produce tras la caída de Robert Mugabe en 2017, una transición que fue vista por algunos sectores como una oportunidad para abrir un nuevo ciclo democrático. Sin embargo, el hecho de que no haya cambios en otras variables como is_democracy o has_free_and_fair_election refleja que el cambio de liderazgo no implicó necesariamente una mejora sustantiva en la calidad del régimen.

Además de los ejemplos más visibles, hay otros países que presentan cambios más sutiles pero igualmente significativos. Por ejemplo, Madagascar muestra una alteración en la variable has_alternation, indicando un momento de alternancia que podría asociarse con las elecciones de 2018, cuando Andry Rajoelina volvió al poder tras haberlo ocupado anteriormente como presidente de transición. Este cambio sugiere un contexto político volátil en el que las alternancias no siempre reflejan procesos plenamente democráticos, sino que pueden estar vinculadas a luchas internas o acuerdos de élites.

Otro caso particular es Comoras, que presenta múltiples cambios en variables como el tipo de elecciones, la democracia y el tipo de régimen. Esto refleja un proceso de consolidación autoritaria que ha sido documentado por organismos internacionales tras la reforma constitucional de 2018 y las elecciones de 2019, en las que se concentró el poder presidencial y se limitó la oposición. Comoras es un ejemplo claro de regresión democrática multidimensional, donde no solo se pierde calidad electoral, sino que se transforman también las estructuras institucionales.

En Kenya, se observan cambios tanto en is_democracy como en electoral_category y regime_category, lo cual es coherente con un contexto de avances y retrocesos en la calidad democrática. A pesar de tener elecciones relativamente regulares, las denuncias de fraude, violencia post-electoral y polarización han afectado la credibilidad del sistema. El dataset parece capturar bien esa inestabilidad institucional, mostrando a Kenya como un país en constante disputa entre aperturas democráticas y tendencias autoritarias.

Este gráfico refuerza la idea de que varios países han experimentado retrocesos democráticos significativos, especialmente en torno a elecciones libres, alternancia y la clasificación del régimen. Además, evidencia que estos cambios no son simultáneos: mientras algunos países cambian en 2016, otros lo hacen en 2018 o 2020, lo cual permite contextualizar los cambios políticos con eventos históricos concretos en cada nación. Este tipo de análisis temporal no solo es útil para identificar patrones políticos, sino también para cruzar estos cambios con la percepción de felicidad de la población y evaluar si existe alguna asociación relevante entre ambas dimensiones.

Dado que uno de los objetivos principales de este análisis es estudiar la evolución de la felicidad y sus determinantes a lo largo del tiempo, necesitamos trabajar con una base de datos que tenga cobertura completa para el periodo 2015–2024. En este sentido, hemos optado por utilizar como base principal la combinación de los datasets World Happiness y Freedom in the World, ya que ofrecen una continuidad temporal adecuada y permiten aplicar técnicas de medidas repetidas para estudiar cómo varían las observaciones de un mismo país a lo largo de varios años.

Por su parte, la base de datos Democracy Data presenta una limitación temporal importante, al contener información solo hasta el año 2020. Además, muchas de sus variables muestran escasa variación a lo largo del tiempo, lo que refuerza la idea de que no se comportan como verdaderas variables longitudinales.

Por ello, en lugar de excluir completamente esta base, la integramos como complemento, utilizándola para construir una fotografía del contexto institucional y político de cada país. Esta fotografía nos resulta especialmente útil a la hora de interpretar fenómenos detectados en el análisis longitudinal, como caídas o aumentos abruptos en el nivel de felicidad. En esos casos, el tipo de régimen, la alternancia en el poder o la existencia de elecciones libres pueden aportar claves importantes para entender estos cambios.

Antes de comenzar con la visualización de la evolución del índice de felicidad, resulta pertinente detenernos brevemente en la base Freedom in the World, que hemos decidido conservar por su cobertura temporal completa y por ofrecer indicadores relevantes sobre libertades civiles y derechos políticos. Aunque sus variables presentan cierta estabilidad en muchos países, hemos identificado diferencias notables en algunos casos que pueden ser útiles para contextualizar cambios observados en la felicidad. Además, no se detectan valores atípicos preocupantes ni problemas graves de calidad en la información, por lo que resulta razonable integrarla en el análisis longitudinal.

Una vez preparado el dataset final, es posible explorar cómo ha evolucionado la variable objetivo —happiness_score— entre 2015 y 2024. Para ello, se recurre a herramientas visuales como mapas o gráficos de línea por región y país, que permiten detectar tanto patrones generales como fluctuaciones específicas en determinados territorios. Estas visualizaciones constituyen el primer acercamiento al análisis longitudinal y ofrecen pistas sobre posibles factores explicativos de los cambios observados.

## Evolución de la felicidad a lo largo del tiempo

Con el objetivo de identificar patrones geográficos en los niveles de felicidad, se emplean mapas coropléticos que permiten visualizar espacialmente la distribución del happiness_score a lo largo del tiempo. Este enfoque facilita detectar agrupaciones regionales, contrastes entre países vecinos y posibles focos de evolución atípica. Al representar la información sobre el territorio, los mapas se convierten en una herramienta clave para complementar el análisis longitudinal y contextualizar las dinámicas regionales de la felicidad.

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
#| label: fig-mapa-mundi
#| echo: false
#| warning: false
#| fig-cap: "Representación de la puntuación global de felicidad en 2024"
library(plotly)
library(dplyr)
library(readr)

# Dataset de Plotly con códigos ISO
df_base <- read.csv('https://raw.githubusercontent.com/plotly/datasets/master/2014_world_gdp_with_codes.csv')

# Leer el CSV local de felicidad
df_felicidad <- df_sin_democracia_sin_na

# Unir datasets por nombre de país
df_mapa1 <- df_base %>%
  left_join(filter(df_felicidad, year == 2024), by = c("COUNTRY" = "country")) %>%
  filter(!is.na(happiness_score))  # Evitar NA en mapa

l <- list(color = toRGB("grey"), width = 0.5)
g <- list(showframe = FALSE, showcoastlines = FALSE, projection = list(type = 'Mercator'))

fig1 <- plot_geo(df_mapa1) %>%
  add_trace(
    z = ~happiness_score, color = ~happiness_score, colorscale = "Viridis",
    text = ~COUNTRY, locations = ~CODE, marker = list(line = l)
  ) %>%
  colorbar(title = "Happiness Score") %>%
  layout(title = 'Países con datos de felicidad (2024)', geo = g)

if (knitr::is_latex_output()) {
  # Guardar HTML y exportar como imagen
  html_file <- "mapa_interactivo.html"
  png_file <- "mapa_interactivo.png"
  saveWidget(fig1, file = html_file, selfcontained = TRUE)
  webshot2::webshot(html_file, file = png_file, vwidth = 1200, vheight = 800)
  
  # Insertar imagen con LaTeX puro para evitar errores
  cat('\\begin{center}\n')
  cat('\\includegraphics[width=0.9\\linewidth]{mapa_interactivo.png}\n')
  cat('\\end{center}\n')
} else {
  fig1
}


```

El mapa de felicidad por país en 2024 muestra una clara heterogeneidad geográfica en la percepción del bienestar, capturada a través del Happiness Score. Se observan regiones del norte global, como Europa Occidental, América del Norte y Oceanía, con los niveles más altos de felicidad (colores amarillos y verde claro), mientras que regiones del sur global, especialmente África Subsahariana y algunas partes de Asia como Afganistán o India, presentan valores notablemente más bajos (colores azul oscuro o morado).

Países como Finlandia, Noruega y Nueva Zelanda destacan con las puntuaciones más altas, reflejando contextos estables y altos niveles de desarrollo económico y social. En contraste, países como Zimbabwe, Sudán del Sur o Afganistán presentan los niveles más bajos, lo cual es coherente con contextos de conflicto, pobreza o inestabilidad política.

Este mapa no solo permite identificar diferencias entre regiones, sino también subrayar patrones estructurales: América Latina, por ejemplo, muestra un nivel medio de felicidad, con cierta variabilidad entre países. Es especialmente útil para detectar casos anómalos, como países con puntuaciones bajas en regiones generalmente altas o viceversa.

En conjunto, el gráfico evidencia de forma visual el impacto que pueden tener factores estructurales como el desarrollo, la gobernanza o la estabilidad en la percepción subjetiva del bienestar de los ciudadanos a nivel global.

Además del análisis temporal por país, resulta de interés observar cómo varía la felicidad entre regiones, y cómo se distribuye internamente en cada una de ellas. Para ello, se emplean gráficos de violín, que permiten visualizar simultáneamente la dispersión, la mediana y la densidad de los valores de happiness_score en cada región. Esta representación facilita la comparación entre regiones y la detección de desigualdades internas que podrían pasar desapercibidas en un análisis puramente temporal.

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
#| label: fig-felicidad-region
#| echo: false
#| warning: false
#| fig-cap: "Distribución de la felicidad agrupada por región en los años 2015, 2020 y 2024"
# Orden geográfico manual (puedes ajustarlo si tienes una lógica diferente)
orden_regiones <- c(
  "Western Europe",
  "Central and Eastern Europe",
  "Commonwealth of Independent States",
  "Middle East and North Africa",
  "Sub-Saharan Africa",
  "South Asia",
  "Southeast Asia",
  "East Asia",
  "Latin America and Caribbean",
  "North America and ANZ"
)

# Filtrar y reordenar niveles de las regiones
df_violin <- df_sin_democracia_sin_na %>%
  filter(year %in% c(2015, 2020, 2024)) %>%
  mutate(regional_indicator = factor(regional_indicator, levels = orden_regiones))

# Crear gráfico con facetas por año y mediana
p <- ggplot(df_violin, aes(x = regional_indicator, y = happiness_score, fill = regional_indicator)) +
  geom_violin(alpha = 0.6, trim = FALSE) +
  stat_summary(fun = median, geom = "point", color = "black", shape = 18, size = 2) +
  theme_minimal() +
  facet_wrap(~ year, ncol = 1) +
  labs(
    title = "Distribución de Felicidad por Región (2015, 2020, 2024)",
    x = "Región",
    y = "Happiness Score"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  )

# Mostrar interactivo si es HTML, guardar imagen si es PDF
if (knitr::is_latex_output()) {
  ggsave("violines_felicidad_por_anio.png", p, width = 10, height = 12)
  cat("![](violines_felicidad_por_anio.png)")
} else {
  ggplotly(p)
}
```

Observando la distribución de la felicidad por región, si nos fijamos en la mediana, que se muestra con un rombo negro en cada violín, vemos que hay regiones como Europa Occidental o Norte América y Australia que mantienen medianas altas y estables a lo largo del tiempo, mientras que el Sur de Asia y África Sub-Sahariana tienen medianas bajas, aunque relativamente estables.

En estos gráficos también se puede observar cierta bimodalidad, ya que algunas regiones, como Latino América y el Caribe o el Oriente Medio y África del Norte muestran dos modos (zonas más anchas del violín), lo que sugiere heterogeneidad interna: algunos países con altos niveles de felicidad conviven con otros con puntuaciones mucho más bajas. Asia del Sur presenta una distribución muy desigual en 2024, con un notable ensanchamiento en la parte inferior del gráfico, reflejando una baja felicidad en ciertos países (como Afganistán).

En general, la forma de las distribuciones se mantiene similar entre 2015 y 2024 en muchas regiones, pero algunas muestran mayor dispersión, sobre todo en el continente asiático, ya que Oriente Medio y Asia del Sur sufren una caída considerable en la felicidad. Regiones como Europa Occidental y Norte América y Australia presentan distribuciones compactas y felicidad más alta y estable, lo que refleja mayor consistencia en el bienestar subjetivo de sus poblaciones.

A continuación, analizamos la percepción de la corrupción, una variable que diversos estudios han señalado como influyente en la percepción de felicidad. En la siguiente figura se representa la distribución de esta variable mediante gráficos de violines, lo que nos permite observar sus diferencias entre regiones. Este tipo de representación facilita comparar no solo los valores centrales, sino también la dispersión y asimetría en cada grupo geográfico. Se observa que algunas regiones presentan niveles percibidos de corrupción notablemente más bajos, lo que podría estar asociado a mayores niveles de bienestar subjetivo.

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
#| label: fig-percepcion-corrupcion
#| echo: false
#| warning: false
#| fig-cap: "Distribución de la percepción de corrupción agrupada por región en los años 2015, 2020 y 2024"
# Orden geográfico de las regiones
orden_regiones <- c(
  "Western Europe",
  "Central and Eastern Europe",
  "Commonwealth of Independent States",
  "Middle East and North Africa",
  "Sub-Saharan Africa",
  "South Asia",
  "Southeast Asia",
  "East Asia",
  "Latin America and Caribbean",
  "North America and ANZ"
)

# Filtrar solo los años deseados y aplicar orden
df_corrupcion <- df_sin_democracia_sin_na %>% 
  filter(year %in% c(2015, 2020, 2024)) %>%
  mutate(regional_indicator = factor(regional_indicator, levels = orden_regiones))

# Gráfico con violines por región y año
p <- ggplot(df_corrupcion, aes(x = regional_indicator, y = corruption, fill = regional_indicator)) +
  geom_violin(alpha = 0.6, trim = FALSE) +
  stat_summary(fun = median, geom = "point", color = "black", shape = 18, size = 2) +
  theme_minimal() +
  facet_wrap(~ year, ncol = 1) +
  labs(
    title = "Distribución de la Percepción de Corrupción por Región (2015, 2020, 2024)",
    x = "Región",
    y = "Percepción de Corrupción"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  )

# Mostrar según el tipo de output
if (knitr::is_latex_output()) {
  ggsave("violines_corrupcion_por_anio.png", p, width = 10, height = 12)
  cat("![](violines_corrupcion_por_anio.png)")
} else {
  ggplotly(p)
}
```

El gráfico de violines permite observar la evolución de la percepción de corrupción en las distintas regiones a lo largo del tiempo, mostrando tanto la mediana como la distribución completa de los datos. Lo más destacable es la aparición de una clara bimodalidad en algunas regiones a partir de 2020 y especialmente en 2024, lo que sugiere una divergencia creciente entre países dentro de la misma región.

Europa Occidental mantiene una distribución relativamente estable a lo largo del tiempo, con una percepción de corrupción baja en general (valores altos), aunque en 2024 aparece una mayor dispersión que en 2015 y 2020. Sin embargo, en Europa Central y Oriental se observa un patrón inverso. En 2015 y 2020, la percepción es bastante alta (valores cercanos a 1), pero en 2024 se evidencia una caída brusca en la percepción positiva (valores muy bajos), lo que indica un empeoramiento de la percepción ciudadana sobre la corrupción en algunos países, como puede ser el caso de Hungría o Polonia.

Commonwealth of Independent States muestra una bimodalidad clara en 2024, mientras que en 2015 y 2020 predominaba un grupo más homogéneo. Esto sugiere que algunos países han experimentado mejoras o retrocesos significativos, diferenciándose del resto. América Latina y el Caribe también muestra un cambio claro: de una percepción moderadamente positiva en 2015 a una distribución más polarizada en 2020 y 2024, reflejando posiblemente tensiones políticas y escándalos de corrupción en países como Venezuela, Nicaragua o Bolivia.

En Asia del Este se observa una distribución muy compacta en 2015 y 2020, pero con una clara ruptura en 2024, lo que podría estar relacionado con dinámicas opuestas en países como China (control político férreo) frente a otros con gobiernos más abiertos. Por el contrario, regiones como Asia del Sur y África Sub-Sahariana muestran distribuciones bajas y más estables, aunque con una ligera mejora hacia 2024 en la percepción media.

Este análisis permite detectar no solo la evolución de la percepción media, sino también la heterogeneidad creciente dentro de regiones, y puede servir de base para cruzar estos patrones con los cambios políticos identificados previamente, evaluando si el deterioro institucional y la concentración del poder están efectivamente correlacionados con una mayor percepción de corrupción entre la ciudadanía.

Con el objetivo de comprender cómo ha cambiado la situación global en términos de bienestar subjetivo y factores asociados, analizamos a continuación la evolución promedio anual de las principales variables del informe de felicidad. Esta visualización nos permitirá detectar tendencias crecientes o decrecientes y posibles impactos globales, como crisis políticas, sanitarias o económicas.

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=12, fig.height=8}
#| label: fig-variables-comparacion
#| echo: false
#| warning: false
#| fig-cap: "Análisis temporal de las principales variables del informe de felicidad en comparación con Hungría, Turquía y Venezuela"
library(dplyr)
library(tidyr)
library(ggplot2)

# Variables numéricas de interés
vars_interes <- c("gdp", "support", 
                  "life_exp", "freedom", 
                  "generosity", "corruption", "happiness_score")

# Media global
media_global <- df_sin_democracia_sin_na %>%
  group_by(year) %>%
  summarise(across(all_of(vars_interes), mean, na.rm = TRUE)) %>%
  mutate(country = "Media Global") %>%
  pivot_longer(cols = -c(year, country), names_to = "variable", values_to = "media")

# Datos de los países a comparar
paises <- c("Venezuela", "Turkey", "Hungary")
paises_data <- df_sin_democracia_sin_na %>%
  filter(country %in% paises) %>%
  select(year, country, all_of(vars_interes)) %>%
  pivot_longer(cols = -c(year, country), names_to = "variable", values_to = "media")

# Combinar todo
data_comparada <- bind_rows(media_global, paises_data)

# Gráfico
ggplot(data_comparada, aes(x = year, y = media, color = country)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  facet_wrap(~variable, scales = "free_y") +
  scale_color_manual(
    values = c(
      "Media Global" = "gray70",
      "Venezuela" = "firebrick",
      "Turkey" = "royalblue",
      "Hungary" = "darkgreen"
    )
  ) +
  scale_x_continuous(breaks = sort(unique(data_comparada$year))) +
  theme_minimal() +
  labs(
    title = "Comparación: Media Global vs Venezuela, Turquía y Hungría (2015–2024)",
    x = "Año", y = "Valor medio", color = "País"
  ) +
  theme(strip.text = element_text(face = "bold"))

```

La evolución anual del promedio de variables de interés de la @fig-variables-comparacion refleja tendencias globales relevantes, pero su comparación con países concretos permite matizar dichas dinámicas y comprender mejor cómo contextos políticos específicos afectan al bienestar percibido por la población. Para ello, hemos seleccionado una serie de países que destacan por haber experimentado eventos políticos significativos o cambios institucionales durante el periodo de estudio, como Venezuela, Turquía o Hungría. Estos casos permiten ilustrar cómo la evolución de las condiciones políticas puede influir en la trayectoria del bienestar subjetivo, aportando una dimensión interpretativa más rica al análisis global.

En primer lugar, Venezuela se desmarca de forma clara en varias variables. El PIB per cápita presenta una caída drástica desde 2017, situándose muy por debajo de la media global a partir de 2018, lo que refleja la aguda crisis económica que atraviesa el país. Esta caída va acompañada de un descenso en la libertad para tomar decisiones y en la felicidad percibida, lo que sugiere un deterioro generalizado del bienestar. Sin embargo, resulta llamativo el aumento pronunciado en la generosidad a partir de 2021, superando incluso a la media global. Este fenómeno podría estar vinculado a la solidaridad comunitaria surgida ante la crisis prolongada, así como a cambios metodológicos en la forma en la que se capta esta variable en contextos de alta inestabilidad.

Por otro lado, Turquía muestra una tendencia decreciente en la libertad para tomar decisiones, especialmente desde 2018, coincidiendo con el fortalecimiento del poder ejecutivo bajo el liderazgo de Recep Tayyip Erdoğan. A pesar de mantener un PIB per cápita relativamente estable y una esperanza de vida en línea con la media global, la percepción de corrupción se mantiene sistemáticamente alta, lo cual refuerza la idea de un deterioro institucional progresivo. La felicidad percibida en Turquía permanece por debajo de la media, lo que puede reflejar un desencanto social persistente.

En el caso de Hungría, se observa una situación más ambivalente. Por un lado, variables como la esperanza de vida, el apoyo social y la felicidad percibida se mantienen por encima de la media global, lo que sugiere una cierta estabilidad material y comunitaria. No obstante, la libertad para tomar decisiones experimenta un estancamiento, y la percepción de corrupción es elevada, lo cual coincide con el proceso de retroceso democrático documentado en el país desde mediados de la década de 2010. Este contraste pone de manifiesto cómo un país puede mantener ciertos niveles de bienestar mientras erosiona sus instituciones democráticas.

Este análisis complementa el estudio previo de la evolución global. Ya habíamos observado que, en conjunto, variables como la libertad para tomar decisiones y la generosidad presentan una evolución creciente, posiblemente impulsada por procesos de recuperación post-pandemia o cambios culturales. También destacaba un pico atípico en el PIB per cápita en 2016, probablemente debido a valores extremos, y una tendencia general de aumento en la felicidad percibida hasta 2022, seguida de un leve descenso. Por el contrario, la percepción de corrupción es más errática, con oscilaciones abruptas entre años, lo que refleja fuertes diferencias entre países.

La comparación entre países permite, por tanto, observar cómo procesos políticos específicos (autoritarismo, crisis económica, reformas institucionales) se reflejan en los indicadores de bienestar. Venezuela, Turquía y Hungría muestran trayectorias divergentes respecto a la media global, lo cual subraya la necesidad de un análisis desagregado para captar la complejidad del bienestar en contextos políticamente inestables o en transformación.

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
#| label: fig-felicidad-pais
#| echo: false
#| warning: false
#| fig-cap: "Análisis temporal de la evolución temporal de la felicidad por país"
library(dplyr)
library(ggplot2)
library(viridis)

# 1. Calcular la media global por país (en todo el periodo)
orden_paises <- df_sin_democracia_sin_na %>%
  group_by(country) %>%
  summarise(media_pais = mean(happiness_score, na.rm = TRUE)) %>%
  arrange(desc(media_pais)) %>%
  pull(country)

# 2. Calcular media global por año
media_anual <- df_sin_democracia_sin_na %>%
  group_by(year) %>%
  summarise(media_happiness = mean(happiness_score, na.rm = TRUE))

# 3. Preparar dataset con orden fijo
df_plot <- df_sin_democracia_sin_na %>%
  filter(!is.na(happiness_score)) %>%
  left_join(media_anual, by = "year") %>%
  mutate(country = factor(country, levels = orden_paises))

# 4. Gráfico con orden constante y media global por año
ggplot(df_plot, aes(x = country, y = happiness_score, fill = happiness_score)) +
  geom_col(show.legend = FALSE) +
  geom_hline(aes(yintercept = media_happiness), color = "red", linetype = "dashed", linewidth = 0.8) +
  facet_wrap(~ year, scales = "free_x") +
  scale_fill_viridis_c() +
  labs(
    title = "Happiness Score por País (ordenado por media global)",
    subtitle = "Línea roja discontinua = media global del año",
    x = "País", y = "Happiness Score"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    strip.text = element_text(face = "bold")
  )


```

La @fig-felicidad-pais muestra la evolución del Happiness Score por país entre los años 2015 y 2024, representando cada año en un panel independiente y añadiendo como referencia una línea roja discontinua que indica la media global de felicidad de ese año. Esta visualización permite realizar un análisis comparativo tanto entre países como a lo largo del tiempo, aportando una perspectiva clara sobre la distribución del bienestar subjetivo a escala mundial.

Lo primero que llama la atención es la notable estabilidad de la media global a lo largo del periodo observado. La línea roja, que representa dicho promedio, se mantiene en un intervalo relativamente estrecho —aproximadamente entre 5.3 y 5.5 puntos—, lo que sugiere que, a nivel agregado, la percepción de felicidad mundial no ha sufrido cambios drásticos. Sin embargo, esta estabilidad global oculta dinámicas internas más complejas.

A medida que avanzan los años, especialmente a partir de 2020, se observa un aumento progresivo en la cantidad de países que se sitúan por debajo de la media global. Esta tendencia podría estar vinculada al impacto de la pandemia de COVID-19 y sus secuelas económicas, sanitarias y sociales, que afectaron de manera desigual a distintas regiones. Asimismo, podría reflejar procesos de deterioro democrático o inestabilidad política en determinados contextos, tal y como se ha explorado en análisis previos sobre variables institucionales.

El gráfico también pone de manifiesto la persistencia de fuertes desigualdades en la distribución del bienestar subjetivo. Mientras que un pequeño grupo de países —posiblemente naciones del norte de Europa como Finlandia, Dinamarca o Islandia— se mantiene de forma consistente en la parte superior del ranking con puntuaciones muy por encima de la media, la gran mayoría de países se concentra en la franja media o baja. Esta asimetría en la distribución revela que, si bien algunos países gozan de altos niveles de satisfacción vital sostenidos en el tiempo, muchos otros enfrentan barreras estructurales que dificultan mejorar su puntuación de felicidad.

Un fenómeno adicional que merece atención es el ligero descenso en los valores máximos del Happiness Score en los últimos años. En 2023 y 2024, incluso los países mejor posicionados parecen haber perdido algo de ventaja con respecto a años anteriores. Esta caída podría interpretarse como un efecto retardado de los acontecimientos globales recientes, o como una normalización tras niveles particularmente elevados en años previos.

En conjunto, el gráfico no solo reafirma que la media global se mantiene estable, sino que también evidencia un ensanchamiento de la brecha entre países y una posible tendencia al estancamiento o deterioro en la felicidad percibida a nivel nacional. La comparación interanual permite detectar trayectorias divergentes y resalta la necesidad de seguir analizando qué factores explican el desempeño diferencial de los países. Esta visualización resulta, por tanto, un complemento clave para comprender la evolución del bienestar en un contexto global marcado por desafíos económicos, políticos y sociales.

Tras analizar la evolución global de la felicidad a nivel de país, resulta interesante centrar la atención en contextos geográficos más acotados que, por su cercanía cultural, económica o política, puedan mostrar dinámicas particulares. En este sentido, se ha seleccionado un grupo de países europeos próximos a España —Portugal, Francia, Italia, Andorra, Suiza, Alemania y Reino Unido— para realizar un análisis comparativo más detallado de la evolución del bienestar subjetivo entre 2015 y 2024.

## Evolución del Happiness Score en España

El objetivo de este bloque es doble: por un lado, examinar la trayectoria específica de España en cuanto a su Happiness Score a lo largo del tiempo; y por otro, contextualizar dicha evolución en relación con sus países vecinos. Además, se analizarán variables complementarias como el PIB per cápita, el apoyo social, la libertad en la toma de decisiones, y las puntuaciones de derechos políticos y libertades civiles, con el fin de identificar posibles factores explicativos de las tendencias observadas.

Este enfoque regional no solo permite evaluar si España sigue dinámicas similares o divergentes respecto a su entorno inmediato, sino que también contribuye a detectar patrones de bienestar y resiliencia en Europa Occidental. Dado el contexto de crisis sucesivas —económica, sanitaria y geopolítica— en el periodo analizado, comparar la evolución de estos países cercanos ofrece una perspectiva enriquecedora sobre el impacto de factores estructurales e institucionales en la percepción de felicidad de la ciudadanía.

```{r echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-felicidad-espana
#| echo: false
#| warning: false
#| fig-cap: "Evolución temporal de la felicidad en España"
# Lista de países europeos cercanos a España
paises_cercanos <- c("Spain", "Portugal", "France", "Italy", "Andorra", "Switzerland", "Germany", "United Kingdom")

# Datos de estos países
df_cercanos <- df_sin_democracia_sin_na %>% 
  filter(country %in% paises_cercanos)

# Evolución del Happiness Score en España
df_espana <- df_cercanos %>% filter(country == "Spain")

ggplot(df_espana, aes(x = year, y = happiness_score)) +
  geom_line(color = "blue") +
  geom_point(color = "blue") +
  labs(title = "Evolución del Happiness Score en España", x = "Año", y = "Happiness Score") +
  scale_x_continuous(breaks = unique(df_espana$year)) +
  theme_minimal()
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-felicidad-espana-paises
#| echo: false
#| warning: false
#| fig-cap: "Evolución temporal de la felicidad en España y en países cercanos"
# Evolución del Happiness Score en países cercanos
ggplot(df_cercanos, aes(x = year, y = happiness_score, color = country, group = country)) +
  geom_line(linewidth = 1) +
  labs(title = "Evolución del Happiness Score en Países Cercanos a España", 
       x = "Año", y = "Happiness Score") +
  scale_x_continuous(breaks = unique(df_espana$year)) +
  theme_minimal()
```

En gráfico de la @fig-felicidad-espana, centrado exclusivamente en España, se observa una evolución relativamente estable del índice de felicidad, con pequeñas oscilaciones en torno a valores ligeramente superiores a 6.3. No obstante, destaca una caída en 2018 (mínimo del periodo), seguida de una recuperación progresiva que culmina en un pico en 2021, justo tras el primer año completo de pandemia. Este máximo puede parecer contraintuitivo, pero podría explicarse por un efecto de resiliencia colectiva o por cambios en la percepción subjetiva del bienestar ante la crisis sanitaria. Tras 2021, sin embargo, el índice inicia un leve descenso que se prolonga hasta 2024, lo que podría reflejar un efecto retardado de las consecuencias económicas, sociales y emocionales de la pandemia.

El gráfico de la @fig-felicidad-espana-paises contextualiza estos datos al mostrar la evolución del Happiness Score en países próximos a España: Francia, Portugal, Italia, Alemania, Reino Unido y Suiza. Una primera observación relevante es que España se sitúa de forma constante en un rango medio-bajo dentro de este grupo, por encima únicamente de Portugal (hasta 2020) y, ocasionalmente, de Italia. Países como Suiza, Alemania y Reino Unido exhiben sistemáticamente puntuaciones más altas, lo cual podría estar vinculado a mayores niveles de riqueza, estabilidad institucional o servicios sociales más desarrollados.

En términos de trayectoria, destaca el descenso claro en los últimos años (especialmente a partir de 2022) en la mayoría de países analizados, incluyendo aquellos con niveles históricamente altos de felicidad como Suiza o Alemania. Este patrón sugiere la presencia de factores estructurales o globales (crisis energética, inflación, tensiones geopolíticas) que estarían afectando incluso a los países tradicionalmente más satisfechos. En contraste, países como Portugal e Italia muestran una tendencia más estable o incluso creciente hasta 2022, posiblemente como resultado de procesos de recuperación o mejora relativa en relación con sus propias trayectorias históricas.

```{r echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-variables-espana
#| echo: false
#| warning: false
#| fig-cap: "Evolución del PIB en España y sus países cercanos"
# Evolución del PIB (GDP per capita)
ggplot(df_cercanos, aes(x = year, y = gdp, color = country, group = country)) +
  geom_line(linewidth = 1) +
  labs(title = "Evolución del PIB per cápita en Países Cercanos a España", 
       x = "Año", y = "PIB per cápita") +
  scale_x_continuous(breaks = unique(df_espana$year)) +
  theme_minimal()


```

```{r echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-variables-espana2
#| echo: false
#| warning: false
#| fig-cap: "Evolución del apoyo social en España y sus países cercanos"


# Evolución del apoyo social
ggplot(df_cercanos, aes(x = year, y = support, color = country, group = country)) +
  geom_line(linewidth = 1) +
  labs(title = "Evolución del Apoyo Social en Países Cercanos a España", 
       x = "Año", y = "Apoyo Social") +
  scale_x_continuous(breaks = unique(df_espana$year)) +
  theme_minimal()



```

```{r echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-variables-espana3
#| echo: false
#| warning: false
#| fig-cap: "Evolución de la libertad en la toma de decisiones en España y sus países cercanos"

# Evolución de la libertad en la toma de decisiones
ggplot(df_cercanos, aes(x = year, y = freedom, color = country, group = country)) +
  geom_line(linewidth = 1) +
  labs(title = "Evolución de la Libertad para Tomar Decisiones en Países Cercanos a España", 
       x = "Año", y = "Libertad para Tomar Decisiones") +
  scale_x_continuous(breaks = unique(df_espana$year)) +
  theme_minimal()

```

Los gráficos presentados en la @fig-variables-espana, @fig-variables-espana2 y @fig-variables-espana3 permiten analizar la evolución de distintas dimensiones del bienestar y la calidad de vida en un conjunto de países europeos cercanos a España entre 2015 y 2024. En conjunto, nos ofrecen una perspectiva comparativa regional que ayuda a contextualizar el caso español en relación con sus vecinos.

En la @fig-variables-espana, que muestra la evolución del PIB per cápita, se observa una fuerte caída generalizada en 2017, seguida por una recuperación progresiva desde 2018. Esta evolución puede estar relacionada con una recodificación de datos o un cambio metodológico en ese año, pero también con impactos económicos de alcance regional. En cualquier caso, destaca que Suiza mantiene sistemáticamente el mayor PIB per cápita, situándose por encima del resto del grupo. Le siguen Alemania y Reino Unido, con valores elevados y estables. España se encuentra en la parte baja del grupo, junto a Portugal e Italia, aunque todos ellos muestran una tendencia ascendente en los últimos años, lo que refleja una recuperación económica moderada.

En la @fig-variables-espana2, relativo al apoyo social, se aprecia un comportamiento mucho más volátil. En 2018 hay una caída muy pronunciada en todos los países, especialmente en España, Italia y Portugal, lo cual podría reflejar una crisis de confianza institucional o una percepción negativa del entorno social. Sin embargo, en 2019 se produce un repunte, seguido de cierta estabilización con una tendencia ligeramente descendente en algunos países. Suiza y Reino Unido destacan por mantener niveles consistentemente altos de apoyo social, mientras que España mejora en los últimos años tras el fuerte descenso.

La @fig-variables-espana3 muestra la evolución de la libertad para tomar decisiones, una dimensión vinculada a la percepción de autonomía personal. Aquí destaca el caso de Suiza, que parte de valores cercanos a 1 y los mantiene prácticamente inalterados. Alemania y Reino Unido también se sitúan en la parte superior, mientras que España parte de un nivel más bajo en 2015 y experimenta una caída hasta 2019, seguida de una recuperación constante a partir de ese momento. Por el contrario, Italia muestra una evolución ascendente sostenida, superando incluso a España en los últimos años. Esta variable presenta un patrón de mejora generalizada en la región, lo que puede reflejar avances en la percepción de libertad individual y gobernanza democrática.

En conjunto, estos gráficos permiten extraer varias conclusiones. En primer lugar, España tiende a situarse en posiciones intermedias o bajas dentro del grupo de comparación, aunque muestra señales de mejora especialmente en PIB y libertad individual. En segundo lugar, países como Suiza y Alemania destacan sistemáticamente por sus buenos resultados, lo que puede atribuirse a sus estructuras institucionales consolidadas y niveles de desarrollo económico. Finalmente, el análisis temporal revela momentos de tensión o crisis (como 2017–2018) seguidos de cierta recuperación, lo que sugiere una resiliencia estructural en la región. Esta comparativa refuerza la utilidad del análisis multinacional para entender mejor los factores que condicionan la evolución del bienestar en contextos políticamente estables pero económicamente diversos.

Aunque al inicio del capítulo ya indicamos que no se detectaron valores atípicos significativos tras el análisis inicial, conviene revisar brevemente algunas observaciones que, por su contexto o comportamiento, podrían considerarse casos especiales. Esta revisión no pretende identificar outliers estadísticos en sentido estricto, sino valorar si existen países cuya evolución difiere notablemente del patrón general y que, por tanto, merecen una atención particular en el análisis interpretativo posterior.

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
#| label: fig-felicidad-anual
#| echo: false
#| warning: false
#| fig-cap: "Análisis de la distribución de la puntuación de felicidad anual"
ggplot(df_original, aes(x = factor(year), y = happiness_score)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Distribución de Felicidad por Año", x = "Año", y = "Happiness Score") 
```

Si observamos la @fig-felicidad-anual, de 2015 a 2020 no vemos valores atípicos, pero en 2021 vemos un valor atípico de 2.52, en 2022 de 2.40, en 2023 de 1.86 y en 2024 de 1.72. Todos estos valores atípicos corresponden con Afganistán. Vamos a entrar en más detalle para ver cuál es la evolución de dicho país.

```{r echo=FALSE, warning=FALSE}
#| label: fig-felicidad-afganistan
#| echo: false
#| warning: false
#| fig-cap: "Evolución temporal de la felicidad en Afganistán"
df_afganistan <- df_sin_democracia_sin_na %>% filter(country == "Afghanistan")
ggplot(df_afganistan, aes(x = year, y = happiness_score)) +
  geom_line() +
  geom_point() +
  labs(title = "Evolución del Happiness Score en Afganistán", x = "Año", y = "Happiness Score") +
  scale_x_continuous(breaks = unique(df_afganistan$year))
```

```{r echo=FALSE, warning=FALSE}
#| label: fig-afganistan2
#| echo: false
#| warning: false
#| fig-cap: "Evolución temporal de la felicidad en Afganistán y en países cercanos"
df_region <- df_sin_democracia_sin_na %>% filter(regional_indicator == "South Asia")
ggplot(df_region, aes(x = year, y = happiness_score, color = country, group = country)) +
  geom_line() +
  labs(title = "Evolución del Happiness Score en Asia del Sur", x = "Año", y = "Happiness Score") +
  scale_x_continuous(breaks = unique(df_afganistan$year))
```

Si observamos la @fig-felicidad-afganistan y @fig-afganistan2, Afganistán sufre una gran caída de la felicidad a partir de 2017 y si lo comparamos con países de su región es el que menos puntuación tiene por bastante diferencia. Esto puede haberse dado por diversos factores, como el constante estado de guerra y conflicto en el que se ha encontrado el país, la presencia de los talibanes y otros grupos armados que han aumentado la violencia y el temor en la población, la enorme tasa de pobreza... Vamos a comparar la evolución de Afganistán con sus países vecinos para ver realmente qué puede estar afectando a tal bajada de la felicidad.

```{r echo=FALSE, warning=FALSE}
#| label: fig-pib-afganistan
#| echo: false
#| warning: false
#| fig-cap: "Evolución temporal del PIB en Afganistán y en países cercanos"
ggplot(df_region, aes(x = year, y = gdp, color = country, group = country)) +
  geom_line() +
  labs(title = "Evolución del PIB en Asia del Sur", x = "Año", y = "PIB") +
  scale_x_continuous(breaks = unique(df_afganistan$year))
```

Observando la @fig-pib-afganistan, vemos que Afganistán presenta el PIB más bajo de la región durante todo el periodo, aunque la diferencia no es tan pronunciada respecto a sus vecinos. La evolución del PIB muestra una tendencia relativamente paralela, lo cual indica que la situación económica general no difiere radicalmente en términos de crecimiento.

```{r echo=FALSE, warning=FALSE}
#| label: fig-apoyo-afganistan
#| echo: false
#| warning: false
#| fig-cap: "Evolución temporal del apoyo social en Afganistán y en países cercanos"
ggplot(df_region, aes(x = year, y = support, color = country, group = country)) +
  geom_line() +
  labs(title = "Evolución del apoyo social en Asia del Sur", x = "Año", y = "Apoyo social") +
  scale_x_continuous(breaks = unique(df_afganistan$year))
```

Sin embargo, la @fig-apoyo-afganistan muestra que el apoyo social sufre una caída drástica en Afganistán a partir de 2021, coincidiendo con el regreso de los talibanes al poder. A diferencia de los países vecinos, donde el apoyo se mantiene más estable, en Afganistán prácticamente desaparece, lo que podría explicar un deterioro importante en el bienestar subjetivo de su población.

```{r echo=FALSE, warning=FALSE}
#| label: fig-libertad-afganistan
#| echo: false
#| warning: false
#| fig-cap: "Evolución temporal de la libertad de los ciudadanos en Afganistán y en países cercanos"
ggplot(df_region, aes(x = year, y = freedom, color = country, group = country)) +
  geom_line() +
  labs(title = "Evolución de la libertad en la toma de decisiones de los ciudadanos en Asia del Sur", x = "Año", y = "Libertad en la toma de decisiones de los ciudadanos") +
  scale_x_continuous(breaks = unique(df_afganistan$year))
```

En términos de libertad para tomar decisiones vitales, la @fig-libertad-afganistan muestra que Afganistán se sitúa consistentemente por debajo de la media regional. Este valor, que ya era bajo en años anteriores, cae aún más tras 2021, reflejando la pérdida de autonomía percibida por sus ciudadanos.

```{r echo=FALSE, warning=FALSE}
#| label: fig-der-afganistan
#| echo: false
#| warning: false
#| fig-cap: "Evolución temporal de la privación de derechos políticos en Afganistán y en países cercanos"
ggplot(df_region, aes(x = year, y = political_rights, color = country, group = country)) +
  geom_line() +
  labs(title = "Evolución de la privación de derechos políticos en Asia del Sur", x = "Año", y = "Privación de derechos políticos") +
  scale_x_continuous(breaks = unique(df_afganistan$year))
```

La @fig-der-afganistan muestra que la pérdida de libertad se ve reforzada por el deterioro de los derechos políticos, donde Afganistán muestra los valores más altos de privación dentro de la región. El país se convierte en un claro outlier en este aspecto a partir de 2021.

```{r echo=FALSE, warning=FALSE}
#| label: fig-lib-afganistan
#| echo: false
#| warning: false
#| fig-cap: "Evolución temporal de la privación de libertades civiles en Afganistán y en países cercanos"
ggplot(df_region, aes(x = year, y = civil_liberties, color = country, group = country)) +
  geom_line() +
  labs(title = "Evolución de la privación de libertades civiles en Asia del Sur", x = "Año", y = "Privación de libertades civiles") +
  scale_x_continuous(breaks = unique(df_afganistan$year))
```

Por último, observando la @fig-lib-afganistan, la privación de libertades civiles también coloca a Afganistán en una posición crítica frente a sus vecinos. Este conjunto de restricciones políticas y sociales contribuye directamente a su puntuación tan baja de felicidad, y subraya la necesidad de considerar el contexto institucional al interpretar estos datos.