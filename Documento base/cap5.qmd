---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r include=FALSE, warning=FALSE}
library(readr)
library(readxl)
library(janitor)
library(mice)
library(visdat)
library(outliers)
library(plotly)
library(tidyverse)
library(webshot2)
library(lmtest)      # Para bptest() y dwtest()
library(tseries)     # Para jarque.bera.test()
library(ggfortify)   # Para autoplot() del modelo

```

# Construcción del modelo

```{r message=FALSE, warning=FALSE, include=FALSE}
library(ggplot2)
knitr::opts_chunk$set(
  fig.width = 6, 
  fig.height = 4, 
  dev = "png",
  fig.align = "center"
)
theme_set(theme_minimal(base_size = 12))
```


En este capítulo desarrollamos el proceso de construcción de un modelo estadístico para explicar y predecir la percepción de felicidad (Happiness Score) a lo largo del tiempo, utilizando los datos longitudinales disponibles para todos los países entre los años 2015 y 2024. Dado que el análisis de este trabajo se centra en la evolución de la felicidad en el tiempo, consideramos esencial aprovechar toda la información disponible, en lugar de limitar el estudio a una única foto fija (por ejemplo, el año 2024).

El objetivo de este capítulo es construir un modelo que sea estadísticamente sólido y al mismo tiempo interpretable en el contexto de los determinantes sociales, económicos y políticos de la felicidad. Para ello, combinaremos herramientas de la estadística clásica (regresión lineal múltiple) con técnicas específicas para datos longitudinales, incluyendo modelos mixtos que permiten tener en cuenta la estructura jerárquica de los datos (países medidos en diferentes años).

El proceso de modelado se abordará desde dos estrategias complementarias:

- **Top-down**: partimos de un modelo completo que incluye todas las variables relevantes, y vamos eliminando aquellas que no aportan información significativa o que generan problemas como multicolinealidad o sobreajuste.

- **Bottom-up**: comenzamos con un modelo simple con pocas variables y vamos añadiendo progresivamente nuevos predictores, evaluando si su inclusión mejora sustancialmente el ajuste del modelo.

Ambos enfoques nos permiten analizar el trade-off entre complejidad y capacidad explicativa, y encontrar un equilibrio adecuado.

Dado que trabajamos con datos que varían a lo largo del tiempo para cada país, es importante distinguir entre:

- **Variables longitudinales**: cambian con el tiempo (por ejemplo, `gdp`, `support`, `freedom`, `generosity`, `life_exp`, `corruption`).
- **Variables fijas**: son constantes en el tiempo o se utilizan como contexto (por ejemplo, `region`, si se decide mantener como factor).

Además, es importante tener en cuenta la dependencia temporal entre observaciones del mismo país. Este aspecto será considerado al ajustar modelos mixtos con interceptos (y potencialmente pendientes) aleatorios por país.

## Análisis exploratorio y selección inicial de variables

Aunque ya se analizó previamente la estructura de los datos, antes de ajustar cualquier modelo es útil revisar de nuevo las características más relevantes desde una perspectiva predictiva, identificando posibles problemas (como valores faltantes o outliers) y seleccionando las variables que podrían actuar como buenos predictores del `happiness_score`.

### Estructura del dataset longitudinal

Nuestro conjunto de datos contiene observaciones anuales de múltiples países en el período 2015–2024. Para cada país y año, disponemos de una serie de variables socioeconómicas y de percepción ciudadana. Las variables disponibles son:

- `happiness_score`: puntuación de felicidad (variable respuesta)
- `gdp`: producto interior bruto per cápita
- `support`: percepción de apoyo social
- `life_exp`: esperanza de vida saludable
- `freedom`: libertad para tomar decisiones
- `generosity`: generosidad de la población
- `corruption`: percepción de corrupción en instituciones
- `country`: identificador del país
- `year`: año de la observación
- `regional_indicator`: región a la que pertenece el país

Dado el enfoque longitudinal del estudio, empleamos `country` como unidad de agrupación para modelar efectos aleatorios específicos de cada país a lo largo del tiempo, permitiendo así capturar variaciones propias de cada trayectoria nacional. Por otro lado, la variable `year` se incluye como efecto fijo, ya que representa un factor temporal compartido por todos los países, y nos interesa estimar su impacto general sobre la felicidad, no modelarlo como una variación aleatoria.


### Visualización y evolución temporal de las variables

Antes de proceder al ajuste del modelo, es útil examinar cómo evolucionan las principales variables explicativas a lo largo del tiempo. En la Figura @fig-evolucion-variables se muestran los gráficos de evolución de tres de las variables más relevantes: *Happiness Score*, *Percepción de Corrupción* y *Generosidad*. Estas variables han sido seleccionadas por su potencial impacto en el bienestar subjetivo y por su comportamiento representativo del conjunto de predictores considerados. El resto de variables presentan patrones temporales más estables o menos informativos visualmente.

Esta visualización permite identificar posibles tendencias globales y diferencias regionales o entre países, lo cual resulta clave para motivar la elección de modelos que incorporen estructura longitudinal y efectos aleatorios por país.

```{r}
#| label: fig-evolucion-variables
#| echo: false
#| warning: false
#| fig-cap: "Evolución temporal de las variables felicidad, generosidad y percepción de corrupción (2015-2024)"
library(ggplot2)
library(dplyr)
library(patchwork)
df_sin_democracia_sin_na <- read.csv("df_sin_democracia_sin_na.csv")
df_sin_democracia_sin_na <- read.csv("df_sin_democracia_sin_na.csv")
# Dataset filtrado
df_temp <- df_sin_democracia_sin_na %>%
  filter(year %in% 2015:2024) %>%
  group_by(year) %>%
  summarise(
    felicidad = mean(happiness_score, na.rm = TRUE),
    generosidad = mean(generosity, na.rm = TRUE),
    corrupcion = mean(corruption, na.rm = TRUE)
  )

# Gráfico 1: Felicidad
g1 <- ggplot(df_temp, aes(x = factor(year), y = felicidad)) +
  geom_line(color = "#1b9e77", size = 1.2) +
  geom_point(color = "#1b9e77", size = 2) +
  labs(y = "Felicidad", x = NULL) +
  theme_minimal()  

# Gráfico 2: Generosidad
g2 <- ggplot(df_temp, aes(x = factor(year), y = generosidad)) +
  geom_line(color = "#d95f02", size = 1.2) +
  geom_point(color = "#d95f02", size = 2) +
  labs(y = "Generosidad", x = NULL) +
  theme_minimal()  

# Gráfico 3: Corrupción
g3 <- ggplot(df_temp, aes(x = factor(year), y = corrupcion)) +
  geom_line(color = "#7570b3", size = 1.2) +
  geom_point(color = "#7570b3", size = 2) +
  labs(y = "Corrupción", x = "Año") +
  theme_minimal()  

# Composición con patchwork
(g1 / g2 / g3) +
  plot_annotation(title = "Evolución temporal de variables clave (2015-2024)")
```

```{r warning=FALSE, include=FALSE}
# Carga de paquetes 
library(readr)
library(readxl)
library(janitor)
library(mice)
library(visdat)
library(outliers)
library(plotly)
library(tidyverse)
library(webshot2)

# Cargamos los datos 
df_original <- read_delim("world_happiness_combined.csv", delim = ";", show_col_types = FALSE)
# Limpiar nombres de columnas
df_original <- clean_names(df_original)
summary(df_original)
str(df_original)
# Hay algunas variables numérias que están puestas como categóricas
df_original <- df_original %>%
  mutate(
    gdp_per_capita = as.numeric(gsub(",", ".", gdp_per_capita)),
    social_support = as.numeric(gsub(",", ".", social_support)),
    freedom_to_make_life_choices = as.numeric(gsub(",", ".", freedom_to_make_life_choices)),
    generosity = as.numeric(gsub(",", ".", generosity)),
    perceptions_of_corruption = as.numeric(gsub(",", ".", perceptions_of_corruption))
  )
# Verificar que ahora sean numéricas
str(df_original)
# Hay un problema con las comas en el happiness score
df_original$happiness_score <- df_original$happiness_score / 100000
# Datos faltantes
is.na(df_original)
# En la base de datos no hay ningún dato faltante

# Detección de Outliers
boxplot(df_original$happiness_score)
boxplot(df_original$gdp_per_capita)
boxplot(df_original$social_support)  
boxplot(df_original$healthy_life_expectancy)
boxplot(df_original$freedom_to_make_life_choices)
boxplot(df_original$generosity)
boxplot(df_original$perceptions_of_corruption)
# Como podemos apreciar gráficamente, hay algunas variables numéricas en las que puede haber valores atípicos
outliers::grubbs.test(df_original$happiness_score)
outliers::grubbs.test(df_original$gdp_per_capita)
outliers::grubbs.test(df_original$social_support)
outliers::grubbs.test(df_original$healthy_life_expectancy)
outliers::grubbs.test(df_original$freedom_to_make_life_choices)
outliers::grubbs.test(df_original$generosity)
outliers::grubbs.test(df_original$perceptions_of_corruption)
# Como el p-valor es > alpha en todos los test, no tenemos outliers
df_original <- df_original %>%
  rename(
    gdp = gdp_per_capita,
    support = social_support,
    life_exp = healthy_life_expectancy,
    freedom = freedom_to_make_life_choices,
    generosity = generosity,
    corruption = perceptions_of_corruption
  )
```

```{r include=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(stringr)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(htmlwidgets)
## FREEDOM IN THE WORLD
freedom_todos <- read_excel("All_data_FIW_2013-2024 (1).xlsx", sheet = "FIW13-25", skip = 1)
### Las variables que nos pueden llegar a interesar son:
#### Country/Territory (necesitamos el país/territorio)
#### Region (aunque sea muy parecida a la de regional_indicator, nos puede ser de utilidad)
#### c/T (indica si es país o territorio, aunque no se si deberíamos de meternos con el concepto de soberanía)
#### Edition (necesitamos el año)
#### Status (clasifica la libertad del país)
#### PR (derechos políticos) rating y CL (libertades civiles) rating (la otra opción sería elegir PR, CL y Total porque el rating va de 1 a 7)
freedom_final <- freedom_todos %>%
  select(
    `Country/Territory`, # Nombre del país o territorio
    `Region`,            # Región geográfica
    `C/T`,               # Indica si es país (c) o territorio (t)
    `Edition`,           # Año de edición de los datos
    `Status`,            # Clasificación de libertad (Libre, Parcialmente Libre, No Libre)
    `PR rating`,         # Puntuación de derechos políticos (1-7)
    `CL rating`          # Puntuación de libertades civiles (1-7)
  ) %>%
  rename(
    country = `Country/Territory`,
    region = `Region`,
    country_or_territory = `C/T`,
    year = `Edition`,
    status = `Status`,
    political_rights = `PR rating`,
    civil_liberties = `CL rating`
  )
freedom_final <- freedom_final %>%
  filter(year >= 2015 & year <= 2024)
## DEMOCRACY DATA ==> DEMOCRACY AND DICTATORSHIP
library(democracyData)
democracy_data <-
  democracyData::pacl_update |> 
  janitor::clean_names() |> 
  dplyr::select(
    "country_name" = "pacl_update_country",
    "country_code" = "pacl_update_country_isocode",
    "year",
    "regime_category_index" = "dd_regime",
    "regime_category" = "dd_category",
    "is_monarchy" = "monarchy",
    "is_commonwealth" = "commonwealth",
    "monarch_name",
    "monarch_accession_year" = "monarch_accession",
    "monarch_birthyear",
    "is_female_monarch" = "female_monarch",
    "is_democracy" = "democracy",
    "is_presidential" = "presidential",
    "president_name",
    "president_accesion_year" = "president_accesion",
    "president_birthyear",
    "is_interim_phase" = "interim_phase",
    "is_female_president" = "female_president",
    "is_colony" = "colony",
    "colony_of",
    "colony_administrated_by",
    "is_communist" = "communist",
    "has_regime_change_lag" = "regime_change_lag",
    "spatial_democracy",
    "parliament_chambers" = "no_of_chambers_in_parliament",
    "has_proportional_voting" = "proportional_voting",
    "election_system",
    "lower_house_members" = "no_of_members_in_lower_house",
    "upper_house_members" = "no_of_members_in_upper_house",
    "third_house_members" = "no_of_members_in_third_house",
    "has_new_constitution" = "new_constitution",
    "has_full_suffrage" = "fullsuffrage",
    "suffrage_restriction",
    "electoral_category_index" = "electoral",
    "spatial_electoral",
    "has_alternation" = "alternation",
    "is_multiparty" = "multiparty",
    "has_free_and_fair_election" = "free_and_fair_election",
    "parliamentary_election_year",
    "election_month" = "election_month_year",
    "has_postponed_election" = "postponed_election"
  ) |>
  dplyr::mutate(
    election_month = dplyr::na_if(.data$election_month, "?")
  ) |> 
  tidyr::separate_wider_regex(
    "election_month",
    patterns = c(
      election_month = "\\D+",
      election_year = "\\d{4}$"
    ),
    too_few = "align_start"
  ) |> 
  dplyr::mutate(
    electoral_category = dplyr::case_match(
      .data$electoral_category_index,
      0 ~ "no elections",
      1 ~ "single-party elections",
      2 ~ "non-democratic multi-party elections",
      3 ~ "democratic elections"
    ),
    .after = "electoral_category_index"
  ) |> 
  dplyr::mutate(
    election_month = stringr::str_squish(.data$election_month),
    dplyr::across(
      c(
        tidyselect::ends_with("_index"),
        tidyselect::contains("year"),
        tidyselect::ends_with("_members"),
        "parliament_chambers"
      ),
      as.integer
    ),
    dplyr::across(
      c(
        tidyselect::starts_with("is_"),
        tidyselect::starts_with("has_")
      ),
      as.logical
    )
  )
### Las variables que nos pueden llegar a interesar son:
#### country_name (necesitamos el país/territorio)
#### year (año)
#### regime_category (Parliamentary democracies, Mixed democracies (with weak presidents), Presidential democracies, Civilian autocracies, Military dictatorships, Royal dictatorships)
#### is_monarchy (es monarquía o no)
#### is_democracia (es democracia o no)
#### is_presidential (es presidencial o no)
#### is_colony (es colonia o no)
#### is_communist (es comunista o no)
#### spatial_democracy (como de democráticos son sus países vecinos) 
#### has_full_suffrage (tiene sufragio universal o no)
#### electoral_category (No elections, Single-party elections, non-democratic multi-party elections, democratic elections)
#### spatial_electoral (cómo son las elecciones en sus países vecinos)
#### has_free_and_fair_election (tienen elecciones justas o no)
#### has_alternation (cambian de gobierno o no)
democracy_final <- democracy_data %>%
  select(
    country_name, 
    year, 
    regime_category, 
    is_monarchy, 
    is_democracy, 
    is_presidential, 
    is_colony, 
    is_communist, 
    spatial_democracy, 
    has_full_suffrage, 
    electoral_category, 
    spatial_electoral, 
    has_free_and_fair_election, 
    has_alternation
  ) %>%
  rename(
    monarchy = is_monarchy,
    democracy = is_democracy,
    presidential = is_presidential,
    colony = is_colony,
    communist = is_communist,
    sp_democracy = spatial_democracy,
    suffrage = has_full_suffrage,
    sp_electoral = spatial_electoral,
    fair_election = has_free_and_fair_election,
    alternation = has_alternation
  )
democracy_final <- democracy_final %>%
  filter(year >= 2015 & year <= 2024)
## UNIÓN DE LOS DATASETS
colnames(df_original)
colnames(democracy_final)
colnames(freedom_final)
# Renombrar la columna 'country_name' en democracy_final para que coincida con df_original
democracy_final <- democracy_final %>%
  rename(country = country_name)
# Ver los países en cada dataset para ver si hay alguna diferencia en la nomenclatura
unique(df_original$country)
unique(democracy_final$country)
unique(freedom_final$country)

setdiff(df_original$country, democracy_final$country)
setdiff(democracy_final$country, df_original$country)
setdiff(df_original$country, freedom_final$country)
setdiff(freedom_final$country, df_original$country)
# Corrección de nombres 
df_original <- df_original %>%
  mutate(country = case_when(
    country == "Trinidad & Tobago" ~ "Trinidad and Tobago",
    country == "Somaliland region" ~ "Somaliland",
    country == "Macedonia" ~ "North Macedonia",
    country == "Palestinian Territories" ~ "State of Palestine",
    country == "Congo" ~ "Congo (Kinshasa)",
    country == "Taiwan Province of China" ~ "Taiwan",
    country == "Hong Kong S.A.R. of China" ~ "Hong Kong",
    country == "Czechia" ~ "Czech Republic",
    country == "Turkiye" ~ "Turkey",
    country == "Argelia" ~ "Algeria",
    country == "Eswatini" ~ "Swaziland",
    TRUE ~ country
  ))
democracy_final <- democracy_final %>%
  mutate(country = case_when(
    country == "Slovak Republic" ~ "Slovakia",
    country == "Korea, Republic of" ~ "South Korea",
    country == "Trinidad &Tobago" ~ "Trinidad and Tobago",
    country == "Congo, Dem. Rep." ~ "Congo (Kinshasa)",
    country == "Congo, Republic of" ~ "Congo (Brazzaville)",
    country == "Gambia, The" ~ "Gambia",
    country == "Côte d`Ivoire" ~ "Ivory Coast",
    TRUE ~ country
  ))
freedom_final <- freedom_final %>%
  mutate(country = case_when(
    country == "Northern Cyprus" ~ "North Cyprus",
    country == "The Gambia" ~ "Gambia",
    country == "Cote d'Ivoire" ~ "Ivory Coast",
    country == "Eswatini" ~ "Swaziland",
    TRUE ~ country
  ))

# PRIMER DATAFRAME: df_completo (2015-2020, con todas las variables)
df_completo <- df_original %>%
  left_join(democracy_final, by = c("country", "year")) %>%
  left_join(freedom_final, by = c("country", "year")) %>%
  filter(year >= 2015 & year <= 2020)  # Filtrar solo hasta 2020

# SEGUNDO DATAFRAME: df_sin_democracia (2015-2024, sin democracy_final)
df_sin_democracia <- df_original %>%
  left_join(freedom_final, by = c("country", "year")) %>%
  filter(year >= 2015 & year <= 2024)  # Mantener toda la información de felicidad y libertad

summary(df_completo)
summary(df_sin_democracia)

na_presence_completo <- df_completo %>%
  summarise(across(everything(), ~ any(is.na(.)), .names = "NA_{.col}"))

na_presence_sin_democracia <- df_sin_democracia %>%
  summarise(across(everything(), ~ any(is.na(.)), .names = "NA_{.col}"))

# OPCIÓN 1: ELIMINAR LOS NA
df_completo_sin_na <- df_completo %>% drop_na()
df_sin_democracia_sin_na <- df_sin_democracia %>% drop_na()

# OPCIÓN 2: SUSTITUIR LOS NA
# VARIABLES NUMÉRICAS
df_completo_numeric <- df_completo %>%
  select_if(is.numeric)
df_sin_democracia_numeric <- df_sin_democracia %>%
  select_if(is.numeric)
imputacion_completo <- mice(df_completo_numeric, method = "pmm", m = 5, maxit = 50, seed = 123)
df_completo_pmm <- complete(imputacion_completo)
imputacion_sin_democracia <- mice(df_sin_democracia_numeric, method = "pmm", m = 5, maxit = 50, seed = 123)
df_sin_democracia_pmm <- complete(imputacion_sin_democracia)
df_completo_pmm <- bind_cols(df_completo %>% select(-colnames(df_completo_numeric)), df_completo_pmm)
df_sin_democracia_pmm <- bind_cols(df_sin_democracia %>% select(-colnames(df_sin_democracia_numeric)), df_sin_democracia_pmm)
# VARIABLES CATEGÓRICAS
md.pattern(df_completo_pmm)
vis_miss(df_completo_pmm, sort_miss=TRUE)
na_presence_completo_pmm <- df_completo_pmm %>%
  summarise(across(everything(), ~ any(is.na(.)), .names = "NA_{.col}"))
df_completo_pmm <- df_completo_pmm %>%
  mutate(
    regional_indicator = case_when(
      country == "Greece" ~ "Western Europe",
      country == "Cyprus" ~ "Western Europe",
      country == "Gambia" ~ "Sub-Saharan Africa",
      TRUE ~ regional_indicator
    ),
    colony = ifelse(country == "Libya", FALSE, colony)
  ) %>%
  filter(!country %in% c("North Cyprus", "Kosovo", "Somaliland", "State of Palestine"))


md.pattern(df_sin_democracia_pmm)
vis_miss(df_sin_democracia_pmm, sort_miss=TRUE)
na_presence_sin_democracia_pmm <- df_sin_democracia_pmm %>%
  summarise(across(everything(), ~ any(is.na(.)), .names = "NA_{.col}"))
df_sin_democracia_pmm <- df_sin_democracia_pmm %>%
  mutate(
    regional_indicator = case_when(
      country == "Greece" ~ "Western Europe",
      country == "Cyprus" ~ "Western Europe",
      country == "Gambia" ~ "Sub-Saharan Africa",
      TRUE ~ regional_indicator
    ),
  ) %>%
  filter(!country %in% c("State of Palestine"))
# Eliminar territorios
df_sin_democracia_sin_na <- df_sin_democracia_sin_na %>%
  filter(tolower(country_or_territory) == "c") %>%  # Solo países

  # Eliminar la variable 'country_or_territory'
  select(-country_or_territory)
```

Observando la @fig-evolucion-variables, vemos que la esperanza de vida muestra una tendencia general al alza, con ciertas oscilaciones intermedias que podrían estar asociadas a eventos sanitarios globales como la pandemia de COVID-19. El incremento observado en 2022 es particularmente destacado y podría requerir un análisis más desagregado por región. Las variables sociales presentan comportamientos diferenciados. La percepción de corrupción (`corruption`) muestra variaciones abruptas que podrían reflejar problemas de medición o eventos políticos clave. La libertad de tomar decisiones (`freedom`) y el apoyo social (`support`) se mantienen relativamente estables, mientras que la generosidad (`generosity`) parece haber aumentado gradualmente en los últimos años. La evolución del PIB (`gdp`) muestra un aumento importante entre 2020 y 2022, que puede deberse a efectos de recuperación tras la pandemia. El `happiness_score` permanece mucho más estable a lo largo del tiempo, lo que sugiere que el crecimiento económico no se traduce automáticamente en un incremento proporcional de la felicidad percibida. Sin embargo, también podría interpretarse como un efecto con retardo, en el que los beneficios del aumento del PIB se reflejan en el bienestar subjetivo con cierto desfase temporal.

### Matriz de correlaciones

Antes de ajustar ningún modelo, es útil examinar la correlación entre las variables explicativas y la variable objetivo `happiness_score`. Esto nos permitirá identificar posibles relaciones lineales, evaluar redundancias y tomar decisiones informadas sobre qué variables incluir inicialmente en el modelo.

```{r message=FALSE, warning=FALSE, echo=FALSE}
#| label: fig-matriz
#| echo: false
#| warning: false
#| fig-cap: "Matriz de correlaciones de las variables de nuestra base de datos"
# Cargar librerías necesarias
library(corrplot)
library(GGally)
library(dplyr)

# Seleccionamos las variables de interés para el modelo
df_modelo <- df_sin_democracia_sin_na %>%
  select(happiness_score, gdp, life_exp, support, freedom, generosity, corruption)

# Calculamos la matriz de correlaciones de Pearson
cor_matrix <- cor(df_modelo, use = "complete.obs", method = "pearson")

# Visualizamos la matriz de correlaciones
corrplot(cor_matrix, method = "color", type = "upper",
         addCoef.col = "black", number.cex = 0.7, tl.cex = 0.8, tl.col = "black",
         col = colorRampPalette(c("red", "white", "blue"))(200))


```

Como se puede observar en la @fig-matriz, las correlaciones más fuertes con happiness_score corresponden a:

- `support` (0.75): el apoyo social es la variable que más se relaciona con la felicidad percibida.

- `life_exp` (0.67) y gdp (0.63): muestran relaciones importantes, lo que refleja la relevancia del bienestar económico y la salud.

- `freedom` (0.59) también presenta una relación moderada.

En cambio, variables como `generosity` (0.10) y `corruption` (0.07) muestran una relación muy débil con la felicidad, lo que hace cuestionable su relevancia explicativa. Las correlaciones entre predictores no son excesivamente altas (ninguna supera 0.8), por lo que, en principio, no se anticipan grandes problemas de multicolinealidad. Aun así, esto se verificará con el cálculo de los VIF (Variance Inflation Factor). Este indicador mide cuánto se incrementa la varianza de los coeficientes estimados debido a la multicolinealidad. Un valor de VIF superior a 5 (o en algunos contextos, a 10) suele considerarse problemático, ya que sugiere que una variable está altamente correlacionada con otras del modelo, lo que puede afectar a la estabilidad e interpretación de los coeficientes. En este trabajo se utiliza para asegurar que las variables seleccionadas no presentan una correlación excesiva entre sí.

Este análisis justifica incluir `support`, `life_exp`, `gdp` y `freedom` en una primera versión del modelo, aunque se explorarán también modelos más parciales para comparar rendimiento y parsimonia.

## Criterios de selección del modelo

Al construir un modelo estadístico, es común que existan múltiples combinaciones posibles de predictores. Para elegir la especificación más adecuada, se utilizan criterios que balancean dos aspectos fundamentales: el ajuste al conjunto de datos (qué tan bien predice el modelo los datos observados), y la complejidad del modelo (cuántos parámetros se incluyen). Dos de los criterios más utilizados para este propósito son el Akaike Information Criterion (AIC) y el Bayesian Information Criterion (BIC).

AIC penaliza la complejidad del modelo y busca minimizar la pérdida de información. Se calcula como:
$$
\text{AIC} = -2 \cdot \log(\hat{L}) + 2k
$$
donde $\hat{L}$ es la verosimilitud máxima del modelo y $k$ el número de parámetros.

BIC penaliza más fuertemente los modelos complejos (dependiendo del tamaño de muestra $n$):
$$
\text{BIC} = -2 \cdot \log(\hat{L}) + k \cdot \log(n)
$$
Un AIC o BIC más bajo indica un mejor modelo, pero el AIC tiende a seleccionar modelos más complejos (es más permisivo); mientras que el BIC favorece modelos más parsimoniosos (penaliza más la complejidad). Ambos criterios se pueden usar para comparar modelos con los mismos datos y la misma variable respuesta.

## Modelado clásico

Como punto de partida, construimos un modelo clásico de regresión lineal múltiple para explicar el `happiness_score` a partir de variables como `gdp`, `life_exp`, `support`, `freedom`, `generosity` y `corruption`. Para explorar la mejor combinación de predictores, aplicamos dos estrategias de selección de variables:

```{r message=FALSE, warning=FALSE, include=FALSE}
# Ajuste del modelo completo
modelo_completo <- lm(happiness_score ~ gdp + life_exp + support + freedom + generosity + corruption, data = df_sin_democracia_sin_na)

summary(modelo_completo)

```

### Estrategia top-down (backward elimination)

Usamos el criterio AIC y BIC para eliminar aquellas variables cuya eliminación mejora la simplicidad del modelo sin sacrificar capacidad predictiva.

```{r message=FALSE, warning=FALSE, echo=FALSE}
# Selección con AIC
modelo_step_aic <- step(modelo_completo, direction = "backward", k = 2)

# Selección con BIC
modelo_step_bic <- step(modelo_completo, direction = "backward", k = log(nrow(df_sin_democracia_sin_na)))

```

En la selección según AIC, el modelo presenta un AIC final de -1590.3, donde la variable `generosity` fue descartada por no aportar mejora significativa al modelo, lo cual concuerda con su baja correlación con la variable objetivo observada anteriormente. Por su parte, el BIC penaliza más severamente los modelos complejos, favoreciendo modelos más parsimoniosos. En este caso, el modelo óptimo según BIC también descarta `generosity`, y produce exactamente la misma especificación final que el modelo por AIC. Esto refuerza la robustez del modelo seleccionado, al coincidir ambos criterios a pesar de su diferencia en la penalización por número de parámetros.

### Estrategia bottom-up (forward selection)

También exploramos una estrategia bottom-up (selección hacia adelante), que parte de un modelo nulo y añade variables una a una en función de la mejora del AIC. Esta estrategia permite comprobar si existe alguna combinación alternativa de predictores que produzca un modelo competitivo o incluso mejor al obtenido por eliminación hacia atrás.

```{r message=FALSE, warning=FALSE, echo=FALSE}
# Modelo nulo y completo
modelo_nulo <- lm(happiness_score ~ 1, data = df_sin_democracia_sin_na)
modelo_completo <- lm(happiness_score ~ gdp + life_exp + support + freedom + generosity + corruption, data = df_sin_democracia_sin_na)

# Forward selection
modelo_step_forward <- step(modelo_nulo, scope = list(lower = modelo_nulo, upper = modelo_completo), direction = "forward")

```

En este caso, el procedimiento fue incorporando progresivamente variables hasta alcanzar el modelo completo, es decir, con todos los predictores. Este resultado contrasta con el modelo obtenido por backward elimination, en el que algunas variables eran descartadas. Esta diferencia refleja que los criterios de selección pueden llevar a soluciones distintas según el punto de partida.

En base a los resultados anteriores, el modelo final que utilizaremos es: `happiness_score ~ gdp + life_exp + support + freedom + corruption`. Este modelo muestra un equilibrio adecuado entre capacidad predictiva y parsimonia. Como veremos en la siguiente sección, se procederá ahora a evaluar el ajuste del modelo, su interpretación y su validación diagnóstica.

### Diagnóstico y validación final del modelo

Una vez seleccionado el modelo de regresión múltiple más adecuado según los criterios AIC y BIC, es fundamental verificar si cumple con las hipótesis necesarias para garantizar su validez estadística. Estas hipótesis incluyen:

- Normalidad de los residuos.

- Media cero de los residuos.

- Homoscedasticidad (varianza constante de los errores).

- Independencia de los errores.

```{r message=FALSE, warning=FALSE, echo=FALSE}
#| label: fig-modelo-clasico
#| echo: false
#| warning: false
#| fig-cap: "Gráficas para la validación del modelo clásico"
modelo_final <- lm(happiness_score ~ support + life_exp + freedom + gdp + corruption,
                   data = df_sin_democracia_sin_na)
autoplot(modelo_final, which = 1:4)

```


#### Normalidad de los residuos

Se aplica el test de Jarque-Bera para evaluar si los residuos del modelo siguen una distribución normal. El resultado indica un p-valor muy bajo, lo que nos lleva a rechazar la hipótesis de normalidad.

```{r message=FALSE, warning=FALSE, include=FALSE}
jarque.bera.test(modelo_final$residuals)
```

El p-valor obtenido es extremadamente bajo (p-value = 2.195e-10), lo que indica que los residuos no siguen una distribución normal. Esto también se confirma visualmente en el gráfico Q-Q de la @fig-modelo-clasico, donde los residuos llega un momento en el que se desvían de la línea teórica.

#### Media cero

Calculamos la media de los residuos para verificar si se aproxima a cero, como requiere el modelo. En este caso, se cumple adecuadamente:

```{r message=FALSE, warning=FALSE, include=FALSE}
mean(modelo_final$residuals)
```

Si observamos la gráfica Residuals vs Fitted en la @fig-modelo-clasico, podríamos decir que los residuos están uniformemente dispersos alrededor del eje de abscisas, por lo que se cumple la condición de que los residuos tienen media cero.

#### Homoscedasticidad

Se aplica la prueba de Breusch-Pagan para comprobar si la varianza de los errores es constante. El resultado del test devuelve un p-valor bajo, lo que sugiere la existencia de heterocedasticidad.

```{r message=FALSE, warning=FALSE, include=FALSE}
bptest(modelo_final, studentize = FALSE)

```

El gráfico de residuos frente a los valores ajustados de la @fig-modelo-clasico también muestra un patrón creciente, indicio visual de heterocedasticidad. El test devuelve un p-valor < 2.2e-16, por lo que rechazamos la hipótesis nula de homocedasticidad. Esto indica que hay heterocedasticidad en los residuos, es decir, su varianza no es constante.

#### No correlación de los errores

Mediante el test de Durbin-Watson, se verifica que no exista autocorrelación en los residuos. En este caso, el p-valor es suficientemente alto como para no rechazar la hipótesis nula, por lo que la independencia de los errores se mantiene.

```{r message=FALSE, warning=FALSE, include=FALSE}
dwtest(modelo_final)

```

Con un estadístico de Durbin-Watson de 1.4461 y un p-valor < 2.2e-16, se concluye que existe autocorrelación positiva entre los residuos.

#### Conclusión del diagnóstico

Estos incumplimientos sugieren que el modelo, aunque aparentemente ajustado, no es estadísticamente válido en un contexto longitudinal. Específicamente, ignora la dependencia entre observaciones del mismo país a lo largo del tiempo, lo que puede sesgar los resultados.

La inadecuación del modelo clásico justifica el uso de enfoques más robustos, capaces de incorporar la estructura jerárquica de los datos. En particular, los modelos lineales mixtos (LMM) permiten modelar efectos aleatorios por país, capturar la correlación intrínseca entre medidas repetidas y mejorar la validez estadística y la interpretación de los resultados. En la siguiente sección abordamos su aplicación utilizando la función lmer() del paquete lme4.

## Modelos Lineales Mixtos (LMM)

En el análisis clásico mediante regresión lineal múltiple, se asumía que las observaciones eran independientes entre sí. Sin embargo, en nuestro caso trabajamos con datos longitudinales, es decir, con observaciones repetidas a lo largo del tiempo para los mismos países. Esto introduce una dependencia entre observaciones dentro del mismo país, que los modelos clásicos no pueden capturar adecuadamente.

Para abordar esta limitación, recurrimos a los modelos lineales mixtos (LMM). Estos modelos permiten combinar efectos fijos, que capturan el efecto promedio de los predictores sobre la variable respuesta en toda la población; y efectos aleatorios, que permiten modelar la variabilidad específica entre países, incorporando interceptos (y potencialmente pendientes) distintos para cada uno. De esta forma podemos capturar la estructura jerárquica de los datos, reconociendo que cada país puede tener un nivel base de felicidad distinto (intercepto propio), mientras que los efectos de las variables predictoras son comunes a todos los países. En nuestro modelo, se consideran efectos fijos aquellas variables explicativas cuyo efecto queremos estimar de forma generalizable para toda la población (en este caso, todos los países y años). Estas variables incluyen gdp, support, freedom, life_exp, corruption y las variables políticas (is_democracy, regime_category, etc.). Se introduce un efecto aleatorio por país (intercepto aleatorio), porque cada país tiene un nivel base distinto de felicidad no explicado por las variables fijas, hay dependencia entre observaciones del mismo país en distintos años, y no nos interesa estimar el efecto específico de cada país, sino tener en cuenta la variabilidad entre ellos. En nuestro caso, el modelo lineal mixto adoptado es el siguiente:

\begin{align*}
\text{happiness}_{ij} &= \beta_0 
+ \beta_1 \cdot \text{support}_{ij} 
+ \beta_2 \cdot \text{lifeexp}_{ij} 
+ \beta_3 \cdot \text{freedom}_{ij} \\
&\quad + \beta_4 \cdot \text{gdp}_{ij} 
+ \beta_5 \cdot \text{corruption}_{ij} 
+ \beta_6 \cdot \text{generosity}_{ij} 
+ \beta_7 \cdot \text{year}_{ij} \\
&\quad + u_{0j} + \varepsilon_{ij}
\end{align*}


donde:

- $\text{happiness}_{ij}$ es la puntuación de felicidad observada para el país $j$ en el año $i$.
- `support`, `life_exp`, `freedom`, `gdp`, `corruption`, `generosity` y `year` se incluyen como efectos fijos, comunes a todos los países.
- $\beta_0, \ldots, \beta_6$ son los coeficientes de estos efectos fijos.
- $u_{0j} \sim \mathcal{N}(0, \sigma^2_u)$ representa un efecto aleatorio de intercepto para el país $j$, permitiendo variación en la felicidad media entre países.
- $\varepsilon_{ij} \sim \mathcal{N}(0, \sigma^2)$ es el término de error individual, independiente e idénticamente distribuido.

```{r message=FALSE, warning=FALSE, echo=FALSE}
library(lme4)
modelo_mixto <- lmer(happiness_score ~ support + life_exp + freedom + gdp + corruption + generosity + year + (1 + year | country), data = df_sin_democracia_sin_na)
summary(modelo_mixto)

```

Si nos fijamos en los efectos aleatorios, la desviación estándar del intercepto por país es de 0.4533, lo que refleja una importante variabilidad estructural entre países; mientras que el término residual tiene desviación estándar 0.2986, menor que la del intercepto aleatorio, lo que refuerza la utilidad del modelo mixto. Analizando los efectos fijos, vemos como todas las variables menos corruption y year son significativas; pero las variables más destacadas son support, generosity y freedom ya que son aquellas que, debido al alto valor de sus coeficientes estimados, mayor impacto tienen en el modelo.

Antes de proceder al diagnóstico exhaustivo del modelo propuesto, es importante evaluar si esta especificación es la más adecuada para los datos. Para ello, se comparan múltiples modelos candidatos que varían en los predictores incluidos, utilizando el criterio de información de Akaike (AIC), previamente descrito. En el caso de modelos mixtos, existe una distinción importante entre dos métodos de estimación.

REML (Restricted Maximum Likelihood) es un método de estimación que se utiliza en modelos mixtos para obtener estimaciones insesgadas de los componentes de varianza (es decir, de los efectos aleatorios). A diferencia de la estimación por máxima verosimilitud completa (ML, Maximum Likelihood), REML no estima directamente los efectos fijos junto con los aleatorios, sino que primero elimina el efecto de los predictores fijos del modelo, y luego maximiza la verosimilitud del modelo residual. Esto hace que REML proporcione mejores estimaciones de varianza en contextos donde la estructura de efectos fijos está bien especificada.

Por tanto, REML se recomienda cuando el objetivo principal es estimar con precisión la varianza de los efectos aleatorios, y no debe usarse para comparar modelos con diferente estructura de efectos fijos, ya que su estimación depende de esa estructura. En cambio, ML estima todos los parámetros a la vez, incluyendo efectos fijos y aleatorios, sin condicionar la estimación de la varianza, por lo que es el método adecuado cuando se pretende comparar modelos que difieren en los efectos fijos (por ejemplo, en procesos de selección de variables).

En nuestro análisis, empleamos REML para ajustar el modelo final una vez seleccionada la mejor combinación de predictores, y utilizamos ML (definiendo REML = FALSE) durante el proceso de selección de variables, que requiere comparar modelos con diferente estructura fija.

Para realizar la selección de variables en el modelo mixto final, se utilizó la función dredge() del paquete MuMIn. Esta función genera automáticamente todas las combinaciones posibles de predictores fijos a partir de un modelo base y las ordena en función de su criterio de información (por defecto, el AIC). A diferencia de otros métodos más manuales o secuenciales utilizados anteriormente, como la comparación paso a paso entre modelos, dredge() permite una exploración más sistemática del espacio de modelos posibles, siendo especialmente útil cuando el número de predictores es moderado y se desea identificar modelos que combinen buen ajuste y parsimonia.

Este enfoque complementa los métodos previos, ya que permite confirmar si el conjunto de variables seleccionadas por métodos más manuales coincide o mejora al considerar múltiples combinaciones. Cabe señalar que dredge() requiere que el modelo de entrada esté ajustado con REML = FALSE, lo que permite la comparación válida entre modelos con diferentes estructuras fijas.

El funcionamiento de dredge() parte del modelo saturado (especificado con todos los predictores que se desean considerar) y construye automáticamente una tabla con los modelos anidados posibles (es decir, con subconjuntos de predictores), ordenados según el criterio de información elegido. Así, permite explorar sistemáticamente múltiples especificaciones del modelo sin necesidad de construir manualmente cada combinación.

Además del ajuste basado en el AIC, la evaluación automática mediante dredge() permite comparar modelos en función de su simplicidad estructural y comportamiento de los residuos. Modelos con menos variables, pero similares valores de AIC, tienden a ser preferibles por su parsimonia y mejor generalización. Al seleccionar modelos con menos predictores pero buen ajuste, se reduce el riesgo de sobreajuste, lo que suele traducirse en residuos más homogéneos y con menor estructura no explicada. Esto se verifica posteriormente con herramientas de diagnóstico como los residuos simulados de DHARMa. Además, al quedarse con un subconjunto reducido de predictores relevantes, la interpretación del modelo se vuelve más sencilla y clara, permitiendo comunicar de forma más eficaz el papel de cada variable sobre la felicidad.

```{r message=FALSE, warning=FALSE, echo=FALSE}
# Cargar librerías necesarias
library(lme4)
library(MuMIn)

# Reajustamos el modelo de partida con método ML (obligatorio para comparar modelos)
modelo_mixto_ml <- lmer(
  happiness_score ~ support + life_exp + freedom + gdp + corruption + generosity + year + (1 +year| country),
  data = df_sin_democracia_sin_na,
  REML = FALSE,
  na.action = na.fail  # Esto es lo que faltaba
)

# Aplicar selección por AIC
modelo_optimo <- dredge(modelo_mixto_ml, trace = FALSE)

# Seleccionar el modelo con menor AIC
modelo_seleccionado <- get.models(modelo_optimo, 1)[[1]]
summary(modelo_seleccionado)

```

El mejor modelo identificado por dredge es aquel con el menor AICc (1292), y tiene un peso relativo de 0.284, siendo el más probable entre todos los considerados. El modelo resultante coincide exactamente con el modelo planteado anteriormente, lo cual valida empíricamente la selección inicial de predictores; por lo que no hay ninguna variable prescindible según el criterio de información.

Para evaluar la calidad del modelo, utilizaremos las siguientes medidas: el R² marginal, que representa la proporción de varianza explicada por los efectos fijos, y el R² condicional, que representa proporción de varianza explicada por todo el modelo (fijos + aleatorios).

```{r message=FALSE, warning=FALSE, echo=FALSE}
library(performance)
r2(modelo_seleccionado)
```

Evaluando el modelo, vemos que este resultado refuerza la idea de que la variabilidad entre países es muy importante para explicar la felicidad, y que ignorarla (como hacía el modelo clásico) deja gran parte de la variabilidad sin explicar. Mientras que solo un 22.5% de la variabilidad de la felicidad se explica por los predictores fijos, vemos cómo el 89.7% de la variabilidad se explica cuando se incluye el país como efecto aleatorio y se tiene en cuenta la diferencia entre países. Esto sugiere que el país tiene un peso enorme en la predicción de la felicidad, ya que, incluso controlando por PIB, salud, apoyo social, etc., hay factores estructurales o culturales no capturados en las variables que hacen que los países tengan niveles de felicidad muy distintos. En definitiva, el modelo mixto es mucho más adecuado porque capta esta variabilidad intrínseca entre países que el modelo clásico no podía capturar.

Como en cualquier modelo estadístico, es esencial verificar que las suposiciones sobre los residuos se cumplen también en el contexto de modelos mixtos. En particular, se evaluó la normalidad de los residuos, la homocedasticidad (varianza constante de los errores), y la ausencia de patrones sistemáticos entre residuos y valores ajustados. Para ello, se utilizan gráficos diagnósticos similares a los del modelo clásico, pero adaptados a la estructura jerárquica de los datos. 

```{r message=FALSE, warning=FALSE, include=FALSE}
#| label: fig-modelo-bueno
#| echo: false
#| warning: false
#| fig-cap: "Gráficas para la validación del Modelo Lineal Mixto"
library(DHARMa)
library(sjPlot)
library(glmmTMB)
# Visualización rápida
plot_model(modelo_seleccionado, type = "diag")

# Diagnóstico más riguroso
sim_res <- simulateResiduals(fittedModel = modelo_seleccionado)
plot(sim_res)
testResiduals(sim_res)
```

```{r}
#| label: fig-qqplot-residuos
#| echo: false
#| warning: false
#| fig-cap: "QQ-plot de los residuos simulados del modelo mixto"

sim_res <- DHARMa::simulateResiduals(fittedModel = modelo_seleccionado)
plotQQunif(sim_res)
```

```{r}
#| label: fig-dispersion-residuos
#| echo: false
#| warning: false
#| fig-cap: "Dispersión de los residuos simulados frente a los valores predichos"

plotResiduals(sim_res)
```

```{r}
#| label: fig-test-residuos
#| echo: false
#| warning: false
#| fig-cap: "Resultados del test formal de uniformidad aplicado a los residuos simulados"

testResiduals(sim_res)
```

### Normalidad

El gráfico QQ-plot de los residuos de la @fig-qqplot-residuos muestra una leve pero clara desviación de la diagonal teórica, especialmente en las colas, indicando una ligera asimetría y la posible presencia de valores extremos. Esta percepción se confirma al observar la curva de densidad: aunque la distribución de los residuos es aproximadamente simétrica y centrada en cero, se detecta una mayor concentración en el centro y colas algo más pesadas que las de una distribución normal, lo que apunta a una ligera leptocurtosis.

Los resultados del test de Kolmogorov-Smirnov aplicado a los residuos simulados mediante DHARMa respaldan esta observación. Con un p-valor de 0.001622, se rechaza la hipótesis nula de normalidad, lo cual confirma estadísticamente la desviación de los residuos respecto a una distribución normal.

Respecto a los efectos aleatorios del modelo, el gráfico QQ-plot de los interceptos aleatorios por país muestra un ajuste bastante bueno a la línea diagonal, con pequeñas desviaciones tolerables en los extremos. Esto sugiere que, a pesar de la no normalidad de los residuos individuales, los efectos aleatorios se distribuyen aproximadamente de forma normal.

### Homocedasticidad

El gráfico de la @fig-dispersion-residuos de dispersión de residuos de la frente a valores ajustados no muestra un patrón estructurado ni un aumento sistemático de la varianza, lo que es un indicio favorable para el cumplimiento del supuesto de homocedasticidad. Esta conclusión es reforzada por el test de dispersión de DHARMa, que arroja un p-valor de 0.92. Así, no se puede rechazar la hipótesis nula de varianza constante, confirmando que el modelo presenta homocedasticidad.

### Outliers y estructura de los residuos

Observando los test de los residuos de la figura @fig-test-residuos, observamos que el test exacto de binomial señala la presencia de 1 observacion atípica (outlier) en una muestra total de 1474, lo que representa una proporción inferior al 0.06%. Sin embargo, esta cantidad, aunque baja, es estadísticamente significativa según el p-valor obtenido (p = 0.000185), lo que indica que la proporción de outliers es ligeramente superior a la esperada por azar.

Por otro lado, el gráfico de residuos simulados frente a predichos evidencia ciertas desviaciones sistemáticas en los cuantiles, con patrones en forma de “S” en los límites superior e inferior. Esto sugiere que el modelo podría no capturar completamente alguna estructura presente en los datos, lo que debería interpretarse con precaución.

### Conclusión del diagnóstico

En conjunto, el modelo mixto ajustado presenta un comportamiento robusto en lo relativo a la homocedasticidad y a la distribución de los efectos aleatorios, y los outliers detectados son escasos y con un impacto potencialmente limitado. No obstante, persisten desviaciones moderadas respecto al supuesto de normalidad en los residuos y ciertos indicios de estructura no explicada en los cuantiles extremos.

Estas irregularidades no invalidan el modelo como herramienta de análisis, pero sí aconsejan una interpretación prudente de sus resultados, especialmente en relación con inferencias que dependan estrictamente de los supuestos clásicos del modelo lineal. En suma, el modelo resulta aceptable para los fines analíticos del estudio, aunque podría beneficiarse de futuras revisiones o mejoras (por ejemplo, modelos con términos no lineales o efectos aleatorios más complejos) si se desea perfeccionar su ajuste.

### Interpretación de coeficientes

En la tabla de efectos fijos, los coeficientes estimados (Estimate) representan el cambio esperado en la puntuación de felicidad (`happiness_score`) ante un incremento de una unidad en cada variable independiente, manteniendo constantes las demás y considerando el efecto aleatorio del país.

En el modelo final, el apoyo social aparece como uno de los factores clave en la percepción de felicidad. Aquellos países con una mayor proporción de personas que declaran contar con alguien en quien confiar muestran, en promedio, valores más altos en el índice de felicidad, incluso tras controlar por el resto de variables.

De forma similar, la libertad percibida para tomar decisiones vitales tiene un impacto notable. Los países donde la población se siente más libre para decidir sobre su vida tienden a obtener puntuaciones significativamente más elevadas en felicidad, lo que refuerza el papel central de la autonomía personal en el bienestar subjetivo.

La generosidad también contribuye positivamente, aunque en menor medida. Una cultura donde las personas tienden a ayudar o donar a otros se asocia con un mayor nivel de satisfacción vital.

En cuanto a variables estructurales, tanto la esperanza de vida como el PIB per cápita muestran efectos positivos y significativos, aunque de menor magnitud. Estos resultados sugieren que, si bien las condiciones materiales influyen, no son los únicos determinantes del bienestar.

Por el contrario, la percepción de corrupción y el año no resultan significativos en este modelo, lo que indica que su contribución a las diferencias de felicidad entre países no queda clara una vez controladas otras variables. En particular, el coeficiente negativo de year apunta a una ligera tendencia decreciente en el tiempo, aunque sin evidencia estadística suficiente.

## Selección del mejor modelo

Aunque el modelo mixto planteado inicialmente presenta un buen ajuste estadístico y explicativo, los diagnósticos revelan que no cumple completamente los supuestos teóricos fundamentales. En particular, se observa una ligera desviación de la normalidad de los residuos y una proporción de outliers ligeramente superior a la esperada por azar. Estas violaciones comprometen su idoneidad para realizar predicciones fiables.

Por este motivo, es necesario buscar un modelo alternativo que no solo tenga un buen ajuste según el criterio de información de Akaike (AIC), sino que además cumpla los supuestos fundamentales del modelo lineal mixto, entre ellos: normalidad de residuos, homocedasticidad, y baja proporción de outliers.

Para ello, partimos de un modelo mixto completo y utilizamos el procedimiento dredge() para generar múltiples modelos candidatos con diferentes combinaciones de predictores. Esta búsqueda automática identifica los modelos con mejor equilibrio entre ajuste y complejidad, evaluado mediante el AICc. Para comparar modelos con distintos efectos fijos, es necesario ajustar el modelo inicial utilizando máxima verosimilitud (ML) en lugar de REML, que solo es apropiado cuando la estructura de efectos fijos permanece constante. Para garantizar la coherencia entre el análisis del capítulo y la aplicación interactiva desarrollada, se construyó un dataframe unificado que combina los datos de felicidad (df_sin_democracia_sin_na) con las variables políticas procedentes de df_completo_sin_na. Estas variables políticas, como el tipo de régimen o la alternancia en el poder, solo están disponibles de forma fiable para el año 2020, por lo que se replicaron a todos los años del periodo 2015–2024, suponiendo estabilidad política en ese intervalo. Esta integración se realizó mediante una combinación de filtrado, expansión y unión de datos por país y año. Sobre este nuevo dataframe, denominado df_unificado, se ajustó el modelo base utilizando un modelo lineal mixto (LMM) que incluye como efectos fijos las principales variables explicativas (económicas, sociales y políticas), y como efectos aleatorios un intercepto y una pendiente específicos por país, es decir, una formulación del tipo (1 + year | country), que permite capturar tanto diferencias en el nivel inicial de felicidad como en su evolución temporal entre países.

```{r message=FALSE, warning=FALSE, include=FALSE}
library(dplyr)
library(tidyr)

# Leer los datos base (ajusta las rutas si es necesario)
df_happiness <- read.csv("df_sin_democracia_sin_na.csv")
df_politicas <- read.csv("df_completo_sin_na.csv")

# Variables políticas que se quieren mantener fijas desde 2020
vars_politicas <- c("fair_election", "regime_category", "democracy",
                    "electoral_category", "presidential", "alternation")

# Extraer valores de 2020 para esas variables
politicas_2020 <- df_politicas %>%
  filter(year == 2020) %>%
  select(country, all_of(vars_politicas))

# Filtrar df_happiness solo para países que tienen datos políticos válidos
paises_validos <- unique(politicas_2020$country)
df_happiness_filtrado <- df_happiness %>%
  filter(country %in% paises_validos)

# Expandir datos políticos de 2020 a todos los años
años <- 2015:2024
base_expansion <- expand.grid(country = paises_validos, year = años)

politicas_expandido <- base_expansion %>%
  left_join(politicas_2020, by = "country")

# Unir ambas fuentes para crear el dataframe completo
df_unificado <- df_happiness_filtrado %>%
  left_join(politicas_expandido, by = c("country", "year"))

```



```{r message=FALSE, warning=FALSE, include=FALSE}
# Cargar librerías necesarias
library(lme4)
library(MuMIn)
library(DHARMa)

# Ajustar el modelo base para selección (con df_unificado y na.fail)
modelo_base <- lmer(
  happiness_score ~ regional_indicator + gdp + support + life_exp + freedom + 
    generosity + corruption + status + political_rights + civil_liberties +
    fair_election + regime_category + democracy + electoral_category + 
    presidential + alternation + year +
    (1 + year | country),
  data = df_unificado,
  REML = FALSE,
  na.action = na.fail
)

# Aplicar selección por AIC
# modelos_dredge <- dredge(modelo_base, trace = FALSE)
# modelo_seleccionado <- get.models(modelos_dredge, 1)[[1]]
modelo_seleccionado <- modelo_base <- lmer(
  happiness_score ~ civil_liberties + electoral_category + freedom +  
    gdp + life_exp + political_rights + regime_category + regional_indicator +  
    status + support + year + (1 + year | country),
  data = df_unificado,
  REML = FALSE,
  na.action = na.fail
)
```

```{r}
summary(modelo_seleccionado)
```


La salida del modelo mixto lineal seleccionado muestra un ajuste con un gran número de predictores fijos y un efecto aleatorio de intercepto y pendiente de año por país, lo que permite capturar variaciones estructurales tanto entre países como a lo largo del tiempo. Entre los efectos fijos, se observa que freedom, life_exp y especialmente support tienen efectos positivos y estadísticamente significativos sobre el nivel de felicidad (p < 0.001 en los tres casos), lo que indica que mayores niveles de libertad percibida, esperanza de vida y apoyo social están fuertemente asociados con un mayor puntaje de felicidad. La variable civil_liberties muestra un efecto negativo significativo, lo que sugiere que una mayor ausencia de libertades civiles se relaciona con una menor felicidad. También destaca el indicador regional North America and ANZ, con un coeficiente positivo y significativo, lo que indica que esta región tiene niveles de felicidad superiores respecto a la categoría de referencia. Por el contrario, otras regiones como South Asia o Sub-Saharan Africa presentan efectos negativos y significativos, evidenciando una menor felicidad media en esas áreas. Dentro de las variables políticas, el régimen de Military dictatorship tiene un efecto negativo relevante, mientras que el statusPF (partly free) tiene un efecto positivo aunque de menor magnitud. En cuanto a los efectos aleatorios, se observa una alta varianza en el intercepto entre países, lo que indica diferencias estructurales sustanciales en el nivel base de felicidad entre ellos, mientras que el efecto aleatorio del año presenta una correlación perfecta negativa con el intercepto (–1.00), lo que puede sugerir redundancia o colinealidad en las tendencias temporales entre países. Además, el modelo presenta advertencias de convergencia y posibles problemas de identificabilidad debido a un ratio elevado de autovalores, lo que sugiere la necesidad de estandarizar variables o revisar la multicolinealidad. A pesar de ello, el modelo explica adecuadamente la variabilidad de la felicidad teniendo en cuenta factores estructurales, económicos, sociales y políticos a lo largo de países y años.

Para evaluar la calidad del modelo, utilizaremos las siguientes medidas: el R² marginal, que representa la proporción de varianza explicada por los efectos fijos, y el R² condicional, que representa proporción de varianza explicada por todo el modelo (fijos + aleatorios).

```{r message=FALSE, warning=FALSE, echo=FALSE}
library(performance)
r2(modelo_seleccionado)
```

La salida del cálculo del R² para el modelo mixto seleccionado indica que el modelo explica una parte considerable de la variabilidad del Happiness Score. En concreto, el R² marginal es de 0.702, lo que significa que aproximadamente el 70.2% de la varianza total en la felicidad se explica exclusivamente por los efectos fijos del modelo, es decir, por las variables observables incluidas como predictores (como freedom, support, life_exp, civil_liberties, indicadores políticos y regionales, entre otros). Por otro lado, el R² condicional asciende hasta 0.932, lo que implica que si además se consideran los efectos aleatorios —en este caso, las variaciones específicas de cada país y la interacción con el año— el modelo es capaz de explicar el 93.2% de la varianza total del Happiness Score. Esta gran diferencia entre el R² marginal y condicional revela que la heterogeneidad no explicada por los predictores fijos pero capturada por los efectos aleatorios, especialmente a nivel país y su evolución temporal, juega un papel clave en la explicación de la felicidad. En conjunto, estos resultados reflejan que el modelo tiene un poder explicativo muy alto, y que tanto las variables medidas como las estructuras latentes por país y año contribuyen significativamente a entender las diferencias en los niveles de felicidad.

Como en cualquier modelo estadístico, es esencial verificar que las suposiciones sobre los residuos se cumplen también en el contexto de modelos mixtos. En particular, se evaluó la normalidad de los residuos, la homocedasticidad (varianza constante de los errores), y la ausencia de patrones sistemáticos entre residuos y valores ajustados. Para ello, se utilizan gráficos diagnósticos similares a los del modelo clásico, pero adaptados a la estructura jerárquica de los datos. 

```{r}
#| label: fig-qqplot-residuos2
#| echo: false
#| warning: false
#| fig-cap: "QQ-plot de los residuos simulados del modelo mixto"

sim_res <- DHARMa::simulateResiduals(fittedModel = modelo_seleccionado)
plotQQunif(sim_res)
```

```{r}
#| label: fig-dispersion-residuos2
#| echo: false
#| warning: false
#| fig-cap: "Dispersión de los residuos simulados frente a los valores predichos"

plotResiduals(sim_res)
```

```{r}
#| label: fig-test-residuos2
#| echo: false
#| warning: false
#| fig-cap: "Resultados del test formal de uniformidad aplicado a los residuos simulados"

testResiduals(sim_res)
```


### Normalidad

El gráfico QQ-plot de la @fig-qqplot-residuos2 muestra una alineación bastante ajustada de los residuos simulados con la línea teórica, lo que sugiere una distribución aproximadamente normal. Aunque se observan ligeras desviaciones en las colas, el test de Kolmogorov-Smirnov aplicado a los residuos proporciona un p-valor de 0.06889, lo que indica que no se puede rechazar la hipótesis nula de normalidad. Por tanto, los residuos no presentan desviaciones significativas con respecto a la normalidad y el modelo cumple satisfactoriamente con este supuesto.

### Homocedasticidad

En el gráfico de residuos frente a valores ajustados de la @fig-dispersion-residuos2, la nube de puntos es dispersa y no se detecta un patrón claro de aumento o disminución de la varianza a lo largo del rango de valores predichos. El test de dispersión de DHARMa refuerza esta conclusión con un p-valor de 0.512, indicando que no existen evidencias significativas de heterocedasticidad. La varianza de los residuos puede considerarse homogénea, por lo que el modelo cumple también con el supuesto de homocedasticidad.

### Outliers y estructura de los residuos

En cuanto a los outliers, el test binomial exacto estima una proporción del 1.2% de observaciones extremas (17 de 1421), que no difiere significativamente de la esperada por azar (p = 0.09827). Esto implica que la presencia de valores extremos no es problemática. Sin embargo, el gráfico de residuos simulados frente a predicciones de la @fig-test-residuos2 revela ciertas desviaciones en los cuantiles (indicadas por las líneas rojas), y el test de cuantiles combinado resulta significativo, lo que sugiere que podrían existir ciertas estructuras residuales no completamente capturadas por el modelo, aunque no afectan gravemente al ajuste global.

### Conclusión del diagnóstico

El diagnóstico general indica que el modelo cumple de forma razonable con los tres supuestos clave: normalidad, homocedasticidad y proporción esperada de outliers. Aunque existe una ligera desviación en los cuantiles residuales, los resultados no invalidan el modelo y se puede considerar estadísticamente robusto y fiable para la inferencia y la predicción del Happiness Score. Esta validación respalda la solidez del modelo ajustado y su utilidad para explicar las variaciones en la felicidad a partir de los factores seleccionados.

### Interpretación de coeficientes

Los coeficientes estimados del modelo permiten identificar qué factores están asociados de forma significativa con el nivel de felicidad percibida en los países a lo largo del tiempo. Freedom (coef. = 1.11, p < 0.001) destaca como uno de los predictores más influyentes, indicando que, a igualdad del resto de variables, los países donde los ciudadanos sienten mayor libertad personal tienden a presentar niveles de felicidad considerablemente más altos. Del mismo modo, support (coef. = 0.69, p < 0.001) refleja una relación clara entre el respaldo social percibido y la felicidad: las personas que creen poder contar con otros en momentos difíciles tienden a valorar más positivamente su vida. También life_exp muestra una asociación positiva (coef. = 0.0069, p < 0.01), lo que sugiere que una mayor esperanza de vida suele ir acompañada de una mayor satisfacción general, probablemente porque refleja sistemas sanitarios y condiciones de vida más favorables.

Por otro lado, civil_liberties tiene un coeficiente negativo y significativo (coef. = –0.0857, p < 0.01), lo que indica que mayores restricciones en las libertades civiles están asociadas a menores niveles de felicidad. Entre las variables categóricas, destacan efectos significativos en varias categorías. Por ejemplo, los países clasificados bajo una dictadura militar presentan niveles significativamente menores de felicidad en comparación con la categoría base de régimen (coef. = –0.48, p < 0.01), lo cual concuerda con la intuición de que este tipo de regímenes tiende a restringir derechos y bienestar. También es llamativo el efecto negativo de Sub-Saharan Africa (coef. = –0.64, p < 0.001) y South Asia (coef. = –0.95, p < 0.001) en comparación con la región de referencia, lo que sugiere que, tras controlar por el resto de factores, vivir en estas regiones sigue asociado a menores niveles medios de felicidad, probablemente por desigualdades estructurales persistentes. En contraste, North America and ANZ presenta un coeficiente positivo y significativo (coef. = 0.69, p < 0.05), reflejando una tendencia sistemática a valores de felicidad más altos que el promedio global, incluso tras ajustar por factores económicos, sociales y políticos.

Aunque variables como el PIB per cápita (gdp) no resultaron estadísticamente significativas en este modelo ajustado (coef. = 0.0041, p ≈ 0.81), esto no implica que carezcan de importancia, sino que su efecto puede estar solapado o absorbido por otras variables más directamente relacionadas con el bienestar subjetivo, como el apoyo social o la percepción de libertad. En conjunto, el modelo permite interpretar que la felicidad no depende únicamente de condiciones materiales, sino que se ve fuertemente influida por factores relacionales y políticos, como la percepción de libertad, la confianza social, y las libertades civiles. Estos resultados respaldan un enfoque multidimensional para entender el bienestar, en el que el contexto democrático y el capital social resultan claves.

### Predicción del Happiness Score para 2025

Usando el modelo mixto ajustado y extrapolando con los valores más recientes disponibles, se pueden obtener predicciones personalizadas por país. Esto permite construir un ranking proyectado de felicidad para 2025.

```{r message=FALSE, warning=FALSE, echo=FALSE}
# Cargar librerías necesarias
library(lme4)
library(dplyr)

# Crear una copia de la base de datos para 2025
datos_2025 <- df_unificado

# Sustituimos el valor del año por 2025 en todas las observaciones
datos_2025$year <- 2025

# Realizamos la predicción utilizando el modelo mixto
# allow.new.levels = TRUE permite predecir incluso si hay países nuevos o no observados
datos_2025$happiness_pred_2025 <- predict(modelo_seleccionado, newdata = datos_2025, allow.new.levels = TRUE)

# Agrupar por país y calcular la media de felicidad predicha en 2025 (si hay varias filas por país)
ranking_2025 <- datos_2025 %>%
  group_by(country) %>%
  summarise(happiness_pred_2025 = mean(happiness_pred_2025, na.rm = TRUE)) %>%
  arrange(desc(happiness_pred_2025)) %>%
  mutate(rank = row_number())

# Mostrar top 10
print(head(ranking_2025, 10))

# Mostrar bottom 10
print(tail(ranking_2025, 10))

ranking_2025 %>% 
  filter(country == "Spain")

ranking_2024 <- df_unificado %>%
  filter(year == 2024) %>%
  select(country, happiness_score) %>%
  arrange(desc(happiness_score)) %>%
  mutate(rank_2024 = row_number())

ranking_2024 %>%
  filter(country == "Spain")


```

Los países nórdicos continúan liderando el ranking global del Happiness Score estimado para 2025. Se observa que Finlandia encabeza el ranking con una predicción de 7.75 puntos, consolidando su posición como líder mundial en bienestar subjetivo. Le siguen Dinamarca (7.61), Islandia (7.52) y Países Bajos (7.42), todos muy cerca entre sí, lo que refleja una estabilidad en sus altos niveles de calidad de vida. El top 10 lo completan países con economías desarrolladas y estados de bienestar consolidados como Suiza, Noruega, Suecia, Israel Nueva Zelanda y Luxemburgo, todos con puntuaciones superiores a 7.2.

En el extremo opuesto del ranking, los países con los niveles más bajos de felicidad prevista son Afganistán, que ocupa el último puesto con un valor de 2.54, seguido por Sudán del Sur, República Centroafricana y Zimbabue. Estas naciones presentan conflictos persistentes, pobreza extrema o inestabilidad política. Todas las puntuaciones están por debajo de 3.6, lo que refleja condiciones estructurales desfavorables que impactan fuertemente en el bienestar subjetivo.

Si nos fijamos en España, obtiene un Happiness Score previsto de 6.42, situándose en la posición 28. Esta puntuación refleja un nivel de felicidad moderadamente alto, por encima de la media global. Aunque no alcanza los niveles nórdicos, se encuentra en el tercio superior del ranking, lo que implica una posición destacada entre los países con mayor bienestar percibido. Aunque la puntuación de felicidad predicha para España en 2025 es la misma que para 2024, la posición en el ranking mejora: sube del puesto 35 al 28. Esto implica que otros países han bajado más que España, permitiendo su ascenso en el ranking a pesar de una leve caída en su puntuación. Es un buen ejemplo de cómo el ranking depende no solo del valor absoluto, sino también del contexto comparativo entre países.

A partir de los resultados obtenidos en este capítulo, se ha desarrollado una aplicación interactiva en Shiny que permite explorar de forma dinámica los modelos mixtos ajustados sobre los datos de felicidad. La aplicación está diseñada para que el usuario pueda seleccionar distintas combinaciones de variables fijas, así como elegir entre distintos niveles de complejidad del modelo (intercepto aleatorio, pendiente aleatoria, etc.), y visualizar tanto los coeficientes estimados como las métricas de calidad del modelo (AIC, R² marginal y condicional). Además, permite generar predicciones personalizadas por país y año, lo que convierte a la app en una herramienta potente para observar cómo se comporta el modelo bajo distintos escenarios. Esta implementación traslada al entorno interactivo todo el proceso de modelado descrito en este capítulo, permitiendo al usuario comprobar en tiempo real cómo influyen los distintos predictores sobre la felicidad y cómo se ajustan los modelos a las características longitudinales y jerárquicas de los datos.

## Desarrollo del Modelo Lineal Generalizado Mixto (GLMM)

En esta sección se explora una alternativa al modelo mixto clásico mediante un modelo lineal generalizado mixto (GLMM). Este tipo de modelos permite relajar el supuesto de normalidad de los residuos, especialmente útil cuando la variable dependiente presenta asimetría. Dado que el Happiness Score es una variable estrictamente positiva y su distribución es ligeramente asimétrica hacia la derecha, se ha optado por utilizar una distribución Gamma con enlace logarítmico.

El modelo ajustado incorpora efectos fijos para variables económicas, sociales y políticas, así como un efecto aleatorio de intercepto y pendiente por país agrupado por región ((1 + regional_indicator | country)). Esta estructura busca capturar no solo la variabilidad entre países, sino también diferencias estructurales asociadas al contexto regional de cada nación.

A diferencia del enfoque anterior basado en modelos lineales mixtos, en este caso se ha adoptado una estrategia de búsqueda automática de modelos válidos combinando variables candidatas en distintos subconjuntos. Para cada combinación se ha evaluado la validez del modelo ajustado aplicando los tests de DHARMa sobre los residuos simulados, exigiendo que se superen tres pruebas clave: uniformidad, homocedasticidad y ausencia de outliers.

La búsqueda sistemática ha identificado un modelo válido con dos predictores fijos: support (apoyo social percibido) y life_exp (esperanza de vida).

A pesar de que se han explorado sistemáticamente cientos de combinaciones de predictores posibles para ajustar un modelo lineal generalizado mixto (GLMM) válido, ninguno de los modelos obtenidos ha devuelto un valor definido para el AIC: en todos los casos, esta métrica ha aparecido como NA (Not Available). El Akaike Information Criterion (AIC) es una medida muy utilizada para comparar modelos, ya que permite evaluar el equilibrio entre calidad de ajuste y complejidad del modelo. Un AIC más bajo indica, en principio, un modelo más parsimonioso y con mejor capacidad predictiva relativa. Sin embargo, para que este criterio pueda calcularse correctamente, es necesario que el modelo se haya ajustado mediante máxima verosimilitud (ML) y que todos los componentes del modelo —incluyendo los efectos fijos, los aleatorios y los parámetros de dispersión— sean estimados de forma numéricamente estable.

El hecho de que todos los modelos válidos encontrados tengan el AIC como NA sugiere que, aunque la simulación de residuos mediante el paquete DHARMa indica un ajuste aceptable, el proceso interno de optimización del modelo ha sido inestable o degenerado en ciertos aspectos. Algunas de las posibles causas de este problema son la singularidad en los efectos aleatorios, es decir, que las varianzas estimadas para algunos componentes sean exactamente cero o que haya correlaciones perfectas entre efectos; la colinealidad alta entre predictores fijos y/o aleatorios, lo que dificulta la identificación de los parámetros; la redundancia estructural en el modelo (por ejemplo, efectos aleatorios innecesarios o mal definidos); o ciertos problemas numéricos durante la optimización de la log-verosimilitud penalizada, que impiden calcular la función objetivo de forma precisa.

Es importante destacar que el hecho de que el AIC sea NA no implica necesariamente que el modelo sea inválido, sino que no se puede evaluar su calidad relativa frente a otros modelos utilizando esta métrica. En este trabajo, para priorizar la validez estadística del modelo (basada en la uniformidad, homocedasticidad y ausencia de outliers en los residuos simulados), se ha optado por aceptar modelos con AIC NA, aunque se documenta esta limitación de forma explícita. En futuras investigaciones, una posible solución sería reducir la complejidad de la estructura aleatoria o limitar el número de predictores simultáneamente considerados, lo que podría estabilizar la estimación del modelo y permitir el cálculo correcto del AIC.

```{r message=FALSE, warning=FALSE, echo=FALSE}
# Cargar librerías necesarias
library(glmmTMB)
library(MuMIn)
library(DHARMa)
library(tidyverse)

# Modelo GLMM válido
glmm_valido <- glmmTMB(
  happiness_score ~ support + life_exp + (1 + regional_indicator | country),
  data = df_unificado,
  family = Gamma(link = "log"),
  na.action = na.fail
)
summary(glmm_valido)

```

La salida del modelo generalizado mixto (GLMM) ajustado muestra un modelo con una estructura aleatoria por país que incluye la variación de la región (regional_indicator) dentro de cada país, lo que permite capturar diferencias contextuales regionales en el efecto de la felicidad. Este modelo ha sido ajustado utilizando una distribución Gamma con enlace logarítmico, lo que resulta apropiado dado que el Happiness Score es una variable continua y estrictamente positiva, con una ligera asimetría hacia la derecha.

Entre los efectos fijos, se observa que tanto support como life_exp tienen efectos positivos y altamente significativos sobre el nivel de felicidad (p < 0.001 en ambos casos). El coeficiente de support es de 0.2141, lo que implica que, manteniendo constantes el resto de variables, un incremento de una unidad en el nivel de apoyo social está asociado con un incremento multiplicativo de aproximadamente un 24% (exp(0.2141) ≈ 1.24) en el valor esperado del Happiness Score. Este resultado refuerza la idea de que el respaldo social percibido tiene un fuerte vínculo con el bienestar subjetivo. Por su parte, el coeficiente de life_exp es de 0.00207, lo que significa que por cada año adicional de esperanza de vida, el Happiness Score se incrementa en torno a un 0.2%, lo cual refleja que las condiciones sanitarias y de longevidad están positivamente relacionadas con la percepción de felicidad.

En cuanto a los efectos aleatorios, se observa una importante varianza del intercepto entre países (0.01104), lo que indica que existen diferencias estructurales en el nivel base de felicidad que no son explicadas por las variables fijas incluidas. Además, se ha modelado la variabilidad del efecto de regional_indicator dentro de cada país, permitiendo que la influencia de la región sobre la felicidad varíe de forma diferenciada entre países. Este enfoque resulta útil para capturar las dinámicas regionales internas, aunque algunos de los componentes de esta estructura muestran varianzas cercanas a cero (como en el caso de Latin America and Caribbean) o correlaciones extremas entre efectos aleatorios (–1.00 o 1.00), lo que puede indicar problemas de colinealidad o redundancia estadística en determinadas regiones. Por ejemplo, las correlaciones perfectas observadas en South Asia o North America and ANZ podrían reflejar que, en esos contextos, los efectos de la región están perfectamente alineados con los del país, reduciendo la utilidad práctica de esa complejidad adicional en la estructura aleatoria.

Por último, el modelo presenta un estimador de dispersión (σ²) de 0.00503, lo que indica una baja variabilidad residual después de ajustar el modelo, y sugiere un buen ajuste global del modelo Gamma con enlace logarítmico. Esta baja dispersión es coherente con los resultados obtenidos en la validación previa, donde se confirmó que el modelo cumple con los supuestos de uniformidad, homocedasticidad y ausencia de outliers problemáticos mediante los tests del paquete DHARMa.

En conjunto, este modelo GLMM permite capturar de forma eficaz la relación entre felicidad y factores sociales y sanitarios, teniendo en cuenta también la variabilidad específica de cada país y región. Aunque su estructura aleatoria compleja aporta flexibilidad, los signos de redundancia en ciertas regiones invitan a considerar modelos más parsimoniosos en futuras investigaciones. Aun así, el modelo ajustado se muestra estadísticamente válido y útil para la predicción y explicación del Happiness Score en contextos internacionales.

```{r message=FALSE, warning=FALSE, echo=FALSE}
library(performance)
r2(glmm_valido)
```

Se ha calculado el R² marginal para el modelo GLMM, obteniendo un valor de 0.387, lo que indica que los efectos fijos del modelo explican aproximadamente el 38.7% de la varianza del Happiness Score. Sin embargo, no ha sido posible calcular el R² condicional (que incluye la contribución de los efectos aleatorios) debido a que varios componentes de la estructura aleatoria presentan varianzas nulas o cercanas a cero, lo que genera problemas de identificabilidad y singularidad. Además, el modelo incluye pendientes aleatorias no reflejadas como efectos fijos, lo que impide una estimación fiable de la varianza total explicada. Este comportamiento es común en modelos GLMM con estructuras complejas o redundantes, y no compromete la validez del modelo en términos de significación y ajuste, pero limita la interpretación cuantitativa del componente aleatorio.

Al igual que hicimos antes, vamos a comprobar que este modelo es válido para poder hacer predicciones.

```{r}
#| label: fig-qqplot-residuos3
#| echo: false
#| warning: false
#| fig-cap: "QQ-plot de los residuos simulados del modelo mixto"

sim_res <- DHARMa::simulateResiduals(fittedModel = glmm_valido)
plotQQunif(sim_res)
```

```{r}
#| label: fig-dispersion-residuos3
#| echo: false
#| warning: false
#| fig-cap: "Dispersión de los residuos simulados frente a los valores predichos"

plotResiduals(sim_res)
```

```{r}
#| label: fig-test-residuos3
#| echo: false
#| warning: false
#| fig-cap: "Resultados del test formal de uniformidad aplicado a los residuos simulados"

testResiduals(sim_res)
```

### Normalidad de residuos 

El gráfico QQ-plot de residuos de la @fig-qqplot-residuos3 simulados muestra una alineación bastante razonable con la línea diagonal, sin grandes desviaciones sistemáticas. El test de Kolmogorov-Smirnov aplicado a los residuos simulados arroja un p-valor de 0.071, por encima del umbral convencional de 0.05. Esto indica que no se puede rechazar la hipótesis de uniformidad en la distribución de los residuos, cumpliendo así el supuesto análogo de normalidad en modelos GLMM.

### Homocedasticidad 

El test de dispersión de DHARMa compara la desviación estándar de los residuos ajustados frente a los simulados. Se obtiene un p-valor de 0.176, lo que indica que no hay evidencia significativa de heterocedasticidad. El gráfico de residuos frente a predicciones de la @fig-dispersion-residuos3 tampoco muestra patrones preocupantes de varianza creciente o decreciente. En este aspecto, el modelo cumple adecuadamente con el supuesto de homocedasticidad.

### Outliers y estructura de los residuos

El test binomial detecta 7 outliers en un total de 1421 observaciones, lo que representa un 0.49%, inferior al valor esperado (0.8%). El p-valor = 0.2325 indica que la proporción observada de valores extremos no difiere significativamente de la que cabría esperar por azar. Por tanto, no hay indicios de que los outliers estén afectando de manera relevante el ajuste del modelo.

Aunque los test formales indican adecuación, el gráfico de residuos frente a valores ajustados de la @fig-test-residuos3 muestra curvas de cuantiles que se desvían del comportamiento aleatorio esperado, lo que ha llevado a que el test combinado de cuantiles sea significativo. Esto sugiere la posible existencia de estructuras residuales no capturadas completamente por el modelo, probablemente relacionadas con interacciones o efectos omitidos. Sin embargo, la magnitud de estas desviaciones no parece invalidar el modelo ni afectar gravemente su interpretación.

### Conclusión del modelo GLMM

El modelo GLMM con distribución Gamma y enlace logarítmico ha permitido ajustar el Happiness Score como una variable continua estrictamente positiva. A pesar de ciertos problemas menores de singularidad y de que no se puede calcular el R² condicional, los diagnósticos de residuos indican un ajuste razonable. Los supuestos clave (uniformidad, homocedasticidad, ausencia de outliers extremos) se cumplen, y el modelo se considera estadísticamente válido.

La interpretación de los efectos fijos confirma que tanto el apoyo social como la esperanza de vida son predictores positivos y significativos de la felicidad, lo cual es consistente con la teoría y con los resultados del modelo LMM. El modelo GLMM ofrece una alternativa robusta al LMM cuando se desea modelar directamente la variable de interés sin asumir distribución normal de los residuos, y proporciona evidencia complementaria sobre los factores clave que explican el bienestar subjetivo en el mundo.

### Interpretación de coeficientes

Los resultados del modelo indican que la felicidad de los países está fuertemente asociada con factores sociales y de salud. En concreto, el apoyo social aparece como el factor más influyente: los países en los que las personas sienten que pueden contar con los demás en momentos difíciles tienden a mostrar niveles de felicidad claramente superiores. Este resultado refuerza la idea de que el bienestar no solo depende de condiciones materiales, sino de las relaciones y la cohesión social. La sensación de estar respaldado por la comunidad o por seres cercanos parece ser un pilar fundamental del bienestar subjetivo.

Por otro lado, también se ha identificado un efecto positivo de la esperanza de vida. Aunque su impacto es más moderado, los países con una mayor longevidad presentan, en promedio, niveles más altos de felicidad. Esto sugiere que vivir más años, presumiblemente en mejores condiciones de salud, se asocia con una valoración más positiva de la vida. No se trata solo de la duración, sino de lo que implica: sistemas sanitarios funcionales, calidad del entorno, cuidados adecuados y menor incertidumbre vital.

En conjunto, el modelo refleja que tanto el bienestar relacional como las condiciones básicas de salud son factores clave para entender las diferencias en la felicidad percibida entre países. Estos hallazgos coinciden con la literatura en psicología positiva y estudios de bienestar, que resaltan el papel del entorno social y las condiciones de vida dignas como componentes esenciales de la satisfacción vital. Así, el modelo no solo confirma lo que ya se intuía, sino que lo cuantifica de manera robusta en un contexto longitudinal y global.

### Predicción del Happiness Score para 2025

Al igual que en el modelo lineal mixto, se utiliza el modelo GLMM validado para estimar el nivel de felicidad en cada país en el año 2025. Este modelo tiene en cuenta la estructura jerárquica de los datos (países agrupados con efectos aleatorios) y utiliza una distribución Gamma con enlace logarítmico, adecuada para modelar la variable de felicidad por ser estrictamente positiva y asimétrica.

```{r message=FALSE, warning=FALSE, echo=FALSE}
# Cargar librerías necesarias
library(glmmTMB)
library(dplyr)

# Crear una copia del dataset para 2025
datos_2025 <- df_unificado
datos_2025$year <- 2025

# Realizar predicción usando el modelo GLMM válido
# allow.new.levels = TRUE permite predecir aunque haya países nuevos o no observados en la estimación
datos_2025$happiness_pred_2025 <- predict(glmm_valido, newdata = datos_2025, type = "response", allow.new.levels = TRUE)

# Agrupar por país y calcular la media (por si hay múltiples filas por país)
ranking_glmm_2025 <- datos_2025 %>%
  group_by(country) %>%
  summarise(happiness_pred_2025 = mean(happiness_pred_2025, na.rm = TRUE)) %>%
  arrange(desc(happiness_pred_2025)) %>%
  mutate(rank = row_number())

# Mostrar el top 10 y bottom 10 del ranking
print(head(ranking_glmm_2025, 10))
print(tail(ranking_glmm_2025, 10))

# Predicción específica para España
ranking_glmm_2025 %>% filter(country == "Spain")

# Comparación con 2024
ranking_2024 <- df_unificado %>%
  filter(year == 2024) %>%
  select(country, happiness_score) %>%
  group_by(country) %>%
  summarise(happiness_score = mean(happiness_score, na.rm = TRUE)) %>%
  arrange(desc(happiness_score)) %>%
  mutate(rank_2024 = row_number())

# Puntuación y ranking de España en 2024
ranking_2024 %>% filter(country == "Spain")



```

Los resultados de la predicción muestran que los países nórdicos continúan liderando el ranking de felicidad mundial: Finlandia encabeza la lista con una puntuación estimada de 7.63, seguida por Dinamarca (7.54), Islandia (7.48) y Noruega (7.42). Otros países del top 10 incluyen a Suiza, Países Bajos, Suecia, Nueva Zelanda, Israel y Australia, todos con puntuaciones por encima de 7.1. Esta concentración de países desarrollados con altos niveles de bienestar refleja el impacto consistente de factores como la cohesión social, el acceso a servicios de calidad y condiciones de vida estables.

En contraste, los países con las puntuaciones más bajas en felicidad predicha para 2025 son Afganistán (2.86), República Centroafricana (3.23), Burundi (3.30), Sudán del Sur (3.30), y Ruanda (3.42). Estas naciones se caracterizan por inestabilidad política, pobreza extrema, o conflictos prolongados, lo que probablemente reduce tanto el apoyo social como la esperanza de vida, las dos variables clave en el modelo.

En cuanto a España, se predice un Happiness Score de 6.39 para 2025, lo que la sitúa en la posición 31 del ranking mundial. Esta puntuación representa una ligera disminución respecto al valor observado en 2024 (6.42), pero supone una mejora en la clasificación, ya que sube del puesto 35 al 31. Esta subida refleja que, aunque la puntuación de España apenas varía, otros países han experimentado mayores caídas, permitiendo que España ascienda en el ranking relativo. Es decir, su mejora no es tanto por avance propio como por retroceso ajeno.

Estos resultados subrayan que incluso un modelo con solo dos predictores —apoyo social y esperanza de vida— puede captar de forma significativa las diferencias estructurales en felicidad entre países. Además, las predicciones realizadas con este GLMM son consistentes con las tendencias observadas en informes previos y refuerzan la idea de que la percepción de apoyo social y la longevidad son factores clave del bienestar subjetivo a nivel global.