---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r include=FALSE, warning=FALSE}
library(readr)
library(readxl)
library(janitor)
library(mice)
library(visdat)
library(outliers)
library(plotly)
library(tidyverse)
library(webshot2)
library(lmtest)      # Para bptest() y dwtest()
library(tseries)     # Para jarque.bera.test()
library(ggfortify)   # Para autoplot() del modelo

```

# Construcción del modelo

```{r message=FALSE, warning=FALSE, include=FALSE}
library(ggplot2)
knitr::opts_chunk$set(
  fig.width = 6, 
  fig.height = 4, 
  dev = "png",
  fig.align = "center"
)
theme_set(theme_minimal(base_size = 12))
```


En este capítulo desarrollamos el proceso de construcción de un modelo estadístico para explicar y predecir la percepción de felicidad (Happiness Score) a lo largo del tiempo, utilizando los datos longitudinales disponibles para todos los países entre los años 2015 y 2024. Dado que el análisis de este trabajo se centra en la evolución de la felicidad en el tiempo, consideramos esencial aprovechar toda la información disponible, en lugar de limitar el estudio a una única foto fija (por ejemplo, el año 2024).

El propósito del capítulo es construir un modelo que sea estadísticamente sólido y, al mismo tiempo, interpretable desde el punto de vista de los determinantes sociales, económicos y políticos de la felicidad. Para ello, combinaremos técnicas de la estadística clásica (regresión lineal múltiple) con modelos diseñados específicamente para datos longitudinales, como los modelos lineales mixtos (LMM) y los modelos lineales generalizados mixtos (GLMM), que permiten capturar adecuadamente la estructura jerárquica de los datos y la dependencia entre observaciones repetidas.

El modelado clásico se abordará desde dos estrategias complementarias:

- **Top-down**: partimos de un modelo completo que incluye todas las variables relevantes, y vamos eliminando aquellas que no aportan información significativa o que generan problemas como multicolinealidad o sobreajuste.

- **Bottom-up**: comenzamos con un modelo simple con pocas variables y vamos añadiendo progresivamente nuevos predictores, evaluando si su inclusión mejora sustancialmente el ajuste del modelo.

Ambas estrategias nos permiten explorar distintas trayectorias de construcción del modelo y encontrar un equilibrio entre simplicidad, robustez y capacidad explicativa. Como veremos, en este caso ambas estrategias convergen en el mismo modelo final, el cual, sin embargo, no resulta válido tras el análisis diagnóstico.

En cambio, para los modelos mixtos (LMM y GLMM) seguimos un enfoque orientado a la validación empírica: partimos directamente de estructuras con efectos aleatorios y efectos fijos específicos, evaluando su adecuación con herramientas gráficas y pruebas estadísticas. En el caso del LMM se emplea una estructura con todas las variables como efectos fijos y `year` como efecto aleatorio por país, mientras que para el GLMM se exploran múltiples combinaciones hasta identificar un modelo válido con distribución Gamma y `regional_indicator` como efecto aleatorio.

Dado que trabajamos con datos que varían a lo largo del tiempo para cada país, es importante distinguir entre:

- **Variables longitudinales**: cambian con el tiempo (por ejemplo, `gdp`, `support`, `freedom`, `generosity`, `life_exp`, `corruption`).

- **Variables fijas**: son aquellas que no cambian a lo largo del tiempo dentro del periodo de análisis, o que se consideran características estructurales del país. Se utilizan como contexto porque aportan información relevante sobre el entorno político o geográfico en el que se sitúa cada observación. Por ejemplo, `region` indica la ubicación geográfica del país y puede influir en aspectos culturales, económicos o sociales. También forman parte de este grupo las variables institucionales que hemos incorporado desde otras bases de datos y que hemos replicado para todos los años: por ejemplo, `is_democracy`, `regime_category`, `has_free_and_fair_election` o `has_alternation`, que capturan características políticas del país (como su régimen democrático o nivel de alternancia política) que no cambian durante el periodo 2015–2024 y se usan como una “foto” fija del contexto institucional.

Además, es importante tener en cuenta la dependencia temporal entre observaciones del mismo país. Este aspecto será considerado al ajustar modelos mixtos con interceptos (y potencialmente pendientes) aleatorios por país.

En cuanto a la organización del capítulo, comenzaremos describiendo la estrategia general de modelado y los criterios de selección de variables en el caso de la regresión lineal múltiple. A continuación, se presentará el modelo clásico resultante y se evaluará su validez. Posteriormente, se abordarán los modelos lineales mixtos (LMM), detallando aquel que resultó válido y se utilizó para predecir la evolución del Happiness Score. Finalmente, se explorarán modelos generalizados mixtos (GLMM) con distribución Gamma, evaluando su adecuación para modelar esta variable continua positiva. El capítulo concluirá con una comparación crítica de los modelos ajustados y una reflexión sobre sus implicaciones prácticas.

## Análisis exploratorio y selección inicial de variables

Aunque ya se analizó previamente la estructura de los datos, antes de ajustar cualquier modelo es útil revisar de nuevo las características más relevantes desde una perspectiva predictiva, identificando posibles problemas (como valores faltantes o outliers) y seleccionando las variables que podrían actuar como buenos predictores del `happiness_score`.

### Estructura del dataset longitudinal

Nuestro conjunto de datos contiene observaciones anuales de múltiples países en el período 2015–2024. Para cada país y año, disponemos de una serie de variables socioeconómicas y de percepción ciudadana. Las variables disponibles, descritas en el capítulo anterior, son: `regional_indicator`, `gdp`, `support`, `life_exp`, `freedom`, `generosity`, `corruption`, `status`, `political_rights`,  `civil_liberties`, `fair_election`, `regime_category`, `democracy`, `electoral_category`, `presidential`, `alternation` y `year`.

Dado el enfoque longitudinal del estudio, empleamos `country` como unidad de agrupación para modelar efectos aleatorios específicos de cada país a lo largo del tiempo, permitiendo así capturar variaciones propias de cada trayectoria nacional. Por otro lado, la variable `year` se incluye como efecto fijo, ya que representa un factor temporal compartido por todos los países, aunque su tratamiento como efecto aleatorio se explora en los modelos mixtos más complejos; bajo la hipótesis de que los años representan una muestra de una población más amplia de momentos temporales posibles, y nos interesa capturar su variabilidad global.

### Visualización y evolución temporal de las variables

Antes de proceder al ajuste del modelo, es útil examinar cómo evolucionan las principales variables explicativas a lo largo del tiempo. En la @fig-evolucion-variables se muestran los gráficos de evolución de tres de las variables más relevantes: `Happiness Score`, `Percepción de Corrupción` y `Generosidad`. Estas variables han sido seleccionadas por su potencial impacto en el bienestar subjetivo y por su comportamiento representativo del conjunto de predictores considerados. El resto de variables presentan patrones temporales más estables o menos informativos visualmente.

Esta visualización permite identificar posibles tendencias globales y diferencias regionales o entre países, lo cual resulta clave para motivar la elección de modelos que incorporen estructura longitudinal y efectos aleatorios por país.

```{r}
#| label: fig-evolucion-variables
#| echo: false
#| warning: false
#| fig-cap: "Evolución de la media anual de las variables felicidad, generosidad y percepción de corrupción (2015-2024)."
#| fig-width: 5
#| fig-height: 3.5
library(ggplot2)
library(dplyr)
library(patchwork)
df_sin_democracia_sin_na <- read.csv("df_sin_democracia_sin_na.csv")
df_sin_democracia_sin_na <- read.csv("df_sin_democracia_sin_na.csv")
# Dataset filtrado
df_temp <- df_sin_democracia_sin_na %>%
  filter(year %in% 2015:2024) %>%
  group_by(year) %>%
  summarise(
    felicidad = mean(happiness_score, na.rm = TRUE),
    generosidad = mean(generosity, na.rm = TRUE),
    corrupcion = mean(corruption, na.rm = TRUE)
  )

# Gráfico 1: Felicidad
g1 <- ggplot(df_temp, aes(x = factor(year), y = felicidad)) +
  geom_line(color = "#1b9e77", size = 1.2) +
  geom_point(color = "#1b9e77", size = 2) +
  labs(y = "Felicidad", x = NULL) +
  theme_minimal()  

# Gráfico 2: Generosidad
g2 <- ggplot(df_temp, aes(x = factor(year), y = generosidad)) +
  geom_line(color = "#d95f02", size = 1.2) +
  geom_point(color = "#d95f02", size = 2) +
  labs(y = "Generosidad", x = NULL) +
  theme_minimal()  

# Gráfico 3: Corrupción
g3 <- ggplot(df_temp, aes(x = factor(year), y = corrupcion)) +
  geom_line(color = "#7570b3", size = 1.2) +
  geom_point(color = "#7570b3", size = 2) +
  labs(y = "Corrupción", x = "Año") +
  theme_minimal()  

# Composición con patchwork
(g1 / g2 / g3) +
  plot_annotation(title = "Evolución temporal de variables clave (2015-2024)")
```

```{r warning=FALSE, include=FALSE}
# Carga de paquetes 
library(readr)
library(readxl)
library(janitor)
library(mice)
library(visdat)
library(outliers)
library(plotly)
library(tidyverse)
library(webshot2)

# Cargamos los datos 
df_original <- read_delim("world_happiness_combined.csv", delim = ";", show_col_types = FALSE)
# Limpiar nombres de columnas
df_original <- clean_names(df_original)
summary(df_original)
str(df_original)
# Hay algunas variables numérias que están puestas como categóricas
df_original <- df_original %>%
  mutate(
    gdp_per_capita = as.numeric(gsub(",", ".", gdp_per_capita)),
    social_support = as.numeric(gsub(",", ".", social_support)),
    freedom_to_make_life_choices = as.numeric(gsub(",", ".", freedom_to_make_life_choices)),
    generosity = as.numeric(gsub(",", ".", generosity)),
    perceptions_of_corruption = as.numeric(gsub(",", ".", perceptions_of_corruption))
  )
# Verificar que ahora sean numéricas
str(df_original)
# Hay un problema con las comas en el happiness score
df_original$happiness_score <- df_original$happiness_score / 100000
# Datos faltantes
is.na(df_original)
# En la base de datos no hay ningún dato faltante

# Detección de Outliers
boxplot(df_original$happiness_score)
boxplot(df_original$gdp_per_capita)
boxplot(df_original$social_support)  
boxplot(df_original$healthy_life_expectancy)
boxplot(df_original$freedom_to_make_life_choices)
boxplot(df_original$generosity)
boxplot(df_original$perceptions_of_corruption)
# Como podemos apreciar gráficamente, hay algunas variables numéricas en las que puede haber valores atípicos
outliers::grubbs.test(df_original$happiness_score)
outliers::grubbs.test(df_original$gdp_per_capita)
outliers::grubbs.test(df_original$social_support)
outliers::grubbs.test(df_original$healthy_life_expectancy)
outliers::grubbs.test(df_original$freedom_to_make_life_choices)
outliers::grubbs.test(df_original$generosity)
outliers::grubbs.test(df_original$perceptions_of_corruption)
# Como el p-valor es > alpha en todos los test, no tenemos outliers
df_original <- df_original %>%
  rename(
    gdp = gdp_per_capita,
    support = social_support,
    life_exp = healthy_life_expectancy,
    freedom = freedom_to_make_life_choices,
    generosity = generosity,
    corruption = perceptions_of_corruption
  )
```

```{r include=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(stringr)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(htmlwidgets)
## FREEDOM IN THE WORLD
freedom_todos <- read_excel("All_data_FIW_2013-2024 (1).xlsx", sheet = "FIW13-25", skip = 1)
### Las variables que nos pueden llegar a interesar son:
#### Country/Territory (necesitamos el país/territorio)
#### Region (aunque sea muy parecida a la de regional_indicator, nos puede ser de utilidad)
#### c/T (indica si es país o territorio, aunque no se si deberíamos de meternos con el concepto de soberanía)
#### Edition (necesitamos el año)
#### Status (clasifica la libertad del país)
#### PR (derechos políticos) rating y CL (libertades civiles) rating (la otra opción sería elegir PR, CL y Total porque el rating va de 1 a 7)
freedom_final <- freedom_todos %>%
  select(
    `Country/Territory`, # Nombre del país o territorio
    `Region`,            # Región geográfica
    `C/T`,               # Indica si es país (c) o territorio (t)
    `Edition`,           # Año de edición de los datos
    `Status`,            # Clasificación de libertad (Libre, Parcialmente Libre, No Libre)
    `PR rating`,         # Puntuación de derechos políticos (1-7)
    `CL rating`          # Puntuación de libertades civiles (1-7)
  ) %>%
  rename(
    country = `Country/Territory`,
    region = `Region`,
    country_or_territory = `C/T`,
    year = `Edition`,
    status = `Status`,
    political_rights = `PR rating`,
    civil_liberties = `CL rating`
  )
freedom_final <- freedom_final %>%
  filter(year >= 2015 & year <= 2024)
## DEMOCRACY DATA ==> DEMOCRACY AND DICTATORSHIP
library(democracyData)
democracy_data <-
  democracyData::pacl_update |> 
  janitor::clean_names() |> 
  dplyr::select(
    "country_name" = "pacl_update_country",
    "country_code" = "pacl_update_country_isocode",
    "year",
    "regime_category_index" = "dd_regime",
    "regime_category" = "dd_category",
    "is_monarchy" = "monarchy",
    "is_commonwealth" = "commonwealth",
    "monarch_name",
    "monarch_accession_year" = "monarch_accession",
    "monarch_birthyear",
    "is_female_monarch" = "female_monarch",
    "is_democracy" = "democracy",
    "is_presidential" = "presidential",
    "president_name",
    "president_accesion_year" = "president_accesion",
    "president_birthyear",
    "is_interim_phase" = "interim_phase",
    "is_female_president" = "female_president",
    "is_colony" = "colony",
    "colony_of",
    "colony_administrated_by",
    "is_communist" = "communist",
    "has_regime_change_lag" = "regime_change_lag",
    "spatial_democracy",
    "parliament_chambers" = "no_of_chambers_in_parliament",
    "has_proportional_voting" = "proportional_voting",
    "election_system",
    "lower_house_members" = "no_of_members_in_lower_house",
    "upper_house_members" = "no_of_members_in_upper_house",
    "third_house_members" = "no_of_members_in_third_house",
    "has_new_constitution" = "new_constitution",
    "has_full_suffrage" = "fullsuffrage",
    "suffrage_restriction",
    "electoral_category_index" = "electoral",
    "spatial_electoral",
    "has_alternation" = "alternation",
    "is_multiparty" = "multiparty",
    "has_free_and_fair_election" = "free_and_fair_election",
    "parliamentary_election_year",
    "election_month" = "election_month_year",
    "has_postponed_election" = "postponed_election"
  ) |>
  dplyr::mutate(
    election_month = dplyr::na_if(.data$election_month, "?")
  ) |> 
  tidyr::separate_wider_regex(
    "election_month",
    patterns = c(
      election_month = "\\D+",
      election_year = "\\d{4}$"
    ),
    too_few = "align_start"
  ) |> 
  dplyr::mutate(
    electoral_category = dplyr::case_match(
      .data$electoral_category_index,
      0 ~ "no elections",
      1 ~ "single-party elections",
      2 ~ "non-democratic multi-party elections",
      3 ~ "democratic elections"
    ),
    .after = "electoral_category_index"
  ) |> 
  dplyr::mutate(
    election_month = stringr::str_squish(.data$election_month),
    dplyr::across(
      c(
        tidyselect::ends_with("_index"),
        tidyselect::contains("year"),
        tidyselect::ends_with("_members"),
        "parliament_chambers"
      ),
      as.integer
    ),
    dplyr::across(
      c(
        tidyselect::starts_with("is_"),
        tidyselect::starts_with("has_")
      ),
      as.logical
    )
  )
### Las variables que nos pueden llegar a interesar son:
#### country_name (necesitamos el país/territorio)
#### year (año)
#### regime_category (Parliamentary democracies, Mixed democracies (with weak presidents), Presidential democracies, Civilian autocracies, Military dictatorships, Royal dictatorships)
#### is_monarchy (es monarquía o no)
#### is_democracia (es democracia o no)
#### is_presidential (es presidencial o no)
#### is_colony (es colonia o no)
#### is_communist (es comunista o no)
#### spatial_democracy (como de democráticos son sus países vecinos) 
#### has_full_suffrage (tiene sufragio universal o no)
#### electoral_category (No elections, Single-party elections, non-democratic multi-party elections, democratic elections)
#### spatial_electoral (cómo son las elecciones en sus países vecinos)
#### has_free_and_fair_election (tienen elecciones justas o no)
#### has_alternation (cambian de gobierno o no)
democracy_final <- democracy_data %>%
  select(
    country_name, 
    year, 
    regime_category, 
    is_monarchy, 
    is_democracy, 
    is_presidential, 
    is_colony, 
    is_communist, 
    spatial_democracy, 
    has_full_suffrage, 
    electoral_category, 
    spatial_electoral, 
    has_free_and_fair_election, 
    has_alternation
  ) %>%
  rename(
    monarchy = is_monarchy,
    democracy = is_democracy,
    presidential = is_presidential,
    colony = is_colony,
    communist = is_communist,
    sp_democracy = spatial_democracy,
    suffrage = has_full_suffrage,
    sp_electoral = spatial_electoral,
    fair_election = has_free_and_fair_election,
    alternation = has_alternation
  )
democracy_final <- democracy_final %>%
  filter(year >= 2015 & year <= 2024)
## UNIÓN DE LOS DATASETS
colnames(df_original)
colnames(democracy_final)
colnames(freedom_final)
# Renombrar la columna 'country_name' en democracy_final para que coincida con df_original
democracy_final <- democracy_final %>%
  rename(country = country_name)
# Ver los países en cada dataset para ver si hay alguna diferencia en la nomenclatura
unique(df_original$country)
unique(democracy_final$country)
unique(freedom_final$country)

setdiff(df_original$country, democracy_final$country)
setdiff(democracy_final$country, df_original$country)
setdiff(df_original$country, freedom_final$country)
setdiff(freedom_final$country, df_original$country)
# Corrección de nombres 
df_original <- df_original %>%
  mutate(country = case_when(
    country == "Trinidad & Tobago" ~ "Trinidad and Tobago",
    country == "Somaliland region" ~ "Somaliland",
    country == "Macedonia" ~ "North Macedonia",
    country == "Palestinian Territories" ~ "State of Palestine",
    country == "Congo" ~ "Congo (Kinshasa)",
    country == "Taiwan Province of China" ~ "Taiwan",
    country == "Hong Kong S.A.R. of China" ~ "Hong Kong",
    country == "Czechia" ~ "Czech Republic",
    country == "Turkiye" ~ "Turkey",
    country == "Argelia" ~ "Algeria",
    country == "Eswatini" ~ "Swaziland",
    TRUE ~ country
  ))
democracy_final <- democracy_final %>%
  mutate(country = case_when(
    country == "Slovak Republic" ~ "Slovakia",
    country == "Korea, Republic of" ~ "South Korea",
    country == "Trinidad &Tobago" ~ "Trinidad and Tobago",
    country == "Congo, Dem. Rep." ~ "Congo (Kinshasa)",
    country == "Congo, Republic of" ~ "Congo (Brazzaville)",
    country == "Gambia, The" ~ "Gambia",
    country == "Côte d`Ivoire" ~ "Ivory Coast",
    TRUE ~ country
  ))
freedom_final <- freedom_final %>%
  mutate(country = case_when(
    country == "Northern Cyprus" ~ "North Cyprus",
    country == "The Gambia" ~ "Gambia",
    country == "Cote d'Ivoire" ~ "Ivory Coast",
    country == "Eswatini" ~ "Swaziland",
    TRUE ~ country
  ))

# PRIMER DATAFRAME: df_completo (2015-2020, con todas las variables)
df_completo <- df_original %>%
  left_join(democracy_final, by = c("country", "year")) %>%
  left_join(freedom_final, by = c("country", "year")) %>%
  filter(year >= 2015 & year <= 2020)  # Filtrar solo hasta 2020

# SEGUNDO DATAFRAME: df_sin_democracia (2015-2024, sin democracy_final)
df_sin_democracia <- df_original %>%
  left_join(freedom_final, by = c("country", "year")) %>%
  filter(year >= 2015 & year <= 2024)  # Mantener toda la información de felicidad y libertad

summary(df_completo)
summary(df_sin_democracia)

na_presence_completo <- df_completo %>%
  summarise(across(everything(), ~ any(is.na(.)), .names = "NA_{.col}"))

na_presence_sin_democracia <- df_sin_democracia %>%
  summarise(across(everything(), ~ any(is.na(.)), .names = "NA_{.col}"))

# OPCIÓN 1: ELIMINAR LOS NA
df_completo_sin_na <- df_completo %>% drop_na()
df_sin_democracia_sin_na <- df_sin_democracia %>% drop_na()

# OPCIÓN 2: SUSTITUIR LOS NA
# VARIABLES NUMÉRICAS
df_completo_numeric <- df_completo %>%
  select_if(is.numeric)
df_sin_democracia_numeric <- df_sin_democracia %>%
  select_if(is.numeric)
imputacion_completo <- mice(df_completo_numeric, method = "pmm", m = 5, maxit = 50, seed = 123)
df_completo_pmm <- complete(imputacion_completo)
imputacion_sin_democracia <- mice(df_sin_democracia_numeric, method = "pmm", m = 5, maxit = 50, seed = 123)
df_sin_democracia_pmm <- complete(imputacion_sin_democracia)
df_completo_pmm <- bind_cols(df_completo %>% select(-colnames(df_completo_numeric)), df_completo_pmm)
df_sin_democracia_pmm <- bind_cols(df_sin_democracia %>% select(-colnames(df_sin_democracia_numeric)), df_sin_democracia_pmm)
# VARIABLES CATEGÓRICAS
md.pattern(df_completo_pmm)
vis_miss(df_completo_pmm, sort_miss=TRUE)
na_presence_completo_pmm <- df_completo_pmm %>%
  summarise(across(everything(), ~ any(is.na(.)), .names = "NA_{.col}"))
df_completo_pmm <- df_completo_pmm %>%
  mutate(
    regional_indicator = case_when(
      country == "Greece" ~ "Western Europe",
      country == "Cyprus" ~ "Western Europe",
      country == "Gambia" ~ "Sub-Saharan Africa",
      TRUE ~ regional_indicator
    ),
    colony = ifelse(country == "Libya", FALSE, colony)
  ) %>%
  filter(!country %in% c("North Cyprus", "Kosovo", "Somaliland", "State of Palestine"))


md.pattern(df_sin_democracia_pmm)
vis_miss(df_sin_democracia_pmm, sort_miss=TRUE)
na_presence_sin_democracia_pmm <- df_sin_democracia_pmm %>%
  summarise(across(everything(), ~ any(is.na(.)), .names = "NA_{.col}"))
df_sin_democracia_pmm <- df_sin_democracia_pmm %>%
  mutate(
    regional_indicator = case_when(
      country == "Greece" ~ "Western Europe",
      country == "Cyprus" ~ "Western Europe",
      country == "Gambia" ~ "Sub-Saharan Africa",
      TRUE ~ regional_indicator
    ),
  ) %>%
  filter(!country %in% c("State of Palestine"))
# Eliminar territorios
df_sin_democracia_sin_na <- df_sin_democracia_sin_na %>%
  filter(tolower(country_or_territory) == "c") %>%  # Solo países

  # Eliminar la variable 'country_or_territory'
  select(-country_or_territory)
```

Observando la @fig-evolucion-variables, se aprecia que la generosidad (`generosity`) muestra un aumento moderado en los últimos años, mientras que la percepción de corrupción (`corruption`) presenta fluctuaciones abruptas asociadas a eventos políticos concretos como pudieron ser muchos de los escándalos que rodearon la pandemia durante 2020 y 2021. La puntuación de felicidad (`happiness_score`) se mantiene notablemente estable en el tiempo, lo que sugiere que los factores que determinan el bienestar subjetivo podrían tener efectos acumulativos o retardados. Este patrón también plantea la necesidad de utilizar modelos que capten las dinámicas específicas de cada país, ya que el promedio global puede enmascarar trayectorias divergentes a nivel nacional.

### Matriz de correlaciones

Antes de ajustar ningún modelo, es útil examinar la correlación entre las variables explicativas y la variable objetivo `happiness_score`. Esto nos permitirá identificar posibles relaciones lineales, evaluar redundancias y tomar decisiones informadas sobre qué variables incluir inicialmente en el modelo.

```{r message=FALSE, warning=FALSE, echo=FALSE}
#| label: fig-matriz
#| echo: false
#| warning: false
#| fig-cap: "Matriz de correlaciones de las variables de nuestra base de datos."
#| fig-width: 5
#| fig-height: 3.5
# Cargar librerías necesarias
library(corrplot)
library(GGally)
library(dplyr)

# Seleccionamos las variables de interés para el modelo
df_modelo <- df_sin_democracia_sin_na %>%
  select(happiness_score, gdp, life_exp, support, freedom, generosity, corruption)

# Calculamos la matriz de correlaciones de Pearson
cor_matrix <- cor(df_modelo, use = "complete.obs", method = "pearson")

# Visualizamos la matriz de correlaciones
corrplot(cor_matrix, method = "color", type = "upper",
         addCoef.col = "black", number.cex = 0.7, tl.cex = 0.8, tl.col = "black",
         col = colorRampPalette(c("red", "white", "blue"))(200))


```

Como se puede observar en la @fig-matriz, las correlaciones más fuertes con happiness_score corresponden a:

- `support` (0.75): el apoyo social es la variable que más se relaciona con la felicidad percibida.

- `life_exp` (0.67) y gdp (0.63): muestran relaciones importantes, lo que refleja la relevancia del bienestar económico y la salud.

- `freedom` (0.59) también presenta una relación moderada.

En cambio, variables como `generosity` (0.10) y `corruption` (0.07) muestran una relación muy débil con la felicidad, lo que hace cuestionable su relevancia explicativa. Las correlaciones entre predictores no son excesivamente altas (ninguna supera 0.8), por lo que, en principio, no se anticipan grandes problemas de multicolinealidad. Aun así, esto se verificará con el cálculo del Variance Inflation Factor (VIF). Este indicador mide cuánto se incrementa la varianza de los coeficientes estimados debido a la multicolinealidad. Un valor de VIF superior a 5 (o en algunos contextos, a 10) suele considerarse problemático, ya que sugiere que una variable está altamente correlacionada con otras del modelo, lo que puede afectar a la estabilidad e interpretación de los coeficientes. En este trabajo se utiliza para asegurar que las variables seleccionadas no presentan una correlación excesiva entre sí.

Este análisis justifica incluir `support`, `life_exp`, `gdp` y `freedom` en una primera versión del modelo, aunque se explorarán también modelos más parciales para comparar rendimiento y parsimonia. No obstante, estas correlaciones deben interpretarse con cautela, ya que se calculan sobre medidas repetidas para los mismos países a lo largo del tiempo, lo que puede inducir una aparente fuerza en la relación debido a la estructura longitudinal de los datos.

## Criterios de selección del modelo

Al construir un modelo estadístico, es común que existan múltiples combinaciones posibles de predictores. Para elegir la especificación más adecuada, se utilizan criterios que balancean dos aspectos fundamentales: el ajuste al conjunto de datos (qué tan bien predice el modelo los datos observados), y la complejidad del modelo (cuántos parámetros se incluyen). Dos de los criterios más utilizados para este propósito son el Akaike Information Criterion (AIC) y el Bayesian Information Criterion (BIC).

AIC penaliza la complejidad del modelo y busca minimizar la pérdida de información. Se calcula como:
$$
\text{AIC} = -2 \cdot \log(\hat{L}) + 2k
$$
donde $\hat{L}$ es la verosimilitud máxima del modelo y $k$ el número de parámetros.

BIC penaliza más fuertemente los modelos complejos (dependiendo del tamaño de muestra $n$):
$$
\text{BIC} = -2 \cdot \log(\hat{L}) + k \cdot \log(n)
$$
Un AIC o BIC más bajo indica un mejor modelo, pero el AIC tiende a seleccionar modelos más complejos (es más permisivo); mientras que el BIC favorece modelos más parsimoniosos (penaliza más la complejidad). Ambos criterios se pueden usar para comparar modelos con los mismos datos y la misma variable respuesta.

## Modelado clásico

Como punto de partida, construimos un modelo clásico de regresión lineal múltiple para explicar el `happiness_score` a partir de variables como `gdp`, `life_exp`, `support`, `freedom`, `generosity` y `corruption`. Para explorar la mejor combinación de predictores, aplicamos dos estrategias de selección de variables:

```{r message=FALSE, warning=FALSE, include=FALSE}
# Ajuste del modelo completo
modelo_completo <- lm(happiness_score ~ gdp + life_exp + support + freedom + generosity + corruption, data = df_sin_democracia_sin_na)

summary(modelo_completo)

```

### Estrategia top-down (backward elimination)

Usamos el criterio AIC y BIC para eliminar aquellas variables cuya eliminación mejora la simplicidad del modelo sin sacrificar capacidad predictiva. A continuación, se muestra la salida completa generada por R utilizando los criterios AIC y BIC, respectivamente:

```{r message=FALSE, warning=FALSE, echo=FALSE}
# Selección con AIC
modelo_step_aic <- step(modelo_completo, direction = "backward", k = 2)

# Selección con BIC
modelo_step_bic <- step(modelo_completo, direction = "backward", k = log(nrow(df_sin_democracia_sin_na)))

```

En la selección según AIC, el modelo presenta un AIC final de -1590.3, donde no se excluye ninguna variable. Por su parte, el BIC penaliza más severamente los modelos complejos, favoreciendo modelos más parsimoniosos; en cuyo caso el modelo óptimo presenta un BIC de -1554, descartando `generosity`. Esta falta de concordancia entre ambos criterios muestra una inestabilidad que sugiere que el modelo ajustado no es lo suficientemente robusto frente a cambios en la penalización por complejidad. Esta sensibilidad es especialmente problemática en contextos con medidas repetidas, como es el caso de los datos longitudinales, y refuerza la necesidad de emplear enfoques más adecuados para esta estructura, como los modelos mixtos.

### Estrategia bottom-up (forward selection)

También exploramos una estrategia bottom-up (selección hacia adelante), que parte de un modelo nulo y añade variables una a una en función de la mejora del AIC. Esta estrategia permite comprobar si existe alguna combinación alternativa de predictores que produzca un modelo competitivo o incluso mejor al obtenido por eliminación hacia atrás.

```{r message=FALSE, warning=FALSE, echo=FALSE}
# Modelo nulo y completo
modelo_nulo <- lm(happiness_score ~ 1, data = df_sin_democracia_sin_na)
modelo_completo <- lm(happiness_score ~ gdp + life_exp + support + freedom + generosity + corruption, data = df_sin_democracia_sin_na)

# Forward selection
modelo_step_forward <- step(modelo_nulo, scope = list(lower = modelo_nulo, upper = modelo_completo), direction = "forward")

```

En este caso, el procedimiento fue incorporando progresivamente variables hasta alcanzar el modelo completo, es decir, con todos los predictores. Este resultado contrasta con el modelo obtenido por backward elimination, en el que algunas variables eran descartadas. Esta diferencia refleja que los criterios de selección pueden llevar a soluciones distintas según el punto de partida.

### Diagnóstico y validación final del modelo

En base a los resultados anteriores, el modelo final que utilizaremos para el diagnóstico y validación es el siguiente: $$
happiness\_score_{ij} = \beta_0 + \beta_1\,gdp_{ij} + \beta_2\,life\_exp_{ij} + \beta_3\,support_{ij} + \beta_4\,freedom_{ij} + \beta_5\,corruption_{ij} + \epsilon_{ij}.
$$ Este modelo muestra un equilibrio adecuado entre capacidad predictiva y parsimonia. Como veremos en la siguiente sección, se procederá ahora a evaluar el ajuste del modelo, su interpretación y su validación diagnóstica. Una vez seleccionado el modelo, es fundamental verificar si cumple con las hipótesis necesarias para garantizar su validez estadística. Estas hipótesis incluyen:

- Normalidad de los residuos.

- Media cero de los residuos.

- Homoscedasticidad (varianza constante de los errores).

- Independencia de los errores.

```{r message=FALSE, warning=FALSE, echo=FALSE}
#| label: fig-modelo-clasico
#| echo: false
#| warning: false
#| fig-cap: "Gráficas para la validación del modelo clásico."
#| fig-width: 5
#| fig-height: 3.5
modelo_final <- lm(happiness_score ~ support + life_exp + freedom + gdp + corruption,
                   data = df_sin_democracia_sin_na)
autoplot(modelo_final, which = 1:4)

```


#### Normalidad de los residuos

Se aplica el test de Jarque-Bera para evaluar si los residuos del modelo siguen una distribución normal. El resultado indica un p-valor muy bajo, lo que nos lleva a rechazar la hipótesis de normalidad.

```{r message=FALSE, warning=FALSE, include=FALSE}
jarque.bera.test(modelo_final$residuals)
```

El p-valor obtenido es extremadamente bajo (p-value = 2.195e-10), lo que indica que los residuos no siguen una distribución normal. Esto también se confirma visualmente en el gráfico Q-Q de la @fig-modelo-clasico, donde los residuos llega un momento en el que se desvían de la línea teórica.

#### Media cero

Calculamos la media de los residuos para verificar si se aproxima a cero, como requiere el modelo. En este caso, se cumple adecuadamente:

```{r message=FALSE, warning=FALSE, include=FALSE}
mean(modelo_final$residuals)
```

Si observamos la gráfica Residuals vs Fitted en la @fig-modelo-clasico, podríamos decir que los residuos están uniformemente dispersos alrededor del eje de abscisas, por lo que se cumple la condición de que los residuos tienen media cero.

#### Homoscedasticidad

Se aplica la prueba de Breusch-Pagan para comprobar si la varianza de los errores es constante. El resultado del test devuelve un p-valor bajo, lo que sugiere la existencia de heterocedasticidad.

```{r message=FALSE, warning=FALSE, include=FALSE}
bptest(modelo_final, studentize = FALSE)

```

El gráfico de residuos frente a los valores ajustados de la @fig-modelo-clasico también muestra un patrón creciente, indicio visual de heterocedasticidad. El test devuelve un p-valor < 2.2e-16, por lo que rechazamos la hipótesis nula de homocedasticidad. Esto indica que hay heterocedasticidad en los residuos, es decir, su varianza no es constante.

#### No correlación de los errores

Mediante el test de Durbin-Watson, se verifica que no exista autocorrelación en los residuos. En este caso, el p-valor es suficientemente alto como para no rechazar la hipótesis nula, por lo que la independencia de los errores se mantiene.

```{r message=FALSE, warning=FALSE, include=FALSE}
dwtest(modelo_final)

```

Con un estadístico de Durbin-Watson de 1.4461 y un p-valor < 2.2e-16, se concluye que existe autocorrelación positiva entre los residuos.

#### Conclusión del diagnóstico

Estos incumplimientos sugieren que el modelo, aunque aparentemente ajustado, no es estadísticamente válido en un contexto longitudinal. Específicamente, ignora la dependencia entre observaciones del mismo país a lo largo del tiempo, lo que puede sesgar los resultados.

La inadecuación del modelo clásico justifica el uso de enfoques más robustos, capaces de incorporar la estructura jerárquica de los datos. En particular, los modelos lineales mixtos (LMM) permiten modelar efectos aleatorios por país, capturar la correlación intrínseca entre medidas repetidas y mejorar la validez estadística y la interpretación de los resultados. En la siguiente sección abordamos su aplicación utilizando la función lmer() del paquete lme4.

## Modelos Lineales Mixtos (LMM)

En el análisis clásico mediante regresión lineal múltiple se asumía que las observaciones eran independientes entre sí. Sin embargo, en nuestro caso trabajamos con datos longitudinales, es decir, con observaciones repetidas a lo largo del tiempo para los mismos países. Esto introduce una dependencia entre observaciones dentro del mismo país que los modelos clásicos no pueden capturar adecuadamente.

Para abordar esta limitación recurrimos a los modelos lineales mixtos (LMM). Estos modelos permiten combinar efectos fijos, que capturan el efecto promedio de los predictores sobre la variable respuesta en toda la población, y efectos aleatorios, que permiten modelar la variabilidad específica entre países, incorporando interceptos (y potencialmente pendientes) distintos para cada uno. De esta forma podemos capturar la estructura jerárquica de los datos, reconociendo que cada país puede tener un nivel base de felicidad distinto (intercepto propio), mientras que los efectos de las variables predictoras son comunes a todos los países. En nuestro modelo, se consideran efectos fijos aquellas variables explicativas cuyo efecto queremos estimar de forma generalizable para toda la población (en este caso, todos los países y años). Estas variables incluyen `gdp`, `support`, `freedom`, `life_exp`, `corruption` y las variables políticas (`is_democracy`, `regime_category`, etc.). Se introduce un efecto aleatorio por país (intercepto aleatorio), porque cada país tiene un nivel base distinto de felicidad no explicado por las variables fijas, hay dependencia entre observaciones del mismo país en distintos años, y no nos interesa estimar el efecto específico de cada país, sino tener en cuenta la variabilidad entre ellos. Además, se incorpora también `year` como efecto aleatorio, ya que se asume que la evolución temporal del `Happiness Score` no es idéntica en todos los países. Algunos pueden experimentar mejoras sostenidas a lo largo del tiempo, mientras que otros pueden mostrar estancamiento o incluso retrocesos. Permitir que la relación con el tiempo varíe entre países nos ayuda a modelar mejor esta heterogeneidad en las trayectorias temporales, respetando la estructura longitudinal de los datos. El modelo lineal mixto que vamos a plantear es el siguiente:
\begin{align*}
happinessscore_{ij} =\ & \beta_0 
+ \beta_1 \cdot regionalindicator_{ij}
+ \beta_2 \cdot \text{gdp}_{ij}
+ \beta_3 \cdot \text{support}_{ij}
+ \beta_4 \cdot lifeexp_{ij} 
+ \beta_5 \cdot \text{freedom}_{ij} \\
&+ \beta_6 \cdot \text{generosity}_{ij}
+ \beta_7 \cdot \text{corruption}_{ij}
+ \beta_8 \cdot \text{status}_{ij}
+ \beta_9 \cdot politicalrights_{ij} \\
&+ \beta_{10} \cdot civilliberties_{ij}
+ \beta_{11} \cdot fairelection_{ij} 
+ \beta_{12} \cdot regimecategory_{ij}
+ \beta_{13} \cdot \text{democracy}_{ij} \\
&+ \beta_{14} \cdot electoralcategory_{ij}
+ \beta_{15} \cdot \text{presidential}_{ij}
+ \beta_{16} \cdot \text{alternation}_{ij}
+ \beta_{17} \cdot \text{year}_{ij} \\
&+ u_{0i} + u_{1i} \cdot \text{year}_{ij}
+ \varepsilon_{ij}
\end{align*}

donde:

- $i$ representa el país y $j$ el año,

- $\beta_k$ son los coeficientes fijos asociados a cada variable explicativa,

- $u_{0i} \sim \mathcal{N}(0, \sigma_{u0}^2)$ es el intercepto aleatorio por país,

- $u_{1i} \sim \mathcal{N}(0, \sigma_{u1}^2)$ es el efecto aleatorio asociado al año dentro de cada país,

- $\varepsilon_{ij} \sim \mathcal{N}(0, \sigma^2)$ es el término de error residual.

Para seleccionar el mejor modelo, partimos del modelo mixto completo y generamos múltiples modelos candidatos con diferentes combinaciones de predictores. Iniciamos una búsqueda automática que identifica los modelos con mejor equilibrio entre ajuste y complejidad, evaluado mediante el AIC. Para comparar modelos con distintos efectos fijos, es necesario ajustar el modelo inicial utilizando máxima verosimilitud (ML) en lugar de REML, que solo es apropiado cuando la estructura de efectos fijos permanece constante. De esta manera, generamos una lista de modelos candidatos ordenados por su AIC, de manera que si el primer modelo de la lista no resulta válido en nuestro futuro diagnóstico, pasamos al siguiente modelo de la lista; y así suvesivamente hasta que encontremos un LMM válido. A continuación, se muestra la salida del LMM:

```{r message=FALSE, warning=FALSE, include=FALSE}
library(dplyr)
library(tidyr)

# Leer los datos base (ajusta las rutas si es necesario)
df_happiness <- read.csv("df_sin_democracia_sin_na.csv")
df_politicas <- read.csv("df_completo_sin_na.csv")

# Variables políticas que se quieren mantener fijas desde 2020
vars_politicas <- c("fair_election", "regime_category", "democracy",
                    "electoral_category", "presidential", "alternation")

# Extraer valores de 2020 para esas variables
politicas_2020 <- df_politicas %>%
  filter(year == 2020) %>%
  select(country, all_of(vars_politicas))

# Filtrar df_happiness solo para países que tienen datos políticos válidos
paises_validos <- unique(politicas_2020$country)
df_happiness_filtrado <- df_happiness %>%
  filter(country %in% paises_validos)

# Expandir datos políticos de 2020 a todos los años
años <- 2015:2024
base_expansion <- expand.grid(country = paises_validos, year = años)

politicas_expandido <- base_expansion %>%
  left_join(politicas_2020, by = "country")

# Unir ambas fuentes para crear el dataframe completo
df_unificado <- df_happiness_filtrado %>%
  left_join(politicas_expandido, by = c("country", "year"))

```



```{r message=FALSE, warning=FALSE, include=FALSE}
# Cargar librerías necesarias
library(lme4)
library(MuMIn)
library(DHARMa)

# Ajustar el modelo base para selección (con df_unificado y na.fail)
modelo_base <- lmer(
  happiness_score ~ regional_indicator + gdp + support + life_exp + freedom + 
    generosity + corruption + status + political_rights + civil_liberties +
    fair_election + regime_category + democracy + electoral_category + 
    presidential + alternation + year +
    (1 + year | country),
  data = df_unificado,
  REML = FALSE,
  na.action = na.fail
)

# Aplicar selección por AIC
# modelos_dredge <- dredge(modelo_base, trace = FALSE)
# modelo_seleccionado <- get.models(modelos_dredge, 1)[[1]]
modelo_seleccionado <- modelo_base <- lmer(
  happiness_score ~ civil_liberties + electoral_category + freedom +  
    gdp + life_exp + political_rights + regime_category + regional_indicator +  
    status + support + year + (1 + year | country),
  data = df_unificado,
  REML = FALSE,
  na.action = na.fail
)
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
library(lme4)
formula(modelo_seleccionado)
summary(modelo_seleccionado)$coefficients
# fixef(modelo_seleccionado)      # Efectos fijos
# ranef(modelo_seleccionado)      # Efectos aleatorios
# VarCorr(modelo_seleccionado)


```

La salida del modelo mixto lineal seleccionado muestra un ajuste con un gran número de predictores fijos y un efecto aleatorio de intercepto y pendiente de año por país, lo que permite capturar variaciones estructurales tanto entre países como a lo largo del tiempo. En concreto, el modelo es el siguiente:
\begin{align*}
happinessscore_{ij} =\ & \beta_0 
+ \beta_1 \cdot civilliberties_{ij}
+ \beta_2 \cdot electoralcategory_{ij}
+ \beta_3 \cdot \text{freedom}_{ij} \\
&+ \beta_4 \cdot \text{gdp}_{ij}
+ \beta_5 \cdot lifeexp_{ij}
+ \beta_6 \cdot politicalrights_{ij}
+ \beta_7 \cdot regimecategory_{ij} \\
&+ \beta_8 \cdot regionalindicator_{ij}
+ \beta_9 \cdot \text{status}_{ij}
+ \beta_{10} \cdot \text{support}_{ij}
+ \beta_{11} \cdot \text{year}_{ij} \\
&+ u_{0j} + u_{1j} \cdot \text{year}_{ij}
+ \epsilon_{ij}
\end{align*}
Entre los efectos fijos, se observa que `freedom`, `life_exp` y especialmente `support` tienen efectos positivos y estadísticamente significativos sobre el nivel de felicidad, lo que indica que mayores niveles de libertad percibida, esperanza de vida y apoyo social están fuertemente asociados con un mayor puntaje de felicidad. La variable `civil_liberties` muestra un efecto negativo significativo, lo que sugiere que una mayor ausencia de libertades civiles se relaciona con una menor felicidad. También destaca el indicador regional North America and ANZ, con un coeficiente positivo y significativo, lo que indica que esta región tiene niveles de felicidad superiores respecto a la categoría de referencia. Por el contrario, otras regiones como South Asia o Sub-Saharan Africa presentan efectos negativos y significativos, evidenciando una menor felicidad media en esas áreas. Dentro de las variables políticas, el régimen de Military dictatorship tiene un efecto negativo relevante, mientras que el statusPF (partly free) tiene un efecto positivo aunque de menor magnitud. En cuanto a los efectos aleatorios, se observa una alta varianza en el intercepto entre países, lo que indica diferencias estructurales sustanciales en el nivel base de felicidad entre ellos, mientras que el efecto aleatorio del año presenta una correlación perfecta negativa con el intercepto (–1.00), lo que puede sugerir redundancia o colinealidad en las tendencias temporales entre países. Además, el modelo presenta advertencias de convergencia y posibles problemas de identificabilidad debido a un ratio elevado de autovalores, lo que sugiere la necesidad de estandarizar variables o revisar la multicolinealidad. A pesar de ello, el modelo explica adecuadamente la variabilidad de la felicidad teniendo en cuenta factores estructurales, económicos, sociales y políticos a lo largo de países y años.

Para evaluar la calidad del modelo, utilizaremos las siguientes medidas: el R² marginal, que representa la proporción de varianza explicada por los efectos fijos, y el R² condicional, que representa proporción de varianza explicada por todo el modelo (fijos + aleatorios).

```{r message=FALSE, warning=FALSE, include=FALSE}
library(performance)
# Calcular R²
r2_vals <- r2(modelo_seleccionado)

# Extraer el R² marginal
r2_marginal <- r2_vals$R2_marginal

# Extraer el R² condicional
r2_conditional <- r2_vals$R2_conditional
```

La salida del cálculo del R² para el modelo mixto seleccionado indica que el modelo explica una parte considerable de la variabilidad del Happiness Score. En concreto, el R² marginal es de **`r round(r2_marginal, 3)`**, lo que significa que aproximadamente el 70.2% de la varianza total en la felicidad se explica exclusivamente por los efectos fijos del modelo, es decir, por las variables observables incluidas como predictores (como freedom, support, life_exp, civil_liberties, indicadores políticos y regionales, entre otros). Por otro lado, el R² condicional asciende hasta **`r round(r2_conditional, 3)`**, lo que implica que si además se consideran los efectos aleatorios —en este caso, las variaciones específicas de cada país y la interacción con el año— el modelo es capaz de explicar el 93.2% de la varianza total del Happiness Score. Esta gran diferencia entre el R² marginal y condicional revela que la heterogeneidad no explicada por los predictores fijos pero capturada por los efectos aleatorios, especialmente a nivel país y su evolución temporal, juega un papel clave en la explicación de la felicidad. En conjunto, estos resultados reflejan que el modelo tiene un poder explicativo muy alto, y que tanto las variables medidas como las estructuras latentes por país y año contribuyen significativamente a entender las diferencias en los niveles de felicidad.

Como en cualquier modelo estadístico, es esencial verificar que las suposiciones sobre los residuos se cumplen también en el contexto de modelos mixtos. En particular, se evaluó la normalidad de los residuos, la homocedasticidad (varianza constante de los errores), y la ausencia de patrones sistemáticos entre residuos y valores ajustados. Para ello, se utilizan gráficos diagnósticos similares a los del modelo clásico, pero adaptados a la estructura jerárquica de los datos. 

```{r}
#| label: fig-qqplot-residuos2
#| echo: false
#| warning: false
#| fig-cap: "QQ-plot de los residuos simulados del modelo mixto."
#| fig-width: 5
#| fig-height: 3.5

sim_res <- DHARMa::simulateResiduals(fittedModel = modelo_seleccionado)
plotQQunif(sim_res)
```

```{r}
#| label: fig-dispersion-residuos2
#| echo: false
#| warning: false
#| fig-cap: "Dispersión de los residuos simulados frente a los valores predichos."
#| fig-width: 5
#| fig-height: 3.5

plotResiduals(sim_res)
```

Para validar los supuestos del modelo ajustado, se utiliza la función `testResiduals()` del paquete `DHARMa`[@dharma]. Esta función genera residuos simulados a partir del modelo ajustado mediante simulaciones paramétricas, y los compara con los residuos observados; evaluando de manera robusta tres aspectos fundamentales de los residuos. Primero, la uniformidad, ya que verifica si los residuos simulados siguen una distribución uniforme, lo que sería esperable bajo un modelo bien especificado; basándose en el test de Kolmogorov–Smirnov. Segundo, la dispersión, evaluando si existe sobre o infra-dispersión en los residuos, comparando la variabilidad observada con la esperada. Y por último, los valores atípicos (outliers), porque detecta si hay un número de observaciones atípicas mayor al esperado bajo el modelo; utilizando una prueba binomial exacta para estimar la proporción de outliers.

```{r}
#| label: fig-test-residuos2
#| echo: false
#| warning: false
#| fig-cap: "Resultados del test formal de uniformidad aplicado a los residuos simulados."

testResiduals(sim_res)
```


### Normalidad

El gráfico QQ-plot de la @fig-qqplot-residuos2 muestra una alineación bastante ajustada de los residuos simulados con la línea teórica, lo que sugiere una distribución aproximadamente normal. Aunque se observan ligeras desviaciones en las colas, el test de Kolmogorov-Smirnov aplicado a los residuos proporciona un p-valor de 0.06889, lo que indica que no se puede rechazar la hipótesis nula de normalidad. Por tanto, los residuos no presentan desviaciones significativas con respecto a la normalidad y el modelo cumple satisfactoriamente con este supuesto.

### Homocedasticidad

En el gráfico de residuos frente a valores ajustados de la @fig-dispersion-residuos2, la nube de puntos es dispersa y no se detecta un patrón claro de aumento o disminución de la varianza a lo largo del rango de valores predichos. El test de dispersión de DHARMa refuerza esta conclusión con un p-valor de 0.512, indicando que no existen evidencias significativas de heterocedasticidad. La varianza de los residuos puede considerarse homogénea, por lo que el modelo cumple también con el supuesto de homocedasticidad.

### Outliers y estructura de los residuos

En cuanto a los outliers, el test binomial exacto estima una proporción del 1.2% de observaciones extremas (17 de 1421), que no difiere significativamente de la esperada por azar (p = 0.09827). Esto implica que la presencia de valores extremos no es problemática. Sin embargo, el gráfico de residuos simulados frente a predicciones de la @fig-test-residuos2 revela ciertas desviaciones en los cuantiles (indicadas por las líneas rojas), y el test de cuantiles combinado resulta significativo, lo que sugiere que podrían existir ciertas estructuras residuales no completamente capturadas por el modelo, aunque no afectan gravemente al ajuste global.

### Conclusión del diagnóstico

El diagnóstico general indica que el modelo cumple de forma razonable con los tres supuestos clave: normalidad, homocedasticidad y proporción esperada de outliers. Aunque existe una ligera desviación en los cuantiles residuales, los resultados no invalidan el modelo y se puede considerar estadísticamente robusto y fiable para la inferencia y la predicción del Happiness Score. Esta validación respalda la solidez del modelo ajustado y su utilidad para explicar las variaciones en la felicidad a partir de los factores seleccionados.

### Interpretación de coeficientes

Los coeficientes estimados del modelo permiten identificar qué factores están asociados de forma significativa con el nivel de felicidad percibida en los países a lo largo del tiempo. `Freedom` (coef. = 1.11, p < 0.001) destaca como uno de los predictores más influyentes, indicando que, a igualdad del resto de variables, los países donde los ciudadanos sienten mayor libertad personal tienden a presentar niveles de felicidad considerablemente más altos. Del mismo modo, `support` (coef. = 0.69, p < 0.001) refleja una relación clara entre el respaldo social percibido y la felicidad: las personas que creen poder contar con otros en momentos difíciles tienden a valorar más positivamente su vida. También `life_exp` muestra una asociación positiva (coef. = 0.0069, p < 0.01), lo que sugiere que una mayor esperanza de vida suele ir acompañada de una mayor satisfacción general, probablemente porque refleja sistemas sanitarios y condiciones de vida más favorables.

Por otro lado, `civil_liberties` tiene un coeficiente negativo y significativo (coef. = –0.0857, p < 0.01), lo que indica que mayores restricciones en las libertades civiles están asociadas a menores niveles de felicidad. Entre las variables categóricas, destacan efectos significativos en varias categorías. Por ejemplo, los países clasificados bajo una dictadura militar presentan niveles significativamente menores de felicidad en comparación con la categoría base de régimen (coef. = –0.48, p < 0.01), lo cual concuerda con la intuición de que este tipo de regímenes tiende a restringir derechos y bienestar. También es llamativo el efecto negativo de Sub-Saharan Africa (coef. = –0.64, p < 0.001) y South Asia (coef. = –0.95, p < 0.001) en comparación con la región de referencia, lo que sugiere que, tras controlar por el resto de factores, vivir en estas regiones sigue asociado a menores niveles medios de felicidad, probablemente por desigualdades estructurales persistentes. En contraste, North America and ANZ presenta un coeficiente positivo y significativo (coef. = 0.69, p < 0.05), reflejando una tendencia sistemática a valores de felicidad más altos que el promedio global, incluso tras ajustar por factores económicos, sociales y políticos.

Aunque variables como el PIB per cápita (`gdp`) no resultaron estadísticamente significativas en este modelo ajustado (coef. = 0.0041, p ≈ 0.81), esto no implica que carezcan de importancia, sino que su efecto puede estar solapado o absorbido por otras variables más directamente relacionadas con el bienestar subjetivo, como el apoyo social o la percepción de libertad. En conjunto, el modelo permite interpretar que la felicidad no depende únicamente de condiciones materiales, sino que se ve fuertemente influida por factores relacionales y políticos, como la percepción de libertad, la confianza social, y las libertades civiles. Estos resultados respaldan un enfoque multidimensional para entender el bienestar, en el que el contexto democrático y el capital social resultan claves.

### Predicción del Happiness Score para 2025

Usando el modelo mixto ajustado y extrapolando con los valores más recientes disponibles, se pueden obtener predicciones personalizadas por país. Esto permite construir un ranking proyectado de felicidad para 2025.

```{r message=FALSE, warning=FALSE, include=FALSE}
# Cargar librerías necesarias
library(lme4)
library(dplyr)

# Crear una copia de la base de datos para 2025
datos_2025 <- df_unificado

# Sustituimos el valor del año por 2025 en todas las observaciones
datos_2025$year <- 2025

# Realizamos la predicción utilizando el modelo mixto
# allow.new.levels = TRUE permite predecir incluso si hay países nuevos o no observados
datos_2025$happiness_pred_2025 <- predict(modelo_seleccionado, newdata = datos_2025, allow.new.levels = TRUE)

# Agrupar por país y calcular la media de felicidad predicha en 2025 (si hay varias filas por país)
ranking_2025 <- datos_2025 %>%
  group_by(country) %>%
  summarise(happiness_pred_2025 = mean(happiness_pred_2025, na.rm = TRUE)) %>%
  arrange(desc(happiness_pred_2025)) %>%
  mutate(rank = row_number())

# Mostrar top 10
print(head(ranking_2025, 10))

# Mostrar bottom 10
print(tail(ranking_2025, 10))

ranking_2025 %>% 
  filter(country == "Spain")

ranking_2024 <- df_unificado %>%
  filter(year == 2024) %>%
  select(country, happiness_score) %>%
  arrange(desc(happiness_score)) %>%
  mutate(rank_2024 = row_number())

ranking_2024 %>%
  filter(country == "Spain")


```


```{r message=FALSE, warning=FALSE, include=FALSE}
#| label: tabla1
library(dplyr)
library(knitr)

# Unir rankings de 2024 y 2025
comparativa <- left_join(ranking_2025, ranking_2024, by = "country") %>%
  rename(score_2025 = happiness_pred_2025,
         score_2024 = happiness_score) %>%
  select(country, score_2025, rank, score_2024, rank_2024)

# Top 10
top_10 <- comparativa %>% slice_min(rank, n = 10) %>% 
  mutate(section = "Top 10")

# España sola
espana <- comparativa %>% 
  filter(country == "Spain") %>%
  mutate(section = "España")

# Bottom 10
bottom_10 <- comparativa %>% slice_max(rank, n = 10) %>%
  mutate(section = "Bot 10")

# Unir todo
tabla_final <- bind_rows(top_10, espana, bottom_10) %>%
  arrange(factor(section, levels = c("Top 10", "España", "Bot 10")), rank)

# Mostrar como tabla
kable(tabla_final, caption = "Comparación del ranking de felicidad en 2025 y 2024 (Top, España, Bottom)",
      col.names = c("País", "Score 2025", "Ranking 2025", "Score 2024", "Ranking 2024", "Sección"))

```

```{r}
#| label: tbl-ranking-2024
#| echo: false
#| warning: false
#| message: false
#| tbl-cap: "Comparación del ranking de felicidad en 2025 y 2024 (Top, España, Bottom)"
#| tbl-columns: 8

kable(tabla_final,
      col.names = c("País", "Score 2025", "Ranking 2025", "Score 2024", "Ranking 2024", "Sección"))

```


Lo primero que podemos observar en la [@tbl-ranking-2024] es que los países nórdicos continúan liderando el ranking global del Happiness Score estimado para 2025. Se observa que Finlandia encabeza el ranking con una predicción de 7.75 puntos, consolidando su posición como líder mundial en bienestar subjetivo. Le siguen Dinamarca (7.61), Islandia (7.52) y Países Bajos (7.42), todos muy cerca entre sí, lo que refleja una estabilidad en sus altos niveles de calidad de vida. El top 10 lo completan países con economías desarrolladas y estados de bienestar consolidados como Suiza, Noruega, Suecia, Israel Nueva Zelanda y Luxemburgo, todos con puntuaciones superiores a 7.2.

En el extremo opuesto del ranking, los países con los niveles más bajos de felicidad prevista son Afganistán, que ocupa el último puesto con un valor de 2.54, seguido por Sudán del Sur, República Centroafricana y Zimbabue. Estas naciones presentan conflictos persistentes, pobreza extrema o inestabilidad política. Todas las puntuaciones están por debajo de 3.6, lo que refleja condiciones estructurales desfavorables que impactan fuertemente en el bienestar subjetivo.

Si nos fijamos en España, obtiene un Happiness Score previsto de 6.42, situándose en la posición 28. Esta puntuación refleja un nivel de felicidad moderadamente alto, por encima de la media global. Aunque no alcanza los niveles nórdicos, se encuentra en el tercio superior del ranking, lo que implica una posición destacada entre los países con mayor bienestar percibido. Aunque la puntuación de felicidad predicha para España en 2025 es la misma que para 2024, la posición en el ranking mejora: sube del puesto 35 al 28. Esto implica que otros países han bajado más que España, permitiendo su ascenso en el ranking a pesar de una leve caída en su puntuación. Es un buen ejemplo de cómo el ranking depende no solo del valor absoluto, sino también del contexto comparativo entre países.

A partir de los resultados obtenidos en este capítulo, se ha desarrollado una aplicación interactiva en Shiny que permite explorar de forma dinámica los modelos mixtos ajustados sobre los datos de felicidad. La aplicación está diseñada para que el usuario pueda seleccionar distintas combinaciones de variables fijas, así como elegir entre distintos niveles de complejidad del modelo (intercepto aleatorio, pendiente aleatoria, etc.), y visualizar tanto los coeficientes estimados como las métricas de calidad del modelo (AIC, R² marginal y condicional). Además, permite generar predicciones personalizadas por país y año, lo que convierte a la app en una herramienta potente para observar cómo se comporta el modelo bajo distintos escenarios. Esta implementación traslada al entorno interactivo todo el proceso de modelado descrito en este capítulo, permitiendo al usuario comprobar en tiempo real cómo influyen los distintos predictores sobre la felicidad y cómo se ajustan los modelos a las características longitudinales y jerárquicas de los datos. Dicha aplicación está descrita en el siguiente capítulo.

## Desarrollo del Modelo Lineal Generalizado Mixto (GLMM)

En esta sección se explora una alternativa al modelo mixto clásico mediante un modelo lineal generalizado mixto (GLMM). Este tipo de modelos permite relajar el supuesto de normalidad de los residuos, especialmente útil cuando la variable dependiente presenta asimetría. Dado que el Happiness Score es una variable estrictamente positiva y su distribución es ligeramente asimétrica hacia la derecha, se ha optado por utilizar una distribución Gamma con enlace logarítmico.

El modelo ajustado incorpora efectos fijos para variables económicas, sociales y políticas, así como un efecto aleatorio de intercepto y pendiente por país agrupado por región. Esta estructura busca capturar no solo la variabilidad entre países, sino también diferencias estructurales asociadas al contexto regional de cada nación.

A diferencia del enfoque anterior basado en modelos lineales mixtos, en este caso se ha adoptado una estrategia de búsqueda automática de modelos válidos combinando variables candidatas en distintos subconjuntos. El principal motivo por el que no utilizamos el mismo modelo que para LMM es que no encontramos ningún GLMM que fuese válido con `year` como efecto aleatorio; por lo que consideramos que utilizar `regional_indicator` también sería coherente para nuestro estudio. Para cada combinación se ha evaluado la validez del modelo ajustado aplicando los tests de DHARMa sobre los residuos simulados, exigiendo que se superen tres pruebas clave: uniformidad, homocedasticidad y ausencia de outliers.

La búsqueda sistemática ha identificado un modelo válido con dos predictores fijos: `support` (apoyo social percibido) y `life_exp` (esperanza de vida). En concreto, el modelo es el siguiente:
$$
\text{Happiness}_{ij} \sim \text{Gamma}(\mu_{ij}, \theta)
$$
$$
\log(\mu_{ij}) = \beta_0 + \beta_1 \cdot \text{support}_{ij} + \beta_2 \cdot lifeexp_{ij} + u_{0i} + u_{1i} \cdot regionalindicator_{ij}.
$$
donde:

- $\mu_{ij}$ es la esperanza del nivel de felicidad del país $i$ en el año $j$.
- $\beta_0, \beta_1, \beta_2$ son los efectos fijos.
- $u_{0i}, u_{1i}$ son los efectos aleatorios asociados al país $i$, permitiendo interceptos y pendientes distintos según el país en función de `regional_indicator`.
- El término $\log(\mu_{ij})$ indica que se usa un link logarítmico, adecuado para una distribución Gamma.

A pesar de que se han explorado sistemáticamente cientos de combinaciones de predictores posibles para ajustar un modelo lineal generalizado mixto (GLMM) válido, ninguno de los modelos obtenidos ha devuelto un valor definido para el AIC: en todos los casos, esta métrica ha aparecido como NA (Not Available). El Akaike Information Criterion (AIC) es una medida muy utilizada para comparar modelos, ya que permite evaluar el equilibrio entre calidad de ajuste y complejidad del modelo. Un AIC más bajo indica, en principio, un modelo más parsimonioso y con mejor capacidad predictiva relativa. Sin embargo, para que este criterio pueda calcularse correctamente, es necesario que el modelo se haya ajustado mediante máxima verosimilitud (ML) y que todos los componentes del modelo —incluyendo los efectos fijos, los aleatorios y los parámetros de dispersión— sean estimados de forma numéricamente estable.

El hecho de que todos los modelos válidos encontrados tengan el AIC como NA sugiere que, aunque la simulación de residuos mediante el paquete DHARMa indica un ajuste aceptable, el proceso interno de optimización del modelo ha sido inestable o degenerado en ciertos aspectos. Algunas de las posibles causas de este problema son la singularidad en los efectos aleatorios, es decir, que las varianzas estimadas para algunos componentes sean exactamente cero o que haya correlaciones perfectas entre efectos; la colinealidad alta entre predictores fijos y/o aleatorios, lo que dificulta la identificación de los parámetros; la redundancia estructural en el modelo (por ejemplo, efectos aleatorios innecesarios o mal definidos); o ciertos problemas numéricos durante la optimización de la log-verosimilitud penalizada, que impiden calcular la función objetivo de forma precisa.

Es importante destacar que el hecho de que el AIC sea NA no implica necesariamente que el modelo sea inválido, sino que no se puede evaluar su calidad relativa frente a otros modelos utilizando esta métrica. En este trabajo, para priorizar la validez estadística del modelo (basada en la uniformidad, homocedasticidad y ausencia de outliers en los residuos simulados), se ha optado por aceptar modelos con AIC NA, aunque se documenta esta limitación de forma explícita. En futuras investigaciones, una posible solución sería reducir la complejidad de la estructura aleatoria o limitar el número de predictores simultáneamente considerados, lo que podría estabilizar la estimación del modelo y permitir el cálculo correcto del AIC. A continuación, se muestra la salida del GLMM: 

```{r message=FALSE, warning=FALSE, echo=FALSE}
# Cargar librerías necesarias
library(glmmTMB)
library(MuMIn)
library(DHARMa)
library(tidyverse)

# Modelo GLMM válido
glmm_valido <- glmmTMB(
  happiness_score ~ support + life_exp + (1 + regional_indicator | country),
  data = df_unificado,
  family = Gamma(link = "log"),
  na.action = na.fail
)
summary(glmm_valido)

```

La salida del modelo generalizado mixto (GLMM) ajustado muestra un modelo con una estructura aleatoria por país que incluye la variación de la región (regional_indicator) dentro de cada país, lo que permite capturar diferencias contextuales regionales en el efecto de la felicidad. Este modelo ha sido ajustado utilizando una distribución Gamma con enlace logarítmico, lo que resulta apropiado dado que el Happiness Score es una variable continua y estrictamente positiva, con una ligera asimetría hacia la derecha.

Entre los efectos fijos, se observa que tanto `support` como `life_exp` tienen efectos positivos y altamente significativos sobre el nivel de felicidad (p < 0.001 en ambos casos). El coeficiente de `support` es de 0.2141, lo que implica que, manteniendo constantes el resto de variables, un incremento de una unidad en el nivel de apoyo social está asociado con un incremento multiplicativo de aproximadamente un 24% (exp(0.2141) = 1.24) en el valor esperado del Happiness Score. Este resultado refuerza la idea de que el respaldo social percibido tiene un fuerte vínculo con el bienestar subjetivo. Por su parte, el coeficiente de `life_exp` es de 0.00207, lo que significa que por cada año adicional de esperanza de vida, el Happiness Score se incrementa en torno a un 0.2%, lo cual refleja que las condiciones sanitarias y de longevidad están positivamente relacionadas con la percepción de felicidad.

En cuanto a los efectos aleatorios, se observa una importante varianza del intercepto entre países (0.01104), lo que indica que existen diferencias estructurales en el nivel base de felicidad que no son explicadas por las variables fijas incluidas. Además, se ha modelado la variabilidad del efecto de `regional_indicator` dentro de cada país, permitiendo que la influencia de la región sobre la felicidad varíe de forma diferenciada entre países. Este enfoque resulta útil para capturar las dinámicas regionales internas, aunque algunos de los componentes de esta estructura muestran varianzas cercanas a cero (como en el caso de Latin America and Caribbean) o correlaciones extremas entre efectos aleatorios (–1.00 o 1.00), lo que puede indicar problemas de colinealidad o redundancia estadística en determinadas regiones. Por ejemplo, las correlaciones perfectas observadas en South Asia o North America and ANZ podrían reflejar que, en esos contextos, los efectos de la región están perfectamente alineados con los del país, reduciendo la utilidad práctica de esa complejidad adicional en la estructura aleatoria.

Por último, el modelo presenta un estimador de dispersión ($\sigma^2$) de 0.00503, lo que indica una baja variabilidad residual después de ajustar el modelo, y sugiere un buen ajuste global del modelo Gamma con enlace logarítmico. Esta baja dispersión es coherente con los resultados obtenidos en la validación previa, donde se confirmó que el modelo cumple con los supuestos de uniformidad, homocedasticidad y ausencia de outliers problemáticos mediante los tests del paquete DHARMa.

En conjunto, este modelo GLMM permite capturar de forma eficaz la relación entre felicidad y factores sociales y sanitarios, teniendo en cuenta también la variabilidad específica de cada país y región. Aunque su estructura aleatoria compleja aporta flexibilidad, los signos de redundancia en ciertas regiones invitan a considerar modelos más parsimoniosos en futuras investigaciones. Aun así, el modelo ajustado se muestra estadísticamente válido y útil para la predicción y explicación del Happiness Score en contextos internacionales.

```{r message=FALSE, warning=FALSE, include=FALSE}
library(performance)
r2(glmm_valido)
```

Se ha calculado el R² marginal para el modelo GLMM, obteniendo un valor de **0.387**, lo que indica que los efectos fijos del modelo explican aproximadamente el 38.7% de la varianza del Happiness Score. Sin embargo, no ha sido posible calcular el R² condicional (que incluye la contribución de los efectos aleatorios) debido a que varios componentes de la estructura aleatoria presentan varianzas nulas o cercanas a cero, lo que genera problemas de identificabilidad y singularidad. Además, el modelo incluye pendientes aleatorias no reflejadas como efectos fijos, lo que impide una estimación fiable de la varianza total explicada. Este comportamiento es común en modelos GLMM con estructuras complejas o redundantes, y no compromete la validez del modelo en términos de significación y ajuste, pero limita la interpretación cuantitativa del componente aleatorio.

Al igual que hicimos antes, vamos a comprobar que este modelo es válido para poder hacer predicciones.

```{r}
#| label: fig-qqplot-residuos3
#| echo: false
#| warning: false
#| fig-cap: "QQ-plot de los residuos simulados del modelo mixto."
#| fig-width: 5
#| fig-height: 3.5

sim_res <- DHARMa::simulateResiduals(fittedModel = glmm_valido)
plotQQunif(sim_res)
```

```{r}
#| label: fig-dispersion-residuos3
#| echo: false
#| warning: false
#| fig-cap: "Dispersión de los residuos simulados frente a los valores predichos."
#| fig-width: 5
#| fig-height: 3.5

plotResiduals(sim_res)
```

```{r}
#| label: fig-test-residuos3
#| echo: false
#| warning: false
#| fig-cap: "Resultados del test formal de uniformidad aplicado a los residuos simulados."

testResiduals(sim_res)
```

### Normalidad de residuos 

El gráfico QQ-plot de residuos de la @fig-qqplot-residuos3 simulados muestra una alineación bastante razonable con la línea diagonal, sin grandes desviaciones sistemáticas. El test de Kolmogorov-Smirnov aplicado a los residuos simulados arroja un p-valor de 0.071, por encima del umbral convencional de 0.05. Esto indica que no se puede rechazar la hipótesis de uniformidad en la distribución de los residuos, cumpliendo así el supuesto análogo de normalidad en modelos GLMM.

### Homocedasticidad 

El test de dispersión de DHARMa compara la desviación estándar de los residuos ajustados frente a los simulados. Se obtiene un p-valor de 0.176, lo que indica que no hay evidencia significativa de heterocedasticidad. El gráfico de residuos frente a predicciones de la @fig-dispersion-residuos3 tampoco muestra patrones preocupantes de varianza creciente o decreciente. En este aspecto, el modelo cumple adecuadamente con el supuesto de homocedasticidad.

### Outliers y estructura de los residuos

El test binomial detecta 7 outliers en un total de 1421 observaciones, lo que representa un 0.49%, inferior al valor esperado (0.8%). El p-valor = 0.2325 indica que la proporción observada de valores extremos no difiere significativamente de la que cabría esperar por azar. Por tanto, no hay indicios de que los outliers estén afectando de manera relevante el ajuste del modelo.

Aunque los test formales indican adecuación, el gráfico de residuos frente a valores ajustados de la @fig-test-residuos3 muestra curvas de cuantiles que se desvían del comportamiento aleatorio esperado, lo que ha llevado a que el test combinado de cuantiles sea significativo. Esto sugiere la posible existencia de estructuras residuales no capturadas completamente por el modelo, probablemente relacionadas con interacciones o efectos omitidos. Sin embargo, la magnitud de estas desviaciones no parece invalidar el modelo ni afectar gravemente su interpretación.

### Conclusión del modelo GLMM

El modelo GLMM con distribución Gamma y enlace logarítmico ha permitido ajustar el Happiness Score como una variable continua estrictamente positiva. A pesar de ciertos problemas menores de singularidad y de que no se puede calcular el R² condicional, los diagnósticos de residuos indican un ajuste razonable. Los supuestos clave (uniformidad, homocedasticidad, ausencia de outliers extremos) se cumplen, y el modelo se considera estadísticamente válido.

La interpretación de los efectos fijos confirma que tanto el apoyo social como la esperanza de vida son predictores positivos y significativos de la felicidad, lo cual es consistente con la teoría y con los resultados del modelo LMM. El modelo GLMM ofrece una alternativa robusta al LMM cuando se desea modelar directamente la variable de interés sin asumir distribución normal de los residuos, y proporciona evidencia complementaria sobre los factores clave que explican el bienestar subjetivo en el mundo.

### Predicción del Happiness Score para 2025

Al igual que en el modelo lineal mixto, se utiliza el modelo GLMM validado para estimar el nivel de felicidad en cada país en el año 2025. Este modelo tiene en cuenta la estructura jerárquica de los datos (países agrupados con efectos aleatorios) y utiliza una distribución Gamma con enlace logarítmico, adecuada para modelar la variable de felicidad por ser estrictamente positiva y asimétrica.


```{r message=FALSE, warning=FALSE, include=FALSE}
library(dplyr)
library(knitr)

# Crear copia para predicciones LMM
datos_2025_lmm <- df_unificado
datos_2025_lmm$year <- 2025

# Predecir con el modelo LMM
datos_2025_lmm$happiness_pred_2025_lmm <- predict(modelo_seleccionado, newdata = datos_2025_lmm, allow.new.levels = TRUE)

# Crear ranking LMM
ranking_lmm_2025 <- datos_2025_lmm %>%
  group_by(country) %>%
  summarise(score_2025_lmm = mean(happiness_pred_2025_lmm, na.rm = TRUE)) %>%
  arrange(desc(score_2025_lmm)) %>%
  mutate(rank_lmm = row_number())

# Crear copia para predicciones GLMM
datos_2025_glmm <- df_unificado
datos_2025_glmm$year <- 2025

# Predecir con el modelo GLMM
datos_2025_glmm$happiness_pred_2025_glmm <- predict(glmm_valido, newdata = datos_2025_glmm, type = "response", allow.new.levels = TRUE)

# Crear ranking GLMM
ranking_glmm_2025 <- datos_2025_glmm %>%
  group_by(country) %>%
  summarise(score_2025_glmm = mean(happiness_pred_2025_glmm, na.rm = TRUE)) %>%
  arrange(desc(score_2025_glmm)) %>%
  mutate(rank_glmm = row_number())

ranking_2024 <- df_unificado %>%
  filter(year == 2024) %>%
  group_by(country) %>%
  summarise(score_2024 = mean(happiness_score, na.rm = TRUE)) %>%
  arrange(desc(score_2024)) %>%
  mutate(rank_2024 = row_number())

library(knitr)

# Unir todos los rankings por país
comparativa_total <- ranking_lmm_2025 %>%
  left_join(ranking_glmm_2025, by = "country") %>%
  left_join(ranking_2024, by = "country")

# Top 10, España, Bottom 10 (según LMM)
top_10 <- comparativa_total %>% slice_min(rank_lmm, n = 10) %>% mutate(section = "Top 10")
espana <- comparativa_total %>% filter(country == "Spain") %>% mutate(section = "España")
bottom_10 <- comparativa_total %>% slice_max(rank_lmm, n = 10) %>% mutate(section = "Últimos 10")

# Unir todo y mostrar
tabla_final <- bind_rows(top_10, espana, bottom_10) %>%
  arrange(factor(section, levels = c("Top 10", "España", "Últimos 10")), rank_lmm)

kable(tabla_final,
      caption = "Comparación del ranking de felicidad en 2025 (LMM y GLMM) y 2024",
      col.names = c("País", "Score 2025 (LMM)", "Ranking 2025 (LMM)",
                    "Score 2025 (GLMM)", "Ranking 2025 (GLMM)",
                    "Score 2024", "Ranking 2024", "Sección"))


```

```{r}
#| label: tbl-ranking-2025
#| echo: false
#| warning: false
#| message: false
#| tbl-cap: "Comparación del ranking de felicidad en 2025 (LMM y GLMM) y 2024"
#| tbl-columns: 8

kable(tabla_final,
      col.names = c("País", "Score 2025 (LMM)", "Ranking 2025 (LMM)",
                    "Score 2025 (GLMM)", "Ranking 2025 (GLMM)",
                    "Score 2024", "Ranking 2024", "Sección"))

```

Los resultados de la predicción de la [@tbl-ranking-2025] muestran que los países nórdicos continúan liderando el ranking de felicidad mundial: Finlandia encabeza la lista con una puntuación estimada de 7.63, seguida por Dinamarca (7.54), Islandia (7.48) y Noruega (7.42). Otros países del top 10 incluyen a Suiza, Países Bajos, Suecia, Nueva Zelanda, Israel y Australia, todos con puntuaciones por encima de 7.1. Esta concentración de países desarrollados con altos niveles de bienestar refleja el impacto consistente de factores como la cohesión social, el acceso a servicios de calidad y condiciones de vida estables.

En contraste, los países con las puntuaciones más bajas en felicidad predicha para 2025 son Afganistán (2.86), República Centroafricana (3.23), Burundi (3.30), Sudán del Sur (3.30), y Ruanda (3.42). Estas naciones se caracterizan por inestabilidad política, pobreza extrema, o conflictos prolongados, lo que probablemente reduce tanto el apoyo social como la esperanza de vida, las dos variables clave en el modelo.

En cuanto a España, se predice un Happiness Score de 6.39 para 2025, lo que la sitúa en la posición 31 del ranking mundial. Esta puntuación representa una ligera disminución respecto al valor observado en 2024 (6.42), pero supone una mejora en la clasificación, ya que sube del puesto 35 al 31. Esta subida refleja que, aunque la puntuación de España apenas varía, otros países han experimentado mayores caídas, permitiendo que España ascienda en el ranking relativo. Es decir, su mejora no es tanto por avance propio como por retroceso ajeno.

Estos resultados subrayan que incluso un modelo con solo dos predictores —apoyo social y esperanza de vida— puede captar de forma significativa las diferencias estructurales en felicidad entre países. Además, las predicciones realizadas con este GLMM son consistentes con las tendencias observadas en informes previos y refuerzan la idea de que la percepción de apoyo social y la longevidad son factores clave del bienestar subjetivo a nivel global.

Si hacemos una comparación entre los modelos LMM y GLMM a través de sus predicciones para el ranking de felicidad de 2025, tal como se presenta en la @tbl-ranking-2025, vemos resultados altamente coincidentes tanto en las posiciones superiores como en las posiciones inferiores del ranking. Ambos modelos coinciden en los tres primeros países (Finlandia, Dinamarca e Islandia), así como en los países menos felices (Tanzania, Malawi, Lesotho y Botswana), lo que indica una robustez general del enfoque mixto, independientemente de la familia de distribución asumida.

Sin embargo, para decidir qué modelo es mejor utilizaremos como criterio el coeficiente de determinación (R²), una medida habitual para evaluar la capacidad explicativa de los modelos. Como hemos visto antes, en el caso del modelo mixto lineal (LMM), el R² marginal —que refleja la varianza explicada exclusivamente por los efectos fijos— alcanza un valor de 0.702, mientras que el R² condicional, que incluye también los efectos aleatorios, asciende a 0.932. Por el contrario, el modelo mixto generalizado (GLMM) presenta únicamente un R² marginal de 0.387, sin poder estimarse el R² condicional debido a la ausencia de varianzas aleatorias accesibles en el modelo ajustado. Esta diferencia sustancial indica que el modelo LMM explica una proporción mucho mayor de la variabilidad observada en el Happiness Score, tanto desde una perspectiva fija como jerárquica. Por tanto, se concluye que el modelo LMM es notablemente superior al GLMM en términos de capacidad explicativa y ajuste general a los datos.